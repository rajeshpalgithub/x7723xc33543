<?php
class Sop_model extends CI_Model
{
 public function get_account_employee_id()
 {
	 $employee_id=0;
	 $client_id=$this->Basic_model->unique_id;
	 $sql="Select * from role_master INNER JOIN sub_role_details ON role_master.id=sub_role_details.role_master_id Where
	 role_master.object_id=$client_id And sub_role_details.is_default=1";
	 $rs=$this->db->query($sql);
	 if($rs->num_rows()>0)
	 {
		 $employee_arr=$rs->row_array();
		 $employee_id=$employee_arr['id'];
	 }
	 
	 return $employee_id;
 }
 
 
 public function InsertAccountType($post_data)
  {
	 $error='';
	 $errortext='';
	 $result='';
	 
	 $type_name=trim($post_data['name']);
	 $client_id=$this->Basic_model->unique_id;
	 
	 if($post_data['is_default']=='true')
	  {
		  $is_default=1;
	  }
	  else
	  {
		  $is_default=0;
	  }
	  
	 
	 $rs=$this->db->select('*')->where('client_id',$client_id)->where('type_name',$type_name)->get('account_type');
	 if($rs->num_rows()>0)
	 {
		 $error=true;
		 $errortext='Type name already exist';
	 }
	
	 if($is_default==1)
	 {
		 $rs=$this->db->select('*')->where('client_id',$client_id)->where('is_self_register',$is_default)->get('account_type');
		 if($rs->num_rows()>0)
		 {
			 $error=true;
			 $errortext='Self register value already set';
		 }
	 }
	 
	 if(!$error)
	 {
		 $insert_arr=array
		   (
			 'client_id'=>$client_id,
			 'type_name'=>$type_name,
			 'is_self_register'=>$is_default,
		   );
		   
		 $success=$this->db->insert('account_type',$insert_arr);
		 $msg='Successfully inserted';
		 $result['successMessage']=$msg; 
	 }
	 
	 return array('error' => $error, 'errortext' => $errortext, 'result' => $result);
  }
  
 
 public function UpdateAccountType($post_data)
  {
	 $error='';
	 $errortext='';
	 $result='';
	 
	 $type_name=trim($post_data['name']);
	 $type_id=trim($post_data['type_id']);
	 $client_id=$this->Basic_model->unique_id;
	 
	 if($post_data['is_default']=='true')
	  {
		  $is_default=1;
	  }
	  else
	  {
		  $is_default=0;
	  }
	 
	 $rs=$this->db->select('*')->where('id',$type_id)->get('account_type');
	
	 if(!$rs->num_rows()>0)
	 {
		 $error=true;
		 $errortext='Invalid type id';
	 }	 
	 
	 if(!$error)
	 {
		 $rs=$this->db->select('*')->where('id!=',$type_id)->where('client_id',$client_id)->where('type_name',$type_name)->get('account_type');
		 if($rs->num_rows()>0)
		 {
			 $error=true;
			 $errortext='Type name already exist';
		 }
		
		 if($is_default==1)
		 {
			 $rs=$this->db->select('*')->where('id!=',$type_id)->where('client_id',$client_id)->where('is_self_register',$is_default)->get('account_type');
			 if($rs->num_rows()>0)
			 {
				 $error=true;
				 $errortext='Self register value already set';
			 }
		 }
	 }
	 if(!$error)
	 {
		 $insert_arr=array
		   (
			 'type_name'=>$type_name,
			 'is_self_register'=>$is_default,
		   );
		   
		 $success=$this->db->where('id',$type_id)->update('account_type',$insert_arr);
		 $msg='Successfully updated';
		 $result['successMessage']=$msg; 
	 }
	 
	 return array('error' => $error, 'errortext' => $errortext, 'result' => $result);
  }
  
 
 public function get_account_type()
 {
	 $client_id=$this->Basic_model->unique_id;
	 $token_id=$this->Basic_model->token_id;
	 $account_type_array=array();
	 
	 if($token_id=="" || $this->Basic_model->role==4)
	 {
	     $rs=$this->db->select('*')->where('is_self_register',1)->where('client_id',$client_id)->get('account_type');
		 if($rs->num_rows()>0)
		 {
			$account_type_array=$rs->row_array() ;  
		 }
	 }
	 else
	 {
		 $rs=$this->db->select('*')->where('client_id',$client_id)->get('account_type');
		 if($rs->num_rows()>0)
		 {
			$account_type_array=$rs->result_array() ;  
		 }
	 }
	 
	 
	 return $account_type_array;
 }

function generatePIN($digits = 4){
    $i = 0; //counter
    $pin = ""; //our default pin is blank.
    while($i < $digits){
        //generate a random number between 0 and 9.
        $pin .= mt_rand(0, 9);
        $i++;
    }
    return $pin;
}

	
 public function InsertCustomerData($post_data)
 {
	 $error=false;
	 $errortext='';
	 $result='';

	 $email=$post_data['email'];
	 $phone=$post_data['phone'];
	 $client_id=$this->Basic_model->unique_id;
	 $type_id='';
	 $auth_code='';
	 $token_id=$this->Basic_model->token_id;
	 /************ if it's end customer it self *********/
	 if($token_id=="" || $this->Basic_model->role==4)
	 {
		 $employee_id=$this->get_account_employee_id();
		 if($employee_id!=0)
		 {
			 $type_arr=$this->get_account_type();
			 if(!empty($type_arr))
			 {
			   $type_id=$type_arr['id'];
			   $auth_code=$this->generatePIN();
			 }
			 else
			 {
				 $error=true;
		         $errortext='Default account type is not set';
			 }
		 }
		 else
		 {
			 $error=true;
		     $errortext='Default employee is not set';
		 }
	 }
	 else
	 {
	     $employee_id=$post_data['role_id'];
		 $type_id=$post_data['type_id'];
	 }
	/* ****** Checking IF the email or phone no already exist in login or accou table based on client id *****/
	if(!$error)
	{
	     $rs=$this->db->select('*')->where('email',$email)->where('unique_id',$client_id)->get('login');
		 if($rs->num_rows()>0)
		 {
			   $error=true;
			   $errortext .='Email id already exist'.'<br>';
		 }
		 
		 $rs=$this->db->select('*')->where('phone_no',$phone)->where('unique_id',$client_id)->get('login');
		 if($rs->num_rows()>0)
		 {
			   $error=true;
			   $errortext .='Phone no already exist'.'<br>';
		 }
		 
		 $rs=$this->db->select('*')->where('id',$type_id)->where('client_id',$client_id)->get('account_type');
		 if(!$rs->num_rows()>0)
		 {
			  $error=true;
			  $errortext.='Account type id not found'.'<br>';  
			
		 }
		 else
		 {
			if($token_id!="" && $this->Basic_model->role!=4)  
			{
				$account_arr=$rs->row_array();
				if($account_arr['is_self_register']==1)
				{
					$error=true;
					$errortext.='Invalid account type'.'<br>';
				}
			}
		 }
		 
	}
	if(!$error)
	 {
		 
		  if($post_data['is_active']=='true')
		  {
			  $is_active=1;
		  }
		  else
		  {
			  $is_active=0;
		  }
		 
		 $insert_arr=array
		   (
			 'client_id'=>$this->Basic_model->unique_id,
			 'name'=>$post_data['name'],
			 'type_id'=>$type_id,
			 'role_id'=>$employee_id,
			 'description'=>$post_data['description'],
			 'auth_code'=> $auth_code,
			 'is_active'=> $is_active,
		   );
		   
		   
		   //print_r($insert_arr);
		  //die();
		  
		   $success=$this->db->insert('account',$insert_arr);
		   if($success)
		   {
			   $sub_unique_id=$this->db->insert_id();
			   $login_data=array(
				   'unique_id'=>$client_id,
				   'sub_unique_id'=>$sub_unique_id,
				   'password'=>md5($post_data['password']),
				   'email'=>$post_data['email'],
				   'phone_no'=>$post_data['phone'],
				   'role'=>4,
			      );
			   $success=$this->db->insert('login',$login_data);
			   if($success)
			   {
				   $customer_name=$post_data['name'];
				   $email=$post_data['email'];
				   $mobile_no=$post_data['phone'];
				   
				   $subject="Customer Authentication";
				   $message="<b>Customer name</b> :".$customer_name.'<br/>'.
				   "<b>Authentication Code</b>: ".$auth_code.'<br/>';
				   
				   $final_message="Customer name: ".$customer_name.","."Your account activation code:".$auth_code;
				   
				   $send_email_array=array(
				     'subject'=>$subject,
				     'message'=>$message,
				     'email'=>$email
				  );
					// Send SMS
				    $send_email_array=$this->Common_model->send_sms($mobile_no,$final_message);
					// Send Email
					//$send_email_array=$this->Common_model->send_email($send_email_array);
					if(!$send_email_array['error'])
					{
						$result['successMessage']="Data successfully inserted, Auth code has been send to your mobile no";
			 			$result['account_id']=$sub_unique_id;
					}
					else
					{
						$error = true;
						$errortext .=$send_email_array['errortext'];
					}
			   }
			   
			 
		   }
		   else
		   {
			 $error=true;
			 $errortext='insert error';
		   }
		  
	 }
	 
	 return array('error' => $error, 'errortext' => $errortext, 'result' => $result);
}


 public function Activate_user($post_data)
 {
	 $error='';
	 $errortext='';
	 $result='';
	 
	 $email_phone=$post_data['email_phone'];
	 $auth_code=$post_data['auth_code'];
	 $client_id=$this->Basic_model->unique_id;
	 
	  $sql="SELECT * FROM account INNER JOIN login ON account.id=login.sub_unique_id WHERE (login.phone_no='$email_phone' 
	  OR login.email='$email_phone') AND login.unique_id=$client_id AND login.role=4";
	  $rs=$this->db->query($sql);
	  if($rs->num_rows()>0)
	  {
		  $account_array=$rs->row_array();
		  if($account_array['is_active']==1)
		  {
			 $error=true;
		     $errortext='Account is already active';
		  }
		  
		  if(!$error)
		  {
			  if($account_array['auth_code']!=$auth_code)
			  {
				 $error=true;
				 $errortext='Invalid authentication code';
			  }
		  }
		  
		  if(!$error)
		  {
			  $id=$account_array['sub_unique_id'];
			  
			  $account_array=array(
			   'auth_code'=>'',
			   'is_active'=>1,
			  );
			  
			 $success=$this->db->where('id',$id)->update('account',$account_array);
			 if($success)
			 {
				 $result['successMessage']='Account successfully activated';
			 }
		  }
		  
	  }
	  else
	  {
		  $error=true;
		  $errortext='Account not found';
	  }
	 
	 return array('error' => $error, 'errortext' => $errortext, 'result' => $result);
 }
	
 public function UpdateCustomerData($post_data)
 {
	 $error='';
	 $errortext='';
	 $result='';
     
	 $cust_id=$post_data['account_id'];
	 $email=$post_data['email'];
	 $phone=$post_data['phone'];
	 
	 $client_id=$this->Basic_model->unique_id;
	 $type_id='';
	 
	 $token_id=$this->Basic_model->token_id;
	 if($token_id=="" || $this->Basic_model->role==4)
	 {
		 $type_arr=$this->get_account_type();
		 $type_id=$type_arr['id'];
	 }
	 else
	 {
		 $type_id=$post_data['type_id'];
	 }
	
	 $rs=$this->db->select('*')->where('sub_unique_id!=',$cust_id)->where('email',$email)->where('unique_id',$client_id)->get('login');
	 
	 if($rs->num_rows()>0)
	 {
	   $error=true;
	   $errortext='Email id already exist';
	 }
	 
	 $rs=$this->db->select('*')->where('sub_unique_id!=',$cust_id)->where('phone_no',$phone)->where('unique_id',$client_id)->get('login');
	 if($rs->num_rows()>0)
	 {
		   $error=true;
		   $errortext='Phone no already exist';
	 }
	 
	 $rs=$this->db->select('*')->where('id',$type_id)->where('client_id',$client_id)->get('account_type');
	 if(!$rs->num_rows()>0)
	 {
	      $error=true;
	      $errortext='Account type id not found';  
	 }
	 else
	 {
		if($token_id!="" && $this->Basic_model->role!=4)  
		{
			$account_arr=$rs->row_array();
			if($account_arr['is_self_register']==1)
			{
				$error=true;
	            $errortext='Invalid account type';
			}
		}
	 }
	 
	 if(!$error)
	 {
		 
		 if($post_data['is_active']=='true')
		  {
			  $is_active=1;
		  }
		  else
		  {
			  $is_active=0;
		  }
		 
		 
		 $insert_arr=array
		   (
			 'name'=>$post_data['name'],
			 'description'=>$post_data['description'],
			 'is_active'=>$is_active,
		   );
		   
		  //echo '<pre>',print_r($insert_arr);
		  //die();
		   $success=$this->db->where('id',$cust_id)->update('account',$insert_arr);
		   if($success)
		    {
			
			  $login_data=array(
				   'email'=>$post_data['email'],
				   'phone_no'=>$post_data['phone'],
			      );
				
			  if($post_data['password']!="")
			  {
				  $login_data['password']=md5($post_data['password']);
			  }
			  
			   $success=$this->db->where('unique_id',$client_id)->where('sub_unique_id',$cust_id)->where('role',4)->update('login',$login_data);	
			   $result['successMessage']="Data successfully updated";
		    }
		    else
		    {
			 $error=true;
			 $errortext='insert error';
		    }
		   
	 }
	 
	 return array('error' => $error, 'errortext' => $errortext, 'result' => $result);
	}	
	
 
 public function GetContractDetails($cust_id)
 {
	 $contract_arr=array();
	 $rs=$this->db->select('*')->where('account_id',$cust_id)->get('account_contract');
	 if($rs->num_rows()>0)
	 {
		  $contract_arr=$rs->result_array();
	 }
	 
	 return $contract_arr;
 }
 
 public function get_login_data($field_name,$id)
 {
	 
	 $field_data='';
	 $rs=$this->db->select('*')->where('role',4)->where('sub_unique_id',$id)->where('unique_id',$this->Basic_model->unique_id)->get('login');
	 if($rs->num_rows()>0)
	 {
		  $login_array=$rs->row_array();
		  $field_data=$login_array[$field_name];
	 }
	 return $field_data;
 }
 
 
 public function GetCustomerData()
 {
	 $customer_list=array();
	 $rs=$this->db->select('*')->where('client_id',$this->Basic_model->unique_id)->get('account');
	 if($rs->num_rows()>0)
	 {
		  $customer_arr=$rs->result_array();
		  foreach($customer_arr as $item)
		  {
			  $id=$item['id'];
			  $email=$this->get_login_data('email',$id);
			  $phone_no=$this->get_login_data('phone_no',$id);
			  $customer_list[]=array(
			     'id'=>$item['id'],
			     'name'=>$item['name'],
				 'email'=>$email,
			     'phone_no'=>$phone_no,
				 'description'=>$item['description'],
				 'auth_code'=>$item['auth_code'],
				 'is_active'=>$item['is_active']
			  );
		  }
	 }
	 
	 return $customer_list;
 }

 public function GetCustomerDetailsOnId($cust_id)
 {
	  $customer_data=array();
	  $ccount_data=array();
	  $client_id=$this->Basic_model->unique_id;
	  $rs=$this->db->select('*')->where('id',$cust_id)->get('account');
	  if($rs->num_rows()>0)
	   {
		      $customer_data=$rs->row_array();
			  
		      $email='';
			  $phone='';
			  $rs=$this->db->select('*')->where('sub_unique_id',$cust_id)->where('role',4)->where('unique_id',$client_id)->get('login');
			  if($rs->num_rows()>0)
			  {
				  $login_data=$rs->row_array();
				  $email=$login_data['email'];
			      $phone=$login_data['phone_no'];
			  }
			  
			  $ccount_data=array(
			    'name'=>$customer_data['name'],
			    'email'=>$email,
			    'phone'=>$phone,
				'description'=>$customer_data['description'],
				'is_active'=>$customer_data['is_active'],
			  );
		  
	   }
	   
	   return $ccount_data;  
  }


 public function GetProductAttribute($cat_id)
 {
	 $attribute_arr=array();
	 $rs=$this->db->select('*')->where('cat_id',$cat_id)->order_by("attribute_name", "asc")->get('attribute');
	 if($rs->num_rows()>0)
	 {
		  $attribute_arr=$rs->result_array();
	 }
	 
	 return $attribute_arr;
 }
 
 
 function buildTree(array $elements, $parentId = 0) {
    $branch = array();

    foreach ($elements as $element) {
        if ($element['Parent_id'] == $parentId) {
            $children = $this->buildTree($elements, $element['Id']);
            if ($children) {
                $element['children'] = $children;
            }
            $branch[] = $element;
        }
    }

    return $branch;
 }
 
 public function GetProductCategoryTree()
 {
	 $CategoryList=array();
	 $rs=$this->db->select('*')->where('client_id', $this->Basic_model->unique_id)->where('is_active', 1)->get('category');
	 if($rs->num_rows()>0)
	 {
		 $child_arr=array();
		 $category_arr=$rs->result_array();
		 foreach($category_arr as $item)
		 {
			 $child_arr[]=array(
				"Id" => $item['cat_id'],
				"Parent_id" => $item['parent_id'],
				"Name" => $item['category_name'],
				);
		 }
		 
		 $CategoryList =$this->buildTree($child_arr); 
	 }
	 
	 return $CategoryList;
 }
 
 public function UpdateCategoryData($post_data)
 {
	 $error='';
	 $errortext='';
	 $result=''; 
	 
	 $cat_id=$post_data['cat_id'];
	 $category_name=$post_data['category_name'];
	 $parent_id=$post_data['parent_id'];
	 $client_id=$this->Basic_model->unique_id;
	 
	 $rs=$this->db->select('*')->where('cat_id!=',$cat_id)->where('client_id',$client_id)->where('category_name',$category_name)->get('category');
	 if($rs->num_rows()>0)
	 {
		   $error=true;
		   $errortext='Category already exist';
	 }
	 
	 $rs=$this->db->select('*')->where('client_id',$client_id)->where('cat_id',$parent_id)->get('category');
	 if(!$rs->num_rows()>0)
	 {
		   $error=true;
		   $errortext='Parent category is not exist';
	 }
	 
	 if(!$error)
	 {
		 
		 if($post_data['is_active']=='true')
			 {
				 $is_active=1;
			 }
			 else
			 {
				 $is_active=0;
			 }
		 
		 
		 $insert_arr=array
		   (
			 'client_id'=>$this->Basic_model->unique_id,
			 'parent_id'=>$parent_id,
			 'category_name'=>$category_name,
			 'is_active'=>$is_active,
		   );
		   
		   //echo '<pre>',print_r($insert_arr);
		
		 $product_id="";	
		 $success=$this->db->where('cat_id',$cat_id)->update('category',$insert_arr);
		 if($success)
		 {
			 $result['successMessage']="Data successfully updated";
		 }
		 else
		 {
			 $error=true;
			 $errortext='insert error';
		 }
		 
	 }
	 
	 return array('error' => $error, 'errortext' => $errortext, 'result' => $result); 
	 
 }
 
 public function InsertCategoryData($post_data)
 {
	 $error='';
	 $errortext='';
	 $result=''; 
	 
	 $category_name=$post_data['category_name'];
	 $parent_id=$post_data['parent_id'];
	 $client_id=$this->Basic_model->unique_id;
	 
	 
	 $rs=$this->db->select('*')->where('client_id',$client_id)->where('cat_id',$parent_id)->get('category');
	 if(!$rs->num_rows()>0)
	 {
		   $error=true;
		   $errortext='Parent category is not exist';
	 }
	 
	 $rs=$this->db->select('*')->where('client_id',$client_id)->where('category_name',$category_name)->get('category');
	 if($rs->num_rows()>0)
	 {
		   $error=true;
		   $errortext='Category already exist';
	 }
	 
	 if(!$error)
	 {
		 
		  if($post_data['is_active']=='true')
			 {
				 $is_active=1;
			 }
			 else
			 {
				 $is_active=0;
			 }
		 
		 
		 
		 $insert_arr=array
		   (
			 'client_id'=>$this->Basic_model->unique_id,
			 'parent_id'=>$parent_id,
			 'category_name'=>$category_name,
			 'is_active'=> $is_active,
		   );
		   
		   //echo '<pre>',print_r($insert_arr);
		
		 $product_id="";	
		 $success=$this->db->insert('category',$insert_arr);
		 if($success)
		 {
			 $result['successMessage']="Data successfully inserted";
		 }
		 else
		 {
			 $error=true;
			 $errortext='insert error';
		 }
		 
	 }
	 
	 return array('error' => $error, 'errortext' => $errortext, 'result' => $result); 
	 
 }
 
 
 public function GetProductCategoryById($cat_id)
 {
	 $cat_arr=array();
	 $client_id=$this->Basic_model->unique_id;
	 $rs=$this->db->select('*')->where('client_id',$client_id)->where('is_active',1)->where('cat_id',$cat_id)->get('category');
	 if($rs->num_rows()>0)
	 {
		  $cat_arr=$rs->result_array();
	 }
	 
	 return $cat_arr;
 }
 
 public function GetProductCategory()
 {
	 $cat_arr=array();
	 $client_id=$this->Basic_model->unique_id;
	 $rs=$this->db->select('*')->where('client_id',$client_id)->where('is_active',1)->order_by("category_name", "asc")->get('category');
	 if($rs->num_rows()>0)
	 {
		  $cat_arr=$rs->result_array();
	 }
	 
	 return $cat_arr;
 }
 
 public function GetProductAttributeValue($att_id)
 {
	 $attribute_value=array();
	 $rs=$this->db->select('*')->where('attribute_id',$att_id)->order_by("attribute_value_name", "asc")->get('attribute_value');
	 if($rs->num_rows()>0)
	 {
		  $attribute_value=$rs->result_array();
	 }
	 
	 return $attribute_value;
 }
 
 
 public function GetProductType()
  {
	  $product_type='';
	  $client_id=$this->Basic_model->unique_id; 
	  $product_type=$this->Common_model->get_single_field_value('school','product_type','id',$client_id);
	  return $product_type;
	  
  }
 
 
  public function GetProductPriceType()
  {
	 $price_category_array=array(); 
	 $product_type=$this->GetProductType(); 
	 if($product_type==1 || $product_type==3)
	 {
		$client_id=$this->Basic_model->unique_id; 
		$rs=$this->db->select('*')->where('client_id',$client_id)->get('rent_price_slab'); 
		if($rs->num_rows()>0)
		{
			$price_category_array=$rs->result_array();
		}
	 }
	 
	 return $price_category_array;
	 
  }
 
 
  public function UpdateProductData($product_id,$post_data)
  {
	 $error='';
	 $errortext='';
	 $result=''; 
	 
	 //echo '<pre>',print_r($post_data);
	 //die();
	 
	 
	 $product_nubmer=$post_data['product_nubmer'];
	 $sku_nubmer=$post_data['sku_nubmer'];
	 $product_type=$post_data['product_type'];
	 $price_data=$post_data['price_data'];
	 
	 $client_id=$this->Basic_model->unique_id;
	 
	 $rs=$this->db->select('*')->where('id!=',$product_id)->where('client_id',$client_id)->where('product_number',$product_nubmer)->get('products');
	 if($rs->num_rows()>0)
	 {
		   $error=true;
		   $errortext='Product no already exist';
	 }
	 
	 $rs=$this->db->select('*')->where('id!=',$product_id)->where('client_id',$client_id)->where('sku',$sku_nubmer)->get('products');
	 if($rs->num_rows()>0)
	 {
		   $error=true;
		   $errortext='SKU  already exist';
	 }
	 
	 $rs=$this->db->select('*')->where('client_id',$client_id)->where('cat_id',$cat_id)->get('category');
	 if(!$rs->num_rows()>0)
	 {
		   $error=true;
		   $errortext='Category not found';
	 }
	 
	 if(!$error)
	 {
		 
		 
		 if($post_data['is_active']=='true')
		 {
			 $is_active=1;
		 }
		 else
		 {
			 $is_active=0;
		 }
		 
		 $update_arr=array
		   (
			 'cat_id'=>$post_data['category_name'],
			 'sku'=>$post_data['sku_nubmer'],
			 'product_name'=>$post_data['product_name'],
			 'product_number'=>$post_data['product_nubmer'],
			 'product_description'=>$post_data['description'],
			 'is_active'=>$is_active,
		   );
		   
		 //echo '<pre>',print_r($update_arr);	
		 $success=$this->db->where('id',$product_id)->update('products',$update_arr);
		 $success=$this->db->where('product_id',$product_id)->delete('product_price');
		 
		 if($product_type==1)
		 {
			if(!empty($price_data))
			{
				foreach($price_data as $key=>$value)
				 {
					 $insert_arr2=array(
					  'product_id'=>$product_id,
					  'slab_id'=>$key,
					  'amount'=>$value,
					 );
					 
					 $success=$this->db->insert('product_price',$insert_arr2);
				 }
			}
			 
		 }
		 
		 if($product_type==2)
		 {
			  $insert_arr2=array(
			  'product_id'=>$product_id,
			  'slab_id'=>0,
			  'amount'=>$price_data,
			 );
					 
			$success=$this->db->insert('product_price',$insert_arr2);
			 
		 }

		 /*$success=$this->db->where('product_id',$product_id)->delete('product_attribute');	
		 if(isset($post_data['attribute_value_name']))
		 {
		    for($i=0;$i<=count($post_data['attribute_value_name'])-1;$i++)
			{
				
				if($post_data['attribute_value_name'][$i]!="")
				{
				   $insert_arr2=array
				   (
					 'product_id'=>$product_id,
					 'attribute_id'=>$post_data['attribute_id'][$i],
					 'attribute_value_id'=>$post_data['attribute_value_name'][$i],
				   );
				   
				    //echo '<pre>',print_r($insert_arr2);
					
					  $success=$this->db->insert('product_attribute',$insert_arr2);
					   if($success)
					   {
						 $result['successMessage']="Data successfully inserted";
					   }
					   else
					   {
						 $error=true;
						 $errortext='insert error';
						}
				}

			}
		 }*/
		 //$success=1;	
		 if($success)
		   {
			 $result['successMessage']="Data successfully updated";
		   }
		   else
		   {
			 $error=true;
			 $errortext='update error';
		   }	
			
	 }
	 
	 return array('error' => $error, 'errortext' => $errortext, 'result' => $result);
	 
  }
 
 
 public function InsertProductData($post_data)
 {
	 $error='';
	 $errortext='';
	 $result=''; 
	 
	
	 $product_nubmer=$post_data['product_nubmer'];
	 $sku_nubmer=$post_data['sku_nubmer'];
	 $cat_id=$post_data['category_id'];
	 $product_type=$post_data['product_type'];
	 $price_data=$post_data['price_data'];
	 
	 $client_id=$this->Basic_model->unique_id;
	 
	 $rs=$this->db->select('*')->where('client_id',$client_id)->where('product_number',$product_nubmer)->get('products');
	 if($rs->num_rows()>0)
	 {
		   $error=true;
		   $errortext='Product no already exist';
	 }
	 
	 $rs=$this->db->select('*')->where('client_id',$client_id)->where('sku',$sku_nubmer)->get('products');
	 if($rs->num_rows()>0)
	 {
		   $error=true;
		   $errortext='SKU already exist';
	 }
	 
	 $rs=$this->db->select('*')->where('client_id',$client_id)->where('cat_id',$cat_id)->get('category');
	 if(!$rs->num_rows()>0)
	 {
		   $error=true;
		   $errortext='Category not found';
	 }
	 
	 if(!$error)
	 {
		  if($post_data['is_active']=='true')
			 {
				 $is_active=1;
			 }
			 else
			 {
				 $is_active=0;
			 }
		 
		  $insert_arr=array
		   (
			 'client_id'=>$this->Basic_model->unique_id,
			 'cat_id'=>$post_data['category_id'],
			 'type'=>$product_type,
			 'sku'=>$post_data['sku_nubmer'],
			 'product_name'=>$post_data['product_name'],
			 'product_number'=>$post_data['product_nubmer'],
			 'product_description'=>$post_data['description'],
			 'is_active'=> $is_active,
		   );
		   
		   //echo '<pre>',print_r($insert_arr);
		
		 $product_id="";	
		 $success=$this->db->insert('products',$insert_arr);
		 $product_id=$this->db->insert_id();
		 
		 if($product_type==1)
		 {
			if(!empty($price_data))
			{
				foreach($price_data as $key=>$value)
				 {
					 $insert_arr2=array(
					  'product_id'=>$product_id,
					  'slab_id'=>$key,
					  'amount'=>$value,
					 );
					 
					 $success=$this->db->insert('product_price',$insert_arr2);
				 }
			}
			 
		 }
		 
		 if($product_type==2)
		 {
			  $insert_arr2=array(
			  'product_id'=>$product_id,
			  'slab_id'=>0,
			  'amount'=>$price_data,
			 );
					 
			$success=$this->db->insert('product_price',$insert_arr2);
			 
		 }
		 
		/* if(isset($post_data['attribute_value_name']))
		 {
		    for($i=0;$i<=count($post_data['attribute_value_name'])-1;$i++)
			{
				
				if($post_data['attribute_value_name'][$i]!="")
				{
				   $insert_arr2=array
				   (
					 'product_id'=>$product_id,
					 'attribute_id'=>$post_data['attribute_id'][$i],
					 'attribute_value_id'=>$post_data['attribute_value_name'][$i],
				   );
				   
				    //echo '<pre>',print_r($insert_arr2);
					
					  $success=$this->db->insert('product_attribute',$insert_arr2);
					   if($success)
					   {
						 $result['successMessage']="Data successfully inserted";
					   }
					   else
					   {
						 $error=true;
						 $errortext='insert error';
						}
				}

			}
		 }*/
		 
		 //die();
		
	 }
	
	
	return array('error' => $error, 'errortext' => $errortext, 'result' => $result); 
 }
 
 
 public function GetProductRentSlab()
  {
	  $slab_data=array();
	  $rs=$this->db->select('*')->where('client_id',$this->Basic_model->unique_id)->get('rent_price_slab');
	  if($rs->num_rows()>0)
	  {
		  $slab_data=$rs->result_array();
	  }
	  
	  return $slab_data; 
  }
  
  public function GetProductRentSlabOnId($slab_id)
  {
	  $slab_data=array();
	  $rs=$this->db->select('*')->where('id',$slab_id)->where('client_id',$this->Basic_model->unique_id)->get('rent_price_slab');
	  if($rs->num_rows()>0)
	  {
		  $slab_data=$rs->row_array();
	  }
	  
	  return $slab_data; 
  }
  
  public function InsertProductRentSlab($post_data)
  {
	 $error='';
	 $errortext='';
	 $result='';
	 
	 $slab_name=trim($post_data['slab_name']);
	 $min_day=trim($post_data['min_day']);
	 $max_day=trim($post_data['max_day']);
	 $is_default=$post_data['is_default'];
	 $is_active=$post_data['is_active'];
	 
	 $rs=$this->db->select('*')->where('client_id',$this->Basic_model->unique_id)->where('slab_name',$slab_name)->get('rent_price_slab');
	 if($rs->num_rows()>0)
	 {
		 $error=true;
		 $errortext='Slab name already exist';
	 }
	 $client_id=$this->Basic_model->unique_id;
	 $sql="Select * from rent_price_slab Where client_id=$client_id AND (max_day=$max_day AND min_day=$min_day)";
	 $rs=$this->db->query($sql);
	 if($rs->num_rows()>0)
	 {
		 $error=true;
		 $errortext='Slab name already exist';
	 }
	 
	 if($is_default=='true')
	 {
		 $is_default=1;
		 $rs=$this->db->select('*')->where('client_id',$this->Basic_model->unique_id)->where('is_default',$is_default)->get('rent_price_slab');
		 if($rs->num_rows()>0)
		 {
			 $error=true;
			 $errortext='Default value already set';
		 }
	 }
	 else
	 {
		 $is_default=0;
	 }
	 
	 if(!$error)
	 {
		 if($is_active=='true')
		 {
			 $is_active=1;
		 }
		 else
		 {
			 $is_active=0;
		 }
		 
		 $insert_arr=array
		   (
			 'client_id'=>$this->Basic_model->unique_id,
			 'slab_name'=>$slab_name,
			 'min_day'=>$min_day,
			 'max_day'=>$max_day,
			 'is_default'=>$is_default,
			 'is_active'=>$is_active,
		   );
		   
		 $success=$this->db->insert('rent_price_slab',$insert_arr);
		 $msg='Successfully inserted';
		 $result['successMessage']=$msg; 
	 }
	 
	 return array('error' => $error, 'errortext' => $errortext, 'result' => $result);
  }
  
  
  
 public function GetProductOnCatIdAndType($post_data)
 {
	  $product_type=$post_data['product_type'];
	  $product_data=array();
	  $rs=$this->db->select('*')->where('client_id',$this->Basic_model->unique_id)->where('type',$product_type)->get('products');
	  if($rs->num_rows()>0)
	   {
		  $product_data=$rs->result_array();
	   }
	   
	   return $product_data;  
  }
 
 public function UpdateProductRentSlab($post_data)
  {
	 $error='';
	 $errortext='';
	 $result='';
	 
	 $slab_id=trim($post_data['slab_id']);
	 $slab_name=trim($post_data['slab_name']);
	 $min_day=trim($post_data['min_day']);
	 $max_day=trim($post_data['max_day']);
	 $is_default=$post_data['is_default'];
	 $is_active=$post_data['is_active'];
	 
	 $client_id=$this->Basic_model->unique_id;
	 $rs=$this->db->select('*')->where('id!=',$slab_id)->where('client_id',$this->Basic_model->unique_id)->where('slab_name',$slab_name)->get('rent_price_slab');
	 if($rs->num_rows()>0)
	 {
		 $error=true;
		 $errortext='Slab name already exist';
	 }
	 
	 $rs=$this->db->select('*')->where('id',$slab_id)->where('client_id',$this->Basic_model->unique_id)->where('slab_name',$slab_name)->get('rent_price_slab');
	 if(!$rs->num_rows()>0)
	 {
		 $error=true;
		 $errortext='Slab id is not exist';
	 }
	 
	 $sql="Select * from rent_price_slab Where id!=$slab_id AND client_id=$client_id AND (max_day=$max_day AND min_day=$min_day)";
	 $rs=$this->db->query($sql);
	 //$rs=$this->db->select('*')->where('id!=',$slab_id)->where('client_id',$this->Basic_model->unique_id)->where('duration',$slab_duration)->get('rent_price_slab');
	 if($rs->num_rows()>0)
	 {
		 $error=true;
		 $errortext='Slab name already exist';
	 }
	 
	 
	 if($is_default=='true')
	 {
		 $is_default=$post_data['is_default'];
		 $rs=$this->db->select('*')->where('id!=',$slab_id)->where('client_id',$this->Basic_model->unique_id)->where('is_default',$is_default)->get('rent_price_slab');
		 if($rs->num_rows()>0)
		 {
			 $error=true;
			 $errortext='Default value already set';
		 }
	 }
	 else
	 {
		 $is_default=0;
	 }
	 

	 if(!$error)
	 {
		 
		 if($is_active=='true')
		 {
			 $is_active=1;
		 }
		 else
		 {
			 $is_active=0;
		 }
		 
		 $insert_arr=array
		   (
			 'slab_name'=>$slab_name,
			 'min_day'=>$min_day,
			 'max_day'=>$max_day,
			 'is_default'=>$is_default,
			 'is_active'=>$is_active,
		   );
		   
		 $success=$this->db->where('id',$slab_id)->update('rent_price_slab',$insert_arr);
		 $msg='Successfully updated';
		 $result['successMessage']=$msg; 
	 }
	 
	 return array('error' => $error, 'errortext' => $errortext, 'result' => $result);
  }
 
 public function DeleteProductRentSlab($post_data)
  {
	 $error='';
	 $errortext='';
	 $result='';
	 
	 $slab_id=trim($post_data['slab_id']);
	 
	 $rs=$this->db->select('*')->where('id',$slab_id)->where('client_id',$this->Basic_model->unique_id)->get('rent_price_slab');
	 if(!$rs->num_rows()>0)
	 {
		 $error=true;
		 $errortext='Slab id is not exist';
	 }
	 
	 
	 if(!$error)
	 {
		 
		 $success=$this->db->where('id',$slab_id)->where('client_id',$this->Basic_model->unique_id)->delete('rent_price_slab');
		 if($success)
		 {
			 $success=$this->db->where('slab_id',$slab_id)->delete('product_price');
		 }
		 
		 if($success)
		 {
			$msg='Successfully deleted';
		 }
		 $result['successMessage']=$msg; 
	 }
	 
	 return array('error' => $error, 'errortext' => $errortext, 'result' => $result);
  }
 
 
 
 public function GetCategoryCommon()
 {
	 $client_id=$this->Basic_model->unique_id;
	 $search_condition='';
	 
	 if($this->input->get('search_cat'))
	 {
		 $search_cat=$this->input->get('search_cat');
		 $search_text=$this->input->get('search_text');
		 $search_condition=" And $search_cat LIKE '%$search_text%'"; 
	 }
	
	 $sql="Select * from category Where client_id=$client_id $search_condition";
	 
	 return $sql;
 }
 
 public function getTotalCategoryCount()
 {
	 $category_count=0;
	 $sql=$this->GetCategoryCommon();
	 $rs=$this->db->query($sql);
	 if($rs->num_rows()>0)
	 {
		 $category_count=$rs->num_rows;
	 }
	 
	 return $category_count;
 }
 
 public function GetCategoryData($offset,$perpage)
 {
	 $product_arr=array();
	 $sql=$this->GetCategoryCommon();
	 $limit_query=" LIMIT $offset, $perpage";
	 $sql2=$sql.$limit_query;
	 $rs=$this->db->query($sql2);
	 //$rs=$this->db->select('*')->where('client_id',$this->Basic_model->unique_id)->get('products');
	 if($rs->num_rows()>0)
	 {
		  $product_arr=$rs->result_array();
	 }
	 
	 return $product_arr;
	 
 }
 
 public function GetProductCommon()
 {
	 $client_id=$this->Basic_model->unique_id;
	 $search_condition='';
	 
	 if($this->input->get('name'))
	 {
		 $search_text=$this->input->get('name');
		 $search_condition=" And product_name LIKE '%$search_text%'"; 
	 }
	 
	 if($this->input->get('cat_id'))
	 {
		 $search_text=$this->input->get('cat_id');
		 $search_condition.=" And cat_id=$search_text"; 
	 }
	 
	 if($this->input->get('sku'))
	 {
		 $search_text=$this->input->get('sku');
		 $search_condition.=" And sku='$search_text'"; 
	 }
	
     $sub_unique_id=$this->Basic_model->sub_unique_id;	
	 if($sub_unique_id==0)
	 {
	     $sql="Select * from products Where client_id=$client_id $search_condition order by id desc";
	 }
	 else
	 {
		 $sql="Select * from products Where client_id=$client_id $search_condition  And is_active=1 order by id desc";
	 }

	 return $sql;
 }
 
 public function getTotalProductCount()
 {
	 $product_count=0;
	 $sql=$this->GetProductCommon();
	 $rs=$this->db->query($sql);
	 if($rs->num_rows()>0)
	 {
		 $product_count=$rs->num_rows;
	 }
	 
	 return $product_count;
 }
 
  public function GetProductPrice($product_id,$product_type)
  {
	 $price=array(); 
	 $client_id=$this->Basic_model->unique_id;

		 if($product_type==1)
	 	 {
			$sql="Select * from rent_price_slab INNER JOIN product_price ON rent_price_slab.id=product_price.slab_id
	        Where rent_price_slab.client_id=$client_id And product_price.product_id=$product_id";
	        $rs=$this->db->query($sql);
			if($rs->num_rows()>0)
			{ 
				$raw_price_array=$rs->result_array();
				foreach($raw_price_array as $item)
				{
					$price[$item['slab_name']]=$item['amount'];
					
				}
			}
	     }
		 
		 
		 if($product_type==2)
		 {
			$sql="Select * from  product_price Where product_id=$product_id";
	        $rs=$this->db->query($sql);
			if($rs->num_rows()>0)
			{
				$raw_price_array=$rs->row_array();
			    $price=$raw_price_array['amount'];
			}
			
			 
		 }
	 

	 return $price;
	 
  }
  
 public function GetFirstImage($id) 
 {
   $image_name="";
   $sql="SELECT * FROM product_images WHERE product_id=$id ORDER BY id asc LIMIT 0,1";
   $rs=$this->db->query($sql);
   if($rs->num_rows()>0)
   {
		$image_list=$rs->row_array();
		$image_name=$image_list['image_name'];
   }
   
   return $image_name;
 }
 
 public function GetProductData($offset,$perpage)
 {
	 $product_arr=array();
	 $product_array=array();
	 $sql=$this->GetProductCommon();
	 $limit_query=" LIMIT $offset, $perpage";
	 $sql2=$sql.$limit_query;
	 $rs=$this->db->query($sql2);
	 $sub_unique_id=$this->Basic_model->sub_unique_id;
	 $image_link=$this->Basic_model->image_link;
	 //$rs=$this->db->select('*')->where('client_id',$this->Basic_model->unique_id)->get('products');
	 if($rs->num_rows()>0)
	 {
		  $product_arr=$rs->result_array();
		  $product_array=array();
		  
		  foreach($product_arr as $item)
		  {
			  $product_image='';
			  $product_price='';
			  
			  $id=$item['id'];
			  $type=$item['type'];
			  $product_type=$type;
			  
			  $product_price=$this->GetProductPrice($id,$type);
			  $base64="";
			  $path = base_url('product_image')."/".$this->GetFirstImage($id);
			  if (@fopen($path, "r"))
				{
					  $type = pathinfo($path, PATHINFO_EXTENSION);
					  $data = file_get_contents($path);
					  $base64 = 'data:image/' . $type . ';base64,' . base64_encode($data);
				}
			  
			  

			 
			  $product_arr=array(
			    'id'=>$id,
				'cat_id'=>$item['cat_id'],
				'type'=>$product_type,
				'sku'=>$item['sku'],
				'name'=>$item['product_name'],
				'number'=>$item['product_number'],
				'price'=>$product_price,
				'description'=>$item['product_description'],
				'image'=>$base64,
			  );
			  
			  if($sub_unique_id==0)
			  {
				  $product_arr['is_active']=$item['is_active'];
			  }
			  $product_array[]=$product_arr;
			  
		  }
		  
	 }
	 
	 return $product_array;
	 
 }
 
 
 public function GetProductDetailsOnId($product_id)
 {
	  $product_data=array();
	  $product_array=array();
	  $rs=$this->db->select('*')->where('id',$product_id)->get('products');
	  if($rs->num_rows()>0)
	   {
		  $product_data=$rs->row_array();
		  
		
		      $product_image='';
			  $product_price='';
			  $image_link=$this->Basic_model->image_link;
              $sub_unique_id=$this->Basic_model->sub_unique_id;
			  $id=$product_data['id'];
			  $type=$product_data['type'];
			  
			  
			  $product_price=$this->GetProductPrice($id,$type);
			  
			  $post_data['product_id']=$product_id;
			  $product_image=$this->GetProductImageName($post_data);
			  $product_array=array(
			    'id'=>$id,
				'cat_id'=>$product_data['cat_id'],
				'type'=>$type,
				'name'=>$product_data['product_name'],
				'number'=>$product_data['product_number'],
				'price'=>$product_price,
				'description'=>$product_data['product_description'],
				'images'=>$product_image['result']['image_list'],
			  );
			  
			  if($sub_unique_id==0)
			  {
				  $product_array['is_active']=$product_data['is_active'];
			  }
		  
		  
	   }
	   
	   return $product_array;  
  }
  
 public function GetUserProductType()
 {
	 $product_type=$this->GetProductType();
	 if($product_type==1)
	 {
		 $user_type=array('display_name'=>'Rent','id'=>1);
	 }
	 
	 if($product_type==2)
	 {
		 $user_type=array('display_name'=>'Buy','id'=>2);
	 }
	 
	 if($product_type==3)
	 {
		 $user_type=array(array('display_name'=>'Rent','id'=>1),array('display_name'=>'Buy','id'=>2));
	 }
	 
	 return $user_type;
 }
  
 public function GetProductOnCatId($cat_id)
 {
	  $product_data=array();
	  $rs=$this->db->select('*')->where('client_id',$this->Basic_model->unique_id)->where('cat_id',$cat_id)->get('products');
	  if($rs->num_rows()>0)
	   {
		  $product_data=$rs->result_array();
	   }
	   
	   return $product_data;  
  }
  
  
 public function GetAttributeDetailsOnProductId($product_id)
 {
	  $attribute_data=array();
	  $rs=$this->db->select('*')->where('product_id',$product_id)->get('product_attribute');
	  if($rs->num_rows()>0)
	   {
		  $attribute_data=$rs->result_array();
	   }
	   
	   return $attribute_data;  
  }
  
  
 public function GetWarehouseDetails()
 {
	 
	 $warehouse_arr=array();
	 $rs=$this->db->select('*')->where('client_id',$this->Basic_model->unique_id)->get('warehouse');
	 if($rs->num_rows()>0)
	 {
		  $warehouse_arr=$rs->result_array();
	 }
	 
	 return $warehouse_arr;
	 
 }
 
 
 public function InsertStockData($post_data)
 {
	 $error='';
	 $errortext='';
	 $result=''; 
	 
	 $sku_name=$post_data['sku'];
	 //$sku_name=$this->Common_model->get_single_field_value('products','sku','id',$product_id);
	 
	 $rs3=$this->db->select('*')->where('sku',$sku_name)->where('client_id',$this->Basic_model->unique_id)->get('products');
	 if(!$rs3->num_rows()>0)
	 {
		 $error=true;
		 $errortext="Product Not available";
	 }
	 
	 
	 $rs3=$this->db->select('*')->where('sku',$sku_name)->where('client_id',$this->Basic_model->unique_id)->get('master_stock');
	 if($rs3->num_rows()>0)
	 {
		 $error=true;
		 $errortext="Product already exist";
	 }
	 
	 
	 if(!$error)
	 {
		 $insert_arr=array
		   (
			 'client_id'=>$this->Basic_model->unique_id,
			 'sku'=>$sku_name,
			 'avl_qty'=>$post_data['avl_qty'],
			 'alert_qty'=>$post_data['alert_qty'],
		   );
			   
		//echo '<pre>',print_r($insert_arr);
		//die();	
		 $success=$this->db->insert('master_stock',$insert_arr);
		 if($success)
		   {
			 $result['successMessage']="Data successfully inserted";
		   }
		   else
		   {
			 $error=true;
			 $errortext='insert error';
			}
	 }
	 
	 
	 return array('error' => $error, 'errortext' => $errortext, 'result' => $result); 
 }
 
 public function UpdateStockData($post_data)
 {
	 $error='';
	 $errortext='';
	 $result=''; 
	 
	 
	  $stock_id=$post_data['stock_id'];
	 //$sku_name=$this->Common_model->get_single_field_value('products','sku','id',$product_id);
	 
	 $rs3=$this->db->select('*')->where('id',$stock_id)->get('master_stock');
	 if(!$rs3->num_rows()>0)
	 {
		 $error=true;
		 $errortext="Stock id not found";
	 }
	 
	 if(!$error)
	 {
		 $update_arr=array
		   (
			 'avl_qty'=>$post_data['avl_qty'],
			 'alert_qty'=>$post_data['alert_qty'],
		   );
			   
		//echo '<pre>',print_r($update_arr);
		//die();	
		 $success=$this->db->where('id',$stock_id)->update('master_stock',$update_arr);
		 if($success)
		   {
			 $result['successMessage']="Data successfully updated";
		   }
		   else
		   {
			 $error=true;
			 $errortext='insert error';
			}
	 }
	 
	 
	 return array('error' => $error, 'errortext' => $errortext, 'result' => $result);
	 
 }
  
 public function GetStockData()
 {
	 $stock_arr=array();
	 $rs=$this->db->select('*')->where('client_id',$this->Basic_model->unique_id)->get('master_stock');
	 if($rs->num_rows()>0)
	 {
		  $stock_arr=$rs->result_array();
	 }
	 
	 return $stock_arr;
 }
 
 public function GetStockDetailsOnId($stock_id)
 {
	 $stock_arr=array();
	 $rs=$this->db->select('*')->where('id',$stock_id)->where('client_id',$this->Basic_model->unique_id)->get('master_stock');
	 if($rs->num_rows()>0)
	 {
		  $stock_arr=$rs->row_array();
	 }
	 
	 return $stock_arr;
 }
 
 
 public function GetChargesData()
 {
	 $charges_arr=array();
	 $rs=$this->db->select('*')->where('client_id',$this->Basic_model->unique_id)->get('additional_charges');
	 if($rs->num_rows()>0)
	 {
		  $charges_arr=$rs->result_array();
	 }
	 
	 return $charges_arr;
 }
 
 
 public function GetChargesDataOnId($charge_id)
 {
	 $charges_arr=array();
	 $rs=$this->db->select('*')->where('id',$charge_id)->where('client_id',$this->Basic_model->unique_id)->get('additional_charges');
	 if($rs->num_rows()>0)
	 {
		  $charges_arr=$rs->row_array();
	 }
	 
	 return $charges_arr;
 }
 
 
 public function InsertChargesData($post_data)
 {
	 
	 $error='';
	 $errortext='';
	 $result=''; 
	 
	 $lable_of_charge=trim($post_data['label_of_charges']);
	 	 
	 $rs3=$this->db->select('*')->where('lable_of_charge',$lbl_of_charges)->where('client_id',$this->Basic_model->unique_id)->get('additional_charges');
	 if($rs3->num_rows()>0)
	 {
		 $error=true;
		 $errortext="Label of charges already exist";
	 }
	 else
	 {
		 $insert_arr=array
		   (
			 'client_id'=>$this->Basic_model->unique_id,
			 'lable_of_charge'=>$lable_of_charge,
			 'charge'=>$post_data['charges'],
			 'is_percent'=>$post_data['charges_type'],
			 'is_active'=>$post_data['inlineRadioOptions'],
		   );
			   
		//echo '<pre>',print_r($insert_arr);
		//die();	
		 $success=$this->db->insert('additional_charges',$insert_arr);
		 if($success)
		   {
			 $result['successMessage']="Data successfully inserted";
		   }
		   else
		   {
			 $error=true;
			 $errortext='insert error';
			}
	 }
	 
	 
	 return array('error' => $error, 'errortext' => $errortext, 'result' => $result); 
 
 }
 
 
 public function UpdateAddtionalCharges($charge_id,$post_data)
 {
	
	 
	 $error='';
	 $errortext='';
	 $result=''; 
	 
	 $lbl_of_charges=trim($post_data['label_of_charges']);
	 	 
	 $rs3=$this->db->select('*')->where('id!=',$charge_id)->where('lable_of_charge',$lbl_of_charges)
	 		->where('client_id',$this->Basic_model->unique_id)->get('additional_charges');
	 if($rs3->num_rows()>0)
	 {
		 $error=true;
		 $errortext="Label of charges already exist";
	 }
	 else
	 {
		 $insert_arr=array
		   (
			 'lable_of_charge'=>$lbl_of_charges,
			 'charge'=>$post_data['charges'],
			 'is_percent'=>$post_data['charges_type'],
			 'is_active'=>$post_data['inlineRadioOptions'],
		   );
			   
		//echo '<pre>',print_r($insert_arr);
		//die();	
		 $success=$this->db->where('id',$charge_id)->update('additional_charges',$insert_arr);
		 if($success)
		   {
			 $result['successMessage']="Data successfully updated";
		   }
		   else
		   {
			 $error=true;
			 $errortext='insert error';
			}
	 }
	 
	 
	 return array('error' => $error, 'errortext' => $errortext, 'result' => $result); 
 
  
 }
 
 public function get_rent_product_price($day_span,$product_id,$product_price='')
 {
	 if(!isset($product_price))
	 {
		 $product_price=0;
	 }
	 
	 $client_id=$this->Basic_model->unique_id;
	 $sql="Select * from rent_price_slab INNER JOIN product_price ON rent_price_slab.id=product_price.slab_id
	      Where rent_price_slab.client_id=$client_id And product_price.product_id=$product_id 
		  And $day_span Between rent_price_slab.min_day AND rent_price_slab.max_day";
		  
	 $rs=$this->db->query($sql);
	
	 if($rs->num_rows()>0)
	 {
		 $slab_array=$rs->row_array();
		 $min_value=$slab_array['min_day'];
		 if($day_span > $min_value)
		 {
			$product_price=$product_price + $slab_array['amount'];
			$day_span=($day_span-$min_value);
			$product_price=$this->get_rent_product_price($day_span,$product_id,$product_price);
		 }
		 elseif($day_span == $min_value)
		 {
			 $product_price=$product_price + $slab_array['amount'];
		 }
		 else
		 {
			 $dayly_price=$slab_array['amount'];
			 $product_price=$product_price+($dayly_price * $day_span);
		 }
	 }
	 else
	 {
		  $sql2="Select MAX(rent_price_slab.max_day) as 'min_value', MAX(product_price.amount) as 'product_price' from rent_price_slab INNER JOIN product_price ON rent_price_slab.id=product_price.slab_id
	      Where rent_price_slab.client_id=$client_id And product_price.product_id=$product_id 
		  And rent_price_slab.max_day < $day_span";
	      $rs2=$this->db->query($sql2);
		 
		  if($rs2->num_rows()>0)
		  {
			  $slab_array=$rs2->row_array();
			  $product_price=$product_price + $slab_array['product_price'];
			  $min_value=$slab_array['min_value']; 
			  $day_span=($day_span-$min_value);
			  $product_price=$this->get_rent_product_price($day_span,$product_id,$product_price);
		  }
	 }
	
	
	return $product_price;
 }
 
 public function get_default_day()
 {
	 $default_day='';
	 $rs=$this->db->select('*')->where('client_id',$this->Basic_model->unique_id)->where('is_default',1)->get('rent_price_slab');
	 if($rs->num_rows()>0)
	 {
		 $price_array=$rs->row_array();
		 $default_day=$price_array['min_day'];
	 }
	 
	 return $default_day;
 }
 
 public function get_product_price($product_type,$product_id)
 {
	 if($product_type==1)
	 {
		 $day_span=$this->get_default_day();
		 $product_price=$this->get_rent_product_price($day_span,$product_id);
	 }
	 else
	 {
		 $product_price=$this->Common_model->get_single_field_value('product_price','amount','product_id',$product_id);
	 }
	 
	 return $product_price;
 }
 
 public function InsertDataToCart($post_data)
 {
	 $error='';
	 $errortext='';
	 $result='';
	 
	 //$customer_name=$post_data['customer_name'];
	 //$category_name=$post_data['category_name'];
	 $sku_name=$post_data['product_sku'];
	 $product_qty=$post_data['qty'];
	 
	 $rs=$this->db->select('*')->where('sku',$sku_name)->where('client_id',$this->Basic_model->unique_id)
	 ->get('products');
	 if(!$rs->num_rows()>0)
	 {
		 $error=true;
		 $errortext="Product is not available in the cart";
	 }
	 
	
	$token_id=$this->Basic_model->token_id;
	
	if($product_qty <= 0)
	{
		$error=true;
		$errortext="Quantity must be greater than zero";
	}
	 
	 
	 if(!$error)
	 {
		 $product_id=$this->Common_model->get_single_field_value('products','id','sku',$sku_name);
		 $product_name=$this->Common_model->get_single_field_value('products','product_name','sku',$sku_name);
		 //$product_image=$this->Common_model->get_single_field_value('products','product_image','id',$product_id);
		 $product_type=$this->Common_model->get_single_field_value('products','type','id',$product_id);
		 $product_price=$this->get_product_price($product_type,$product_id);
		 //$product_price=$this->Common_model->get_single_field_value('products','product_price','id',$product_id);
		 $avl_qty=$this->Common_model->get_single_field_value('master_stock','avl_qty','sku',$sku_name);
		 $alert_qty=$this->Common_model->get_single_field_value('master_stock','alert_qty','sku',$sku_name);
		 
		 $today_date=date('Y-m-d');
		 $get_default_day=$this->get_default_day();
		 $plus_extend_day=date('Y-m-d', strtotime($today_date."+$get_default_day days"));
	 
	 
	  if($token_id!="")
	  {
	    $rs=$this->db->select('*')->where('client_id',$this->Basic_model->unique_id)->where('token_id',$token_id)->get('temp_cart');
	  }
	  else
	  {
		  $my_session_id=$this->get_session_id();
		  $rs=$this->db->select('*')->where('client_id',$this->Basic_model->unique_id)->where('token_id',$my_session_id)->get('temp_cart');
	  }
	  
	  if($rs->num_rows()>0)
	  {
		  $cart_array=$rs->row_array();
		  if($product_type!=$cart_array['product_type'])
		  {
			  if($cart_array['product_type']==1)
			  {
				  $type="Rent";
			  }
			  if($cart_array['product_type']==2)
			  {
				  $type="Buy";
			  }
			  $error=true;
		      $errortext="You already have $type Product in your cart";
		  }
	  }
	 }
	 //$this->cart->destroy();
	 //die();
	 
	 if(!$error)
	 {
		 $rs=$this->db->select('*')->where('sku',$sku_name)->where('client_id',$this->Basic_model->unique_id)
		 ->get('master_stock');
		 if($rs->num_rows()>0)
		 {
			 $stock_arr=$rs->row_array();
			 if($product_qty >$stock_arr['avl_qty'])
			 {
				 $error=true;
				 $errortext="Stock is not available";
			 }		 
		 }
		 else
		 {
			 $error=true;
			 $errortext="Stock details not found";
		 }
	 }
	 
	 if(!$error)
	 {	 
	 
	    if($token_id!="")
		{
		      $rs=$this->db->select('*')->where('sku_name',$sku_name)->where('client_id',$this->Basic_model->unique_id)
		      ->where('sub_unique_id',$this->Basic_model->sub_unique_id)->get('temp_cart');
			  
			  
		}
		else
		{
			 $my_session_id=$this->get_session_id();
			 $rs=$this->db->select('*')->where('sku_name',$sku_name)->where('client_id',$this->Basic_model->unique_id)
			 ->where('token_id',$my_session_id)->get('temp_cart');
			 $token_id=$my_session_id;
		}
		
		 if($rs->num_rows()>0)
		 {
			 $error=true;
			 $errortext="This product is already selected";
		 }
	 }
	 if(!$error)
	 {
		 
		 $temp_cart=array(
		  'token_id'=>$token_id,
		  'sku_name'=>$sku_name,
		  'product_id'=>$product_id,
		  'product_type'=>$product_type,
		  'start_date'=>$today_date,
		  'end_date'=>$plus_extend_day,
		  'product_qty'=>$product_qty,
		  'product_price'=>$product_price,
		  'avl_qty'=>$avl_qty,
		  'client_id'=>$this->Basic_model->unique_id,
		  'sub_unique_id'=>$this->Basic_model->sub_unique_id,
		 );
		$success=$this->db->insert('temp_cart',$temp_cart);
	
	  $result['successMessage']='Product successfully inserted';
	 
	 }
	
	
	return array('error' => $error, 'errortext' => $errortext, 'result' => $result); 
 }

 public function GetEmployeeStatus($sub_unique_id)
 {
	$order_status_id=0; 
	$employee_id=$this->Common_model->get_single_field_value('account','role_id','id',$sub_unique_id);
	$client_id=$this->Basic_model->unique_id;
	$sub_unique_id=0;
	 
	 $sql="Select *,order_status_master.id as 'order_status_id' from sub_role_details INNER JOIN role_master ON sub_role_details.role_master_id=role_master.id 
	      INNER JOIN order_status_master ON sub_role_details.id=order_status_master.role INNER JOIN status_master ON order_status_master.status_text=status_master.id 
		  Where role_master.object_id=$client_id And status_master.is_active=1 And sub_role_details.is_active=1 
		  and role_master.is_active=1 And status_master.client_id=$client_id And sub_role_details.id=$employee_id";
	  
	  $rs=$this->db->query($sql);
	  if($rs->num_rows()>0)
	  {
		  $status_array=$rs->row_array();
		  $order_status_id=$status_array['order_status_id']; 
	  }
	 
	 return $order_status_id;
 }
 
 public function GetOffrentEmployeeStatus($sub_unique_id)
 {
	$off_rent_status_id=0; 
	$employee_id=$this->Common_model->get_single_field_value('account','role_id','id',$sub_unique_id);
	$client_id=$this->Basic_model->unique_id;
	$sub_unique_id=0;
	
	
	$sql="Select *,off_rent_status.id as 'off_rent_status_id' from sub_role_details INNER JOIN role_master ON 
		  sub_role_details.role_master_id=role_master.id INNER JOIN off_rent_status ON sub_role_details.id=off_rent_status.employee_id 
		  INNER JOIN off_rent_status_master ON off_rent_status.master_status_id=off_rent_status_master.id 
		  Where role_master.object_id=$client_id And off_rent_status_master.is_active=1 And sub_role_details.is_active=1 
		  and role_master.is_active=1 And off_rent_status_master.client_id=$client_id And sub_role_details.id=$employee_id";
		    
	  $rs=$this->db->query($sql);
	  if($rs->num_rows()>0)
	  {
		  $status_array=$rs->row_array();
		  $off_rent_status_id=$status_array['off_rent_status_id']; 
	  }
	 
	 return $off_rent_status_id;
 }
 
  public function GetServiceRequestEmployeeStatus($sub_unique_id)
 {
	$off_rent_status_id=0; 
	$employee_id=$this->Common_model->get_single_field_value('account','role_id','id',$sub_unique_id);
	$client_id=$this->Basic_model->unique_id;
	$sub_unique_id=0;
	
	$sql="Select *,service_request_status.id as 'service_request_status_id' from sub_role_details INNER JOIN role_master ON 
		  sub_role_details.role_master_id=role_master.id INNER JOIN service_request_status ON sub_role_details.id=service_request_status.employee_id 
		  INNER JOIN service_request_status_master ON service_request_status.master_status_id=service_request_status_master.id 
		  Where role_master.object_id=$client_id And service_request_status_master.is_active=1 And sub_role_details.is_active=1 
		  and role_master.is_active=1 And service_request_status_master.client_id=$client_id And sub_role_details.id=$employee_id";
	
	  $rs=$this->db->query($sql);
	  if($rs->num_rows()>0)
	  {
		  $status_array=$rs->row_array();
		  $off_rent_status_id=$status_array['service_request_status_id']; 
	  }
	 
	 return $off_rent_status_id;
 }

 public function SubmitProductOrder($post_data)
 {
	//echo '<pre>',print_r($post_data);
	//die();
	
	$error=false;
	$errortext='';
	$result='';
	
	$order_id="";
	$invoice_id="";
	
	$customer_id=$post_data['customer_id'];
	$billing_address_id=$post_data['billing_address_id'];
	$shipping_address_id=$post_data['shipping_address_id'];
	
	$order_status=$post_data['order_status_id'];
	$note=$post_data['note'];
	$purchase_order_number=$post_data['purchase_order_number'];
	
	$token_id=$this->Basic_model->token_id;
	$client_id=$this->Basic_model->unique_id;
	$sub_unique_id=$this->Basic_model->sub_unique_id;
	
	$rs=$this->db->where('token_id',$token_id)->where('client_id',$client_id)->where('sub_unique_id',$sub_unique_id)
	->get('temp_cart');
	if(!$rs->num_rows()>0)
	{
		$error=true;
	    $errortext='Cart is empty';
	}
	
	if(!$error)
	{
		$rs=$this->db->select('*')->where('id',$billing_address_id)->where('account_id',$customer_id)->get('billing_address');
	    if(!$rs->num_rows()>0)
	    {
		   $error=true;
		   $errortext='Invalid billing address';
	    }
	}
	
	if(!$error)
	{
		$rs=$this->db->select('*')->where('id',$shipping_address_id)->where('account_id',$customer_id)->get('shipping_address');
	    if(!$rs->num_rows()>0)
	    {
		   $error=true;
		   $errortext='Invalid shipping address';
	    }
	}
	
	if(!$error)
	{
		$rs=$this->db->select('*')->where('id',$customer_id)->where('client_id',$this->Basic_model->unique_id)->get('account');
	    if(!$rs->num_rows()>0)
	    {
		   $error=true;
		   $errortext='Customer not found';
	    }
		
		$client_id=$this->Basic_model->unique_id;
		$sql="Select *,order_status_master.id as 'order_status_id' from sub_role_details INNER JOIN role_master ON sub_role_details.role_master_id=role_master.id 
	      INNER JOIN order_status_master ON sub_role_details.id=order_status_master.role INNER JOIN status_master ON order_status_master.status_text=status_master.id 
		  Where role_master.object_id=$client_id And status_master.is_active=1 And sub_role_details.is_active=1 
		  and role_master.is_active=1 And status_master.client_id=$client_id And sub_role_details.id=$order_status";
		  $rs=$this->db->query($sql);
		  if(!$rs->num_rows()>0)
	      {
		    $error=true;
		    $errortext='Invalid status id';
	      }
		
	}
	
	if(!$error)
	{
	    
	   $cart_data=$this->GetCartDetails();
	   
	   //print_r($cart_data);
	   //die();
	  
	   $order_type=$cart_data['order_type'];
	   $start_date=$cart_data['start_date'];
	   $end_date=$cart_data['end_date'];
	   
	   if($order_type==1)
		{
			$start_date=date("Y-m-d", strtotime($start_date));
			$end_date=date("Y-m-d", strtotime($end_date));
		}
		else
		{
			$start_date="";
			$end_date="";
		}
	   
	   $product_list=$cart_data['product_list'];
	   $charges=$cart_data['charges'];
	   //$is_percent=$cart_data['is_percent'];
	   //$unit_charges=$cart_data['unit_charges'];
	   
	   $subtotal=$cart_data['sub_total'];
	   $charges_total=$cart_data['charges_total'];
	   $grand_total=$cart_data['grand_total'];
	//insert order
		$order_array=array(
		  'customer_id'=>$customer_id,
		  'order_type'=>$order_type,
		  'order_start_date'=>$start_date,
		  'order_end_date'=>$end_date,
		  'order_total'=>$subtotal,
		  'order_status'=>$order_status,
		  'billing_address_id'=>$billing_address_id,
		  'shipping_address_id'=>$shipping_address_id,
		  'purchase_order_number'=>$purchase_order_number,
		  'note'=>$note
		);
	
	
	$this->db->insert('product_order',$order_array);
	$order_id=$this->db->insert_id();
	
	
	$order_status_log_array=array(
	  'client_id'=>$this->Basic_model->unique_id,
	  'order_id'=>$order_id,
	  'role_id'=>$this->Basic_model->sub_unique_id,
	  'order_status_id'=>$order_status,
	);
	
	//echo '<pre>',print_r($order_array);
	$this->db->insert('order_status_log',$order_status_log_array);
	
	//$product_count=count($product_id);
	foreach($product_list as $item)
	{
		 $new_qty=0;
		 $sku_no="";
		 $order_details_array=array(
		  'order_id'=>$order_id,
		  'order_start_date'=>$start_date,
		  'order_end_date'=>$end_date,
		  'product_id'=>$item['product_id'],
		  'qty'=>$item['qty'],
		  'rate'=>$item['price'],
		  'total_rate'=>$item['amount'],
		 );
		 
		 //echo '<pre>',print_r($order_details_array);
	    $this->db->insert('order_details',$order_details_array);
		
		$sku_no=$item['sku'];
		$new_qty=$item['avl_qty']-$item['qty'];
		
		$update_arr=array(
		 'avl_qty'=>$new_qty
		);
		
		$success=$this->db->where('client_id',$this->Basic_model->unique_id)->where('sku',$sku_no)
		->update('master_stock',$update_arr);
		
	}
	
	$invoice_array=array(
	  'client_id'=>$this->Basic_model->unique_id,
	  'customer_id'=>$customer_id,
	  'order_id'=>$order_id,
	  'sub_total'=>$subtotal,
	  'charges_total'=>$charges_total,
	  'grand_total'=>$grand_total,
	 );
	 
	 //echo '<pre>',print_r($invoice_array);
	 $this->db->insert('invoice',$invoice_array);
	 $invoice_id=$this->db->insert_id();
	 
	 if(!empty($charges))
	 {
        $i=0;
		foreach($charges as $key=>$value)
		{
			 $charges_array=array(
			  'order_id'=>$order_id,
			  'charges'=>$value['lable_of_charge'],
			 );
			 
			 //echo '<pre>',print_r(charges);
			$this->db->insert('charges',$charges_array);
			$charges_id=$this->db->insert_id();
			
			$charges_array=array(
			  'invoice_id'=>$invoice_id,
			  'charges_id'=>$charges_id,
			  'is_percent'=>$value['is_percent'],
			  'unit_charges'=>$value['unit_charge'],
			  'amount'=>$value['value'],
			 );
			 
			 //echo '<pre>',print_r(charges);
			$this->db->insert('invoice_charges',$charges_array);
			
			$i++;
		}
	 }
	
	$token_id=$this->Basic_model->token_id;
	$rs=$this->db->where('token_id',$token_id)->where('client_id',$client_id)->where('sub_unique_id',$sub_unique_id)
	->delete('temp_cart');
	
    $result['successMessage']="Data successfully inserted";
	$result['invoice_id']=$invoice_id;
	
	 $send_email=$this->send_order_email($order_id,$order_status);
	}
	
	return array('error' => $error, 'errortext' => $errortext, 'result' => $result); 
 }
 
 public function get_employee_email($employee_id,$role)
 {
	 $client_id=$this->Basic_model->unique_id;
	 $email='';
	 $rs=$this->db->where('sub_unique_id',$employee_id)->where('unique_id',$client_id)->where('role',$role)->get('login');
	 if($rs->num_rows()>0)
	 {
		 $login_array=$rs->row_array();
		 $email=$login_array['email'];
	 }
	 
	 return $email;
 }
 
 public function send_order_email($order_id,$order_status)
 {
	$error='';
	$errortext='';
	$result='';
	 
	 $role=$this->Basic_model->role;
	 $sub_unique_id=$this->Basic_model->sub_unique_id;
	 $client_id=$this->Basic_model->unique_id;
	 $email_1='';
	 $email_2='';
	 $employee_id='';
	 $employee_parent_id="";
	 $is_changeable="";
	 $send_email_array="";
	 
	  $sql="Select *,order_status_master.id as 'order_status_id' from sub_role_details INNER JOIN role_master ON sub_role_details.role_master_id=role_master.id 
	  INNER JOIN order_status_master ON sub_role_details.id=order_status_master.role INNER JOIN status_master ON order_status_master.status_text=status_master.id 
	  Where role_master.object_id=$client_id And status_master.is_active=1 And sub_role_details.is_active=1 
	  and role_master.is_active=1 And status_master.client_id=$client_id And order_status_master.id=$order_status";
	  $rs=$this->db->query($sql);
	  if($rs->num_rows()>0)
	  {
		$order_array=$rs->row_array();
		$employee_id=$order_array['id'];
		$employee_parent_id=$order_array['report_to'];
		$is_changeable=$order_array['is_changeable'];
	  }
	 
	 if($role==3)
	 {
		 if($is_changeable==1)
		 {
		   $email_1=$this->get_employee_email($employee_parent_id,3);
		 }
	 }
	 
	 if($role==4)
	 {
		 $email_1=$this->get_employee_email($employee_id,3);
		 $email_2=$this->get_employee_email($sub_unique_id,4);
	 }
	 
	   $email=$email_1;
	   $second_email=$email_2;
	   
	   if($email_1!="")
	   {
		   $subject="Order submit";
		   $message="<b>Order id</b> :".$order_id.'<br/>'.
		   "<b>Text</b>: "."Submitted".'<br/>';
		   
		   $send_email_array=array(
			 'subject'=>$subject,
			 'message'=>$message,
			 'email'=>$email
		   );
		   
		
			$send_email_array=$this->Common_model->send_email($send_email_array);
	   }
		if($second_email!="")
		{
			$send_email_array=array(
		     'subject'=>$subject,
		     'message'=>$message,
		     'email'=>$second_email
	         );
	
		   $send_email_array=$this->Common_model->send_email($send_email_array);
		}
		
		if($send_email_array!="")
		{
			if(!$send_email_array['error'])
			{
				$result['successMessage']="Data successfully submitted";
			}
			else
			{
				$error = true;
				$errortext =$send_email_array['errortext'];
			}
		}
		else
		{
			$error = true;
			$errortext ='Email id not valid or not found';
		}
	 
	return array('error' => $error, 'errortext' => $errortext, 'result' => $result);  
 }
 
 public function InCompleteOrderOperation($order_id)
 {
	$order_permisstion=0;
	 
	//$order_id=$this->Common_model->get_single_field_value('invoice','order_id','id',$invoice_id);
    $order_status_details=$this->Sop_model->GetSubmitOrderStatus($order_id);
    $changeable_order=$order_status_details['is_changeable'];
	if($changeable_order==1)
	{
	   $order_permisstion=1;
	}
	
	return $order_permisstion;
	
 }
 
 public function avl_qty($sku_name)
 {
	 $avl_qty=0;
	 
	 $client_id=$this->Basic_model->unique_id;
	 
	 $sql="Select * from master_stock Where sku='$sku_name' And client_id=$client_id";
	 $rs=$this->db->query($sql);
	/* 
	 $rs=$this->db->select('*')->where('client_id',$this->Basic_model->unique_id)
	 ->where('sku',$sku_name)->get('master_stock');*/
		 
	 if($rs->num_rows()>0)
	 {
		$stock_arr=$rs->row_array();
		$avl_qty=$stock_arr['avl_qty'];
	 }
	 
	return $avl_qty; 
 }
 
 
 public function update_stock($new_qty,$sku_name)
 {
	  $update_arr=array(
		 'avl_qty'=>$new_qty
		);
		
	$success=$this->db->where('client_id',$this->Basic_model->unique_id)->where('sku',$sku_name)
	->update('master_stock',$update_arr);	
 }
 
 public function InCompleteOrderUpdateQty($post_data)
 {
	$error=false;
	$errortext='';
	$result='';
	
	$row_id=$post_data['row_id'];
	$order_id=$post_data['order_id'];
	$sku_name=$post_data['sku_name'];
	$qty=$post_data['qty'];
	
	//$order_id=$this->Common_model->get_single_field_value('invoice','order_id','id',$invoice_id);
	$order_permisstion=$this->InCompleteOrderOperation($order_id);
	if($order_permisstion==1)
	{
		$rs=$this->db->select('*')->where('sku',$sku_name)->where('client_id',$this->Basic_model->unique_id)
	    ->get('master_stock');
		 if($rs->num_rows()>0)
		 {
			 $stock_arr=$rs->row_array();
			 if($qty >$stock_arr['avl_qty'])
			 {
				 $error=true;
				 $errortext="Stock is not available";
			 }		 
		 }
		 else
		 {
			 $error=true;
			 $errortext="Stock details not found";
		 }
		 
		 
		 if(!$error)
		 {
			 $product_id=$this->Common_model->get_single_field_value('products','id','sku',$sku_name);
			 $avl_qty=$this->avl_qty($sku_name);
			 
			 $rs=$this->db->select('*')->where('order_id',$order_id)->where('product_id',$product_id)->get('order_details');
	         if($rs->num_rows()>0)
		     {
				 $order_arr=$rs->row_array();
				 $exsisting_qty=$order_arr['qty'];
				 $product_price=$order_arr['rate'];
			 }
				
			 $new_qty_1=$avl_qty + $exsisting_qty;
			 $this->update_stock($new_qty_1,$sku_name);
			 
			 $total_rate=$qty * $product_price;
			 $update_arr=array(
				'qty'=>$qty,
				'total_rate'=>$total_rate,
			  );
			 
		   $this->db->select('*')->where('order_id',$order_id)->where('product_id',$product_id)
		   ->where('id',$row_id)->update('order_details',$update_arr);
		   
		   $avl_qty=$this->avl_qty($sku_name);
		   $new_qty_2=$avl_qty - $qty;
		   $this->update_stock($new_qty_2,$sku_name);
		
		   $success=$this->UpdateProductOrder($order_id);
		   if($success)
		   {
			   $result['successMessage']='Data successfully submitted';
		   }
		   else
		   {
			   $result['successMessage']='Error in update';
		   }
		 
		 }
		
	}
	else
	{
		$error=true;
		$errortext="This order is not updateable";
	}
	
	return array('error' => $error, 'errortext' => $errortext, 'result' => $result);  
 }
 
 
  public function InCompleteOrderUpdatePriceByDate($post_data)
 {
	$error=false;
	$errortext='';
	$result='';
	
	$order_id=$post_data['order_id'];
	$start_date=date("Y-m-d", strtotime($post_data['start_date']));
    $end_date=date("Y-m-d", strtotime($post_data['end_date']));
	$day_span=1+floor((abs(strtotime($start_date) - strtotime($end_date))/(60*60*24)));
	
	//$order_id=$this->Common_model->get_single_field_value('invoice','order_id','id',$invoice_id);
	$order_type=$this->Common_model->get_single_field_value('product_order','order_type','id',$order_id);
	if($order_type==1)
	{
		$order_permisstion=$this->InCompleteOrderOperation($order_id);
	    if($order_permisstion==1)
		{
			$rs=$this->db->where('order_id',$order_id)->get('order_details');
			if($rs->num_rows()>0)
			{
				$order_array=$rs->result_array();
				
				foreach($order_array as $item)
				{
					$product_id="";
					$qty="";
					$total_rate="";
					
					$id=$item['id'];
					$product_id=$item['product_id'];
					$qty=$item['qty'];
					$product_price=$this->get_rent_product_price($day_span,$product_id);
					$total_rate=($qty * $product_price);
					
					$update_data = array(
					'rate'=> $product_price,
					'total_rate'=> $total_rate,
				   );

				 
				   $success=$this->db->where('id',$id)->update('order_details',$update_data);
				}
				   $success=$this->UpdateProductOrder($order_id);
				   if($success)
				   {
					   $result['successMessage']='Data successfully submitted';
				   }
				   else
				   {
					   $result['successMessage']='Error in update';
				   }
				
			}
			else
			{
				$error=true;
		        $errortext="Order not found";
			}
		}
		else
		{
			$error=true;
		    $errortext="This order is not updateable";
		}
	}
	else
	{
		$error=true;
		$errortext="This is not rent order";
	}
	
	
	
	return array('error' => $error, 'errortext' => $errortext, 'result' => $result);  
 }
 
 
 public function InCompleteOrderNewProduct($post_data)
 {
	$error=false;
	$errortext='';
	$result='';
	
	$order_id=$post_data['order_id'];
	$sku_name=$post_data['sku_name'];
	$qty=$post_data['qty'];
	
	//$order_id=$this->Common_model->get_single_field_value('invoice','order_id','id',$invoice_id);
	$order_permisstion=$this->InCompleteOrderOperation($order_id);
	if($order_permisstion==1)
	{
		if($qty <= 0)
		{
			$error=true;
		    $errortext="Quantity must be greater than zero";
		}
		
		if(!$error)
		{
			$product_id=$this->Common_model->get_single_field_value('products','id','sku',$sku_name);
			$rs=$this->db->select('*')->where('order_id',$order_id)->where('product_id',$product_id)->get('order_details');
	        if($rs->num_rows()>0)
		    {
				$error=true;
		        $errortext="Product is already exist";
			}
		}
		
		if(!$error)
		{
			$rs=$this->db->select('*')->where('sku',$sku_name)->where('client_id',$this->Basic_model->unique_id)
		    ->get('master_stock');
			 if($rs->num_rows()>0)
			 {
				 $stock_arr=$rs->row_array();
				 if($qty >$stock_arr['avl_qty'])
				 {
					 $error=true;
					 $errortext="Stock is not available";
				 }		 
			 }
			 else
			 {
				 $error=true;
				 $errortext="Stock details not found";
			 }
		}
		 
		 if(!$error)
		 {
			 $product_price=$this->Common_model->get_single_field_value('products','product_price','sku',$sku_name);
			 
			 
			 $total_rate=$qty * $product_price;
			 
			 $insert_arr=array(
			    'order_id'=>$order_id,
				'product_id'=>$product_id,
				'qty'=>$qty,
				'rate'=>$product_price,
				'total_rate'=>$total_rate,
			  );
			 
		   $success=$this->db->insert('order_details',$insert_arr);
		   $avl_qty=$this->avl_qty($sku_name);
		   $new_qty_2=$avl_qty - $qty;
		   $this->update_stock($new_qty_2,$sku_name);
		   
		   
		   $success=$this->UpdateProductOrder($order_id);
		   if($success)
		   {
			   $result['successMessage']='Data successfully submitted';
		   }
		   else
		   {
			   $result['successMessage']='Error in update';
		   }
		 
		 }
		
	}
	else
	{
		$error=true;
		$errortext="This order is not updateable";
	}
	
	return array('error' => $error, 'errortext' => $errortext, 'result' => $result);  
 }
 
 
 public function InCompleteOrderDeleteProduct($post_data)
 {
	$error=false;
	$errortext='';
	$result='';
	
	$order_id=$post_data['order_id'];
	$sku_name=$post_data['sku_name'];
	$row_id=$post_data['row_id'];
	
	//$order_id=$this->Common_model->get_single_field_value('invoice','order_id','id',$invoice_id);
	$order_permisstion=$this->InCompleteOrderOperation($order_id);
	if($order_permisstion==1)
	{
		$rs=$this->db->select('*')->where('sku',$sku_name)->where('client_id',$this->Basic_model->unique_id)
	    ->get('products');
		 if(!$rs->num_rows()>0)
		 {
		   $error=true;
		   $errortext="Product not found"; 	 
		 }
		
		
		 if(!$error)
		 {
			 $product_id=$this->Common_model->get_single_field_value('products','id','sku',$sku_name);
			 $rs=$this->db->select('*')->where('order_id',$order_id)->where('product_id',$product_id)->get('order_details');
	         if($rs->num_rows()>0)
		     {
				 $order_arr=$rs->row_array();
				 $exsisting_qty=$order_arr['qty'];
				 $product_price=$order_arr['rate'];
			 }
			 
		   $success=$this->db->where('order_id',$order_id)->where('product_id',$product_id)->where('id',$row_id)->delete('order_details');  
		   
		    $avl_qty=$this->avl_qty($sku_name);
		    $new_qty_1=$avl_qty + $exsisting_qty;
			$this->update_stock($new_qty_1,$sku_name);
		   
		   $success=$this->UpdateProductOrder($order_id);
		   if($success)
		   {
			   $result['successMessage']='Data successfully submitted';
		   }
		   else
		   {
			   $result['successMessage']='Error in update';
		   }
		 
		 }
		
	}
	else
	{
		$error=true;
		$errortext="This order is not updateable";
	}
	
	return array('error' => $error, 'errortext' => $errortext, 'result' => $result);  
 }
 
 
 public function InCompleteOrderUpdateStatus($post_data)
 {
	$error=false;
	$errortext='';
	$result='';
	
	$order_id=$post_data['order_id'];
	$status_id=$post_data['status_id'];
	$note=$post_data['note'];
	$purchase_order_number=$post_data['purchase_order_number'];
	$billing_address_id=$post_data['billing_address_id'];
	$shipping_address_id=$post_data['shipping_address_id'];
	
	if(!$error)
	{
		$rs=$this->db->select('*')->where('id',$billing_address_id)->where('account_id',$customer_id)->get('billing_address');
	    if(!$rs->num_rows()>0)
	    {
		   $error=true;
		   $errortext='Invalid billing address';
	    }
	}
	
	if(!$error)
	{
		$rs=$this->db->select('*')->where('id',$shipping_address_id)->where('account_id',$customer_id)->get('shipping_address');
	    if(!$rs->num_rows()>0)
	    {
		   $error=true;
		   $errortext='Invalid shipping address';
	    }
	}

	//$order_id=$this->Common_model->get_single_field_value('invoice','order_id','id',$invoice_id);
	
	if(!$error)
	{
		$order_permisstion=$this->InCompleteOrderOperation($order_id);
		if($order_permisstion==1)
		{
			if($note=="")
			{
				$order_array=array(
				 'order_status'=>$status_id,
				 'purchase_order_number'=>$purchase_order_number,
				 'billing_address_id'=>$billing_address_id,
		  		 'shipping_address_id'=>$shipping_address_id,
				);
				
			}
			else
			{
				$order_array=array(
				 'order_status'=>$status_id,
				 'purchase_order_number'=>$purchase_order_number,
				 'billing_address_id'=>$billing_address_id,
		  		 'shipping_address_id'=>$shipping_address_id,
				 'note'=>$note,
				);
			}
			
			$success=$this->db->where('id',$order_id)->update('product_order',$order_array);
			if($success)
			{
			   $send_email=$this->send_order_email($order_id,$status_id);
			   $result['successMessage']='Data successfully submitted';
			}
			else
			{
				$result['successMessage']='Error in update';
			}
		}
		else
		{
			$error=true;
			$errortext="This order is not updateable";
		}
	}
	
	return array('error' => $error, 'errortext' => $errortext, 'result' => $result);  
 }
 
 public function UpdateProductOrder($order_id)
 {
	 $invoice_id=$this->Common_model->get_single_field_value('invoice','id','order_id',$order_id);
	 $sub_total=0;
	 $grand_total=0;
	 $total_additional_charges=0;
	 
	 $rs=$this->db->select('*')->where('order_id',$order_id)->get('order_details');
	 if($rs->num_rows()>0)
	 {
		 $order_details=$rs->result_array();
		  foreach($order_details as $item)
		  {
			  $sub_total = $sub_total+$item['total_rate'];
		  }
		  
		  $order_array=array(
		    'order_total'=>$sub_total,
		  );
	
	     $this->db->where('id',$order_id)->update('product_order',$order_array);
		 
		 $total_additional_charges=0;
		 $rs=$this->db->select('*')->where('invoice_id',$invoice_id)->get('invoice_charges');
		 if($rs->num_rows()>0)
		 {
			 $additonal_charges=$rs->result_array();
			 foreach($additonal_charges as $row)
		     {
				  $charge_amount="";
				  $charge_id="";
				  
				  if($row['is_percent']==1)
				  {
					  $charge_amount=floatval($sub_total * $row['unit_charges']/100);
				  }
				  else
				  {
					  $charge_amount=$row['unit_charges'];
				  }
				  
				   $charges_array=array(
					  'amount'=>$charge_amount,
					);
				
				  $this->db->where('id',$row['id'])->update('invoice_charges',$charges_array);
				  
				  $total_additional_charges=$total_additional_charges+$charge_amount;
			  
		     }
		 }
		 
		 $grand_total=$sub_total + $total_additional_charges;
		 
		 $invoice_array=array(
		  'sub_total'=>$sub_total,
		  'charges_total'=>$total_additional_charges,
		  'grand_total'=>$grand_total,
		 );
		 
	    $success=$this->db->where('id',$invoice_id)->update('invoice',$invoice_array);
		return $success;  
	 }
		
 }
 
 
 public function InsertContactResponse($contact_data_array)
 {
	$error=false;
	$errortext='';
	$result='';
	
	$contact_item=$contact_data_array['contact_item'];
	$account_id=$contact_data_array['account_id'];
	
	if(!empty($contact_item))
	{
		foreach($contact_item as $item)
		{
			
			$email=$item['email'];
			$phone=$item['phone'];
			
			$rs=$this->db->select('*')->where('client_id',$this->Basic_model->unique_id)->where('id',$account_id)->get('account');
			if(!$rs->num_rows()>0)
			{
				$error=true;
				$errortext='Invalid account';
				break;
			}
			
			if(!$error)
			{
				$rs=$this->db->select('*')->where('account_id',$account_id)->where('email',$email)->get('account_contract');
				if($rs->num_rows()>0)
				{
					$error=true;
					$errortext='Email already exist';
					break;
				}
				
				$rs=$this->db->select('*')->where('account_id',$account_id)->where('phone',$phone)->get('account_contract');
				if($rs->num_rows()>0)
				{
					$error=true;
					$errortext='Phone no already exist';
					break;
				}
				
			}
			
			
		}
		
		if(!$error)
		{
			foreach($contact_item as $item)
			{
				$email=$item['email'];
				$phone=$item['phone'];
				$name=$item['name'];
				
				$account_contract=array(
				  'account_id'=>$account_id,
				  'name'=>$name,
				  'email'=>$email,
				  'phone'=>$phone,
			    );
			   $success=$this->db->insert('account_contract',$account_contract);	
			}
			$result['account_id']=$account_id;
			$result['successMessage']='Contact successfully submitted';
		}
		
	}
	else
	{
		$error=true;
		$errortext="No input parameter found";
	}
	 
	return array('error' => $error, 'errortext' => $errortext, 'result' => $result);
 }
 
 
 public function InsertBillingAddress($data_array)
 {
	$error=false;
	$errortext='';
	$result='';
	
	$billing_address_item=$data_array['billing_address_item'];
	$account_id=$data_array['account_id'];
	if(!empty($billing_address_item))
	{
		
		foreach($billing_address_item as $item)
		{
			$rs=$this->db->select('*')->where('client_id',$this->Basic_model->unique_id)->where('id',$account_id)->get('account');
			if(!$rs->num_rows()>0)
			{
				$error=true;
				$errortext='Invalid account';
				break;
			}
			
			
			if(!$error)
			{
				$billing_address_arr=array(
				   'account_id'=>$account_id,
				   'address1'=>$item['address1'],
				   'address2'=>$item['address2'],
				   'city'=>$item['city'],
				   'state'=>$item['state'],
				   'pin'=>$item['pin'],
				   'phone'=>$item['phone'],
				   'fax'=>$item['fax'],
				);
				
				//print_r($billing_address_arr);
				
			   $success=$this->db->insert('billing_address',$billing_address_arr); 
			}
		   	
		}
		$result['account_id']=$account_id;
		$result['successMessage']='Billing address successfully submitted';
		
		
	}
	else
	{
		$error=true;
		$errortext="No input parameter found";
	}
	 
	return array('error' => $error, 'errortext' => $errortext, 'result' => $result);
 }
 
 
 
 public function InsertShippingAddress($data_array)
 {
	$error=false;
	$errortext='';
	$result='';
	
	
	$shipping_address_item=$data_array['shipping_address_item'];
	$account_id=$data_array['account_id'];
	
	if(!empty($shipping_address_item))
	{
		
		foreach($shipping_address_item as $item)
		{
			$rs=$this->db->select('*')->where('client_id',$this->Basic_model->unique_id)->where('id',$account_id)->get('account');
			if(!$rs->num_rows()>0)
			{
				$error=true;
				$errortext='Invalid account';
				break;
			}
			
			if(!$error)
			{
				$billing_address_arr=array(
				   'account_id'=>$account_id,
				   'address_name'=>$item['address_name'],
				   'address1'=>$item['address1'],
				   'address2'=>$item['address2'],
				   'city'=>$item['city'],
				   'state'=>$item['state'],
				   'pin'=>$item['pin'],
				   'phone'=>$item['phone'],
				   'fax'=>$item['fax'],
				);
				
				//print_r($billing_address_arr);
				
			   $success=$this->db->insert('shipping_address',$billing_address_arr); 
			}
		   	
		}
		$result['account_id']=$account_id;
		$result['successMessage']='Shipping address successfully submitted';
		
		
	}
	else
	{
		$error=true;
		$errortext="No input parameter found";
	}
	 
	return array('error' => $error, 'errortext' => $errortext, 'result' => $result);
 }
 
 public function UpdateContactDetailsOnId($post_data)
 {
	 $error=false;
	 $errortext='';
	 $result='';
	 
	 $contact_id=$post_data['contact_id'];
	 $account_id=$post_data['account_id'];
	 $email=$post_data['email'];
	 $phone=$post_data['phone'];
	 $name=$post_data['name'];
	 
	 $rs=$this->db->select('*')->where('account_id',$account_id)->where('id',$contact_id)->get('account_contract');
	 if(!$rs->num_rows()>0)
	 {
		$error=true;
		$errortext='Contact details not found';
	 }
	 if(!$error)
	 {
		 $account_contract=array(
		   'name'=>$name,
		   'email'=>$email,
		   'phone'=>$phone,
		  );
		$success=$this->db->select('*')->where('account_id',$account_id)->where('id',$contact_id)->update('account_contract',$account_contract); 
	    if($success)
		{
		   $result['successMessage']='Data successfully updated';
		}
		else
		{
		    $result['successMessage']='Error in update';
		}
	 
	 }
	 
	 
	 return array('error' => $error, 'errortext' => $errortext, 'result' => $result);
 }
 
 
 
 public function UpdateBillingAddressDetailsOnId($post_data)
 {
	 $error=false;
	 $errortext='';
	 $result='';
	 
	 $billing_address_id=$post_data['billing_address_id'];
	 $account_id=$post_data['account_id'];
	 $address1=$post_data['address1'];
	 $address2=$post_data['address2'];
	 $city=$post_data['city'];
	 $state=$post_data['state'];
	 $pin=$post_data['pin'];
	 $phone=$post_data['phone'];
	 $fax=$post_data['fax'];
	 
	 $rs=$this->db->select('*')->where('account_id',$account_id)->where('id',$billing_address_id)->get('billing_address');
	 if(!$rs->num_rows()>0)
	 {
		$error=true;
		$errortext='Billing address details not found';
	 }
	 if(!$error)
	 {
		 $billing_address=array(
		   'address1'=>$address1,
		   'address2'=>$address2,
		   'city'=>$city,
		   'state'=>$state,
		   'pin'=>$pin,
		   'phone'=>$phone,
		   'fax'=>$fax,
		  );
		$success=$this->db->select('*')->where('account_id',$account_id)->where('id',$billing_address_id)->update('billing_address',$billing_address); 
	    if($success)
		{
		   $result['successMessage']='Data successfully updated';
		}
		else
		{
		    $result['successMessage']='Error in update';
		}
	 
	 }
	 
	 
	 return array('error' => $error, 'errortext' => $errortext, 'result' => $result);
 }
 
 
 
 public function UpdateShippingAddressDetailsOnId($post_data)
 {
	 $error=false;
	 $errortext='';
	 $result='';
	 
	 $shipping_address_id=$post_data['shipping_address_id'];
	 $account_id=$post_data['account_id'];
	 $address_name=$post_data['address_name'];
	 $address1=$post_data['address1'];
	 $address2=$post_data['address2'];
	 $city=$post_data['city'];
	 $state=$post_data['state'];
	 $pin=$post_data['pin'];
	 $phone=$post_data['phone'];
	 $fax=$post_data['fax'];
	 
	 $rs=$this->db->select('*')->where('account_id',$account_id)->where('id',$shipping_address_id)->get('shipping_address');
	 if(!$rs->num_rows()>0)
	 {
		$error=true;
		$errortext='Shipping address details not found';
	 }
	 if(!$error)
	 {
		 $billing_address=array(
		   'address_name'=>$address_name,
		   'address1'=>$address1,
		   'address2'=>$address2,
		   'city'=>$city,
		   'state'=>$state,
		   'pin'=>$pin,
		   'phone'=>$phone,
		   'fax'=>$fax,
		  );
		$success=$this->db->select('*')->where('account_id',$account_id)->where('id',$shipping_address_id)->update('shipping_address',$billing_address); 
	    if($success)
		{
		   $result['successMessage']='Data successfully updated';
		}
		else
		{
		    $result['successMessage']='Error in update';
		}
	 
	 }
	 
	 
	 return array('error' => $error, 'errortext' => $errortext, 'result' => $result);
 }
 
 
 public function DeleteContactDetailsOnId($post_data)
 {
	 $error=false;
	 $errortext='';
	 $result='';
	 
	 $contact_id=$post_data['contact_id'];
	 $account_id=$post_data['account_id'];
	 
	 $rs=$this->db->select('*')->where('account_id',$account_id)->where('id',$contact_id)->get('account_contract');
	 if(!$rs->num_rows()>0)
	 {
		$error=true;
		$errortext='Contact details not found';
	 }
	 if(!$error)
	 {
		$success=$this->db->select('*')->where('account_id',$account_id)->where('id',$contact_id)->delete('account_contract'); 
	    if($success)
		{
		   $result['successMessage']='Data successfully deleted';
		}
		else
		{
		    $result['successMessage']='Error in update';
		}
	 
	 }
	 
	 
	 return array('error' => $error, 'errortext' => $errortext, 'result' => $result);
 }
 
 
 public function DeleteBillingAddressDetailsOnId($post_data)
 {
	 $error=false;
	 $errortext='';
	 $result='';
	 
	 $billing_address_id=$post_data['billing_address_id'];
	 $account_id=$post_data['account_id'];
	 
	 $rs=$this->db->select('*')->where('account_id',$account_id)->where('id',$billing_address_id)->get('billing_address');
	 if(!$rs->num_rows()>0)
	 {
		$error=true;
		$errortext='Billing address details not found';
	 }
	 
	 if(!$error)
	 {
		$success=$this->db->select('*')->where('account_id',$account_id)->where('id',$billing_address_id)->delete('billing_address'); 
	    if($success)
		{
		   $result['successMessage']='Data successfully deleted';
		}
		else
		{
		    $result['successMessage']='Error in update';
		}
	 
	 }
	 
	 
	 return array('error' => $error, 'errortext' => $errortext, 'result' => $result);
 }
 
 
 public function DeleteShippingAddressDetailsOnId($post_data)
 {
	 $error=false;
	 $errortext='';
	 $result='';
	 
	 $shipping_address_id=$post_data['shipping_address_id'];
	 $account_id=$post_data['account_id'];
	 
	 $rs=$this->db->select('*')->where('account_id',$account_id)->where('id',$shipping_address_id)->get('shipping_address');
	 if(!$rs->num_rows()>0)
	 {
		$error=true;
		$errortext='Shipping address details not found';
	 }
	 
	 if(!$error)
	 {
		$success=$this->db->select('*')->where('account_id',$account_id)->where('id',$shipping_address_id)->delete('shipping_address'); 
	    if($success)
		{
		   $result['successMessage']='Data successfully deleted';
		}
		else
		{
		    $result['successMessage']='Error in update';
		}
	 
	 }
	 
	 
	 return array('error' => $error, 'errortext' => $errortext, 'result' => $result);
 }
 
 
 
 public function ContactDetailsOnId($post_data)
 {
	 $error=false;
	 $errortext='';
	 $result='';
	 
	 $account_id=$post_data['account_id'];
	 $sql="Select * from account_contract Where account_id=$account_id";
	 //$rs=$this->db->select('*')->where('account_id',$account_id)->get('account_contract');
	 $rs=$this->db->query($sql);
	 if(!$rs->num_rows()>0)
	 {
		$error=true;
		$errortext='Contact details not found';
	 }
	 else
	 {
		 $result['contact_list']=$rs->result_array();
	 }
	 
	 
	 return array('error' => $error, 'errortext' => $errortext, 'result' => $result);
 }
 
 
 public function BillingAddressListOnId($post_data)
 {
	 $error=false;
	 $errortext='';
	 $result='';
	 
	 $account_id=$post_data['account_id'];
	 $sql="Select * from billing_address Where account_id=$account_id";
	 //$rs=$this->db->select('*')->where('account_id',$account_id)->get('account_contract');
	 $rs=$this->db->query($sql);
	 if(!$rs->num_rows()>0)
	 {
		$error=true;
		$errortext='Billing address list not found';
	 }
	 else
	 {
		 $result['billing_address_list']=$rs->result_array();
	 }
	 
	 
	 return array('error' => $error, 'errortext' => $errortext, 'result' => $result);
 }
 
 
 public function ShippingAddressListOnId($post_data)
 {
	 $error=false;
	 $errortext='';
	 $result='';
	 
	 $account_id=$post_data['account_id'];
	 $sql="Select * from shipping_address Where account_id=$account_id";
	 //$rs=$this->db->select('*')->where('account_id',$account_id)->get('account_contract');
	 $rs=$this->db->query($sql);
	 if(!$rs->num_rows()>0)
	 {
		$error=true;
		$errortext='Shipping address list not found';
	 }
	 else
	 {
		 $result['shipping_address_list']=$rs->result_array();
	 }
	 
	 
	 return array('error' => $error, 'errortext' => $errortext, 'result' => $result);
 }
 
 public function get_session_id()
 {
	$my_session_id='';
	if($this->Basic_model->token_id=="")
	{
		$headers=getallheaders();
		if(isset($headers['Session']))
		{
		   $my_session_id=$headers['Session'];
		}
	}
	
	return $my_session_id;

 }
 
 
 public function GetCartDetails()
 {
	 $cart_details=array();
	 $cart_content=array();
	 
	 $token_id=$this->Basic_model->token_id;
	 $client_id=$this->Basic_model->unique_id;
	 $sub_unique_id=$this->Basic_model->sub_unique_id;
	 
	 if($token_id!="")
	 {
	   $rs=$this->db->where('token_id',$token_id)->where('client_id',$client_id)->where('sub_unique_id',$sub_unique_id)->get('temp_cart');
	 }
	 else
	 {
		 $my_session_id=$this->get_session_id();
		 $rs=$this->db->where('token_id',$my_session_id)->where('client_id',$client_id)->get('temp_cart');
	 }
	 
	 if($rs->num_rows()>0)
	 {
		  $cart_content=$rs->result_array();
	 }
	 
	 $data['cart_content']=$cart_content;
	 $data['order_status']=$this->GetOrderStatus();
	 $data['additonal_charges']=$this->GetChargesData();
	
	 
	 if(!empty($data))
	 {
		$cart_details=$this->ViewFormattedCart($data);
	 }
	
	 return $cart_details;
 }

 public function ViewFormattedCart($data)
 {
	 $cart_content=$data['cart_content'];
	 $additonal_charges=$data['additonal_charges'];
	 $subtotal=0;
	 $total_additional_charges=0;
	 $grand_total=0;
	 $product_details=array();
	 $product_charges=array();
	 $is_percent=array();
	 $unit_charges=array();
	 $formatted_order_details='Cart is empty';
	 
	 //print_r($cart_content);
	 //die();
	 
	 if(!empty($cart_content))
	 {
		 foreach($cart_content as $item)
		 {
			$item_image="";
			$item_name="";
			$sku="";
			$show_item="";
			$qty="";
			$price="";
			$amount="";
			$row_id="";
			$cust_id="";
			$avl_qty="";
			
			
			$product_id=$item['product_id'];
			//$item_image=$this->Common_model->get_single_field_value('products','product_image','id',$product_id);
			if($item_image=="")
			{
				$item_image="Image-not-found.gif";
			}
			
			$avl_qty=$item['avl_qty'];
			$sku=$item['sku_name'];
			
			
			$item_name=$this->Common_model->get_single_field_value('products','product_name','id',$product_id);
			$show_item=$item_name." ( SKU: ".$sku.")";
			
			
			$start_date=$item['start_date'];
			$end_date=$item['end_date'];
			$order_type=$item['product_type'];
			
			$qty=$item['product_qty'];
			$price=$item['product_price'];
			$amount=($qty*$price);
			$subtotal=$subtotal+$amount;
			
			$product_details[]=array(
			 'product_id'=>$product_id,
			 'product_name'=>$item_name,
			 'sku'=>$sku,
			 'avl_qty'=>$avl_qty,
			 'product_sku'=>$show_item,
			 'qty'=>$qty,
			 'price'=>$price,
			 'amount'=>$amount,
			);
			
		}
		
		if(!empty($additonal_charges))
		{
		   foreach($additonal_charges as $row)
		   {
			  $charge_amount="";
			  $charge_id="";
			  
			  $charge_id=$row['id'];
			  if($row['is_percent']==1)
			  {
				  $charge_amount=floatval($subtotal*$row['charge']/100);
			  }
			  else
			  {
				  $charge_amount=$row['charge'];
			  }
			  
			  $total_additional_charges=$total_additional_charges+$charge_amount;
			  
			  $product_charges[]=array(
			   'lable_of_charge'=>$row['lable_of_charge'],
			   'is_percent'=>$row['is_percent'],
			   'unit_charge'=>$row['charge'],
			   'value'=>$charge_amount,
			  );
			  
			
		   }
		}
		
		$grand_total=$subtotal+$total_additional_charges;
		
		
		 $formatted_order_details=array
		 (
		  'order_type'=>$order_type,
		  'start_date'=>$start_date,
		  'end_date'=>$end_date,
		  'product_list'=>$product_details,
		  'sub_total'=>$subtotal, 
		  'charges'=>$product_charges,
		  'charges_total'=>$total_additional_charges, 
		  'grand_total'=>$grand_total,
		);
		
	 }

	return $formatted_order_details;
	 
 }



 public function delete_cart_item($post_data)
 {
	$error='';
	$errortext='';
	$result='';
	
	$sku_name=$post_data['product_sku'];
	
	$check_row_id=$this->CheckRowId($sku_name);
	if($check_row_id==0)
	{
		$error=true;
		$errortext='Product is not available in the cart'; 
	}
	
	if(!$error)
	{
		$token_id=$this->Basic_model->token_id;
		$client_id=$this->Basic_model->unique_id;
	  	$sub_unique_id=$this->Basic_model->sub_unique_id;
		
		if($token_id=="")
		{
			$token_id=$this->get_session_id();
		}
		
	  	$success=$this->db->where('token_id',$token_id)->where('client_id',$client_id)
		->where('sub_unique_id',$sub_unique_id)
		->where('sku_name',$sku_name)->delete('temp_cart'); 
		
		if($success)
		{
		  $message='Item successfully removed';
		  $result['successMessage']=$message;
		}
	}
	
	return array('error' => $error, 'errortext' => $errortext, 'result' => $result); 		
		
 }
  
  public function CheckRowId($sku_name)
  {
	  $flag=0;
	  
	  $client_id=$this->Basic_model->unique_id;
	  $sub_unique_id=$this->Basic_model->sub_unique_id;
	  $token_id=$this->Basic_model->token_id;
	  
	  if($token_id=="")
	  {
		 $token_id=$this->get_session_id(); 
	  }
	   
	  $rs=$this->db->where('token_id',$token_id)->where('client_id',$client_id)
	  ->where('sub_unique_id',$sub_unique_id)->where('sku_name',$sku_name)->get('temp_cart');
	  
	  if($rs->num_rows()>0)
	  {
		  $flag=1;
	  }
	 
	  return $flag;
  }
  
  
  public function update_cart_qty($post_data)
  {
		$error='';
		$errortext='';
		$result='';
		
		$data='';
		$qty=$post_data['qty'];
		$sku_name=$post_data['product_sku'];
		
		$check_row_id=$this->CheckRowId($sku_name);
		if($check_row_id==0)
		{
			$error=true;
			$errortext='Product is not available in the cart'; 
		}
		
		$rs=$this->db->select('*')->where('sku',$sku_name)->where('client_id',$this->Basic_model->unique_id)
		->get('master_stock');
		if(!$rs->num_rows()>0)
		{
			$error=true;
			$errortext='Stock is not available'; 
		}
		
		if($qty <= 0)
		{
			$error=true;
			$errortext='Quantity must be greater than or equal zero'; 
		}
		
		if(!$error)
		{
			 $stock_arr=$rs->row_array();
			 if($qty >$stock_arr['avl_qty'])
			 {
				 $message="Stock is not available";
				 $error=true;
			     $errortext=$message;
			 }
			 else
			 {
				$update_data = array(
				  'sku_name'=>$sku_name,
				  'product_qty'=>$qty
				);
				
				
				$token_id=$this->Basic_model->token_id;
				$client_id=$this->Basic_model->unique_id;
	  			$sub_unique_id=$this->Basic_model->sub_unique_id;
				
				if($token_id=="")
				{
					$token_id=$this->get_session_id();
				}
				
	  			$success=$this->db->where('token_id',$token_id)->where('client_id',$client_id)
				->where('sub_unique_id',$sub_unique_id)->where('sku_name',$sku_name)
				->update('temp_cart',$update_data); 
				
				if($success)
				{
					$message="Item successfully updated";
					$result['successMessage']=$message;
				}
				else
				{
					 $message='Error in update';
					 $error=true;
					 $errortext=$message;
				}
			 }
		}
		
	  return array('error' => $error, 'errortext' => $errortext, 'result' => $result); 	
	}
	
	
  public function update_cart_price_by_date($post_data)
  {
		$error='';
		$errortext='';
		$result='';
		
		$data='';
		$start_date=date("Y-m-d", strtotime($post_data['start_date']));
        $end_date=date("Y-m-d", strtotime($post_data['end_date']));
		
		$day_span=1+floor((abs(strtotime($start_date) - strtotime($end_date))/(60*60*24)));
		
		$token_id=$this->Basic_model->token_id;
		$client_id=$this->Basic_model->unique_id;
		$sub_unique_id=$this->Basic_model->sub_unique_id;
		
		if($token_id=="")
		{
			$token_id=$this->get_session_id();
		}
		
		$rs=$this->db->where('token_id',$token_id)->where('client_id',$client_id)
		->where('sub_unique_id',$sub_unique_id)->get('temp_cart'); 
		if($rs->num_rows()>0)
		{
			$cart_content=$rs->result_array();
			foreach($cart_content as $item)
			{
				$product_id="";
				$product_price="";
				$row_id="";
				$price="";
				
				$product_id=$item['product_id'];
				$product_price=$this->Sop_model->get_rent_product_price($day_span,$product_id);
				$row_id=$item['id'];
				
				$update_data = array(
					'start_date'=> $start_date,
					'end_date'=> $end_date,
					'product_price'=> $product_price
				 );
				 
				 $success=$this->db->where('token_id',$token_id)->where('client_id',$client_id)
				->where('sub_unique_id',$sub_unique_id)->where('id',$row_id)
				->update('temp_cart',$update_data);
			}
			
			if($success)
			{
				$message="Item successfully updated";
				$result['successMessage']=$message;
			}
			else
			{
				 $message='Error in update';
				 $error=true;
				 $errortext=$message;
			}
		}
		else
		{
			$error=true;
			$errortext='Cart is empty';
		}
		

	  return array('error' => $error, 'errortext' => $errortext, 'result' => $result); 	
	}	


 //Incomplete
 public function GetCompleteInvoiceDetailsOnId($invoice_id)
 {
	 $client_id=$this->Basic_model->unique_id;
	 $order_details=array();
	 $sql="SELECT * FROM invoice INNER JOIN product_order ON invoice.order_id=product_order.id WHERE invoice.id=$invoice_id
	      AND invoice.client_id=$client_id AND product_order.offrent_status=1";
	 $rs=$this->db->query($sql);
	 if($rs->num_rows()>0)
	 {
		 
		$order_id='';
		$data['charges_details']=$this->GetChargesDetailsOnId($invoice_id);
		$data['inv_details']=$this->GetInvoiceDetailsOnId($invoice_id);
		$data['orders']=$this->GetOrderOnId($order_id);
		$data['order_details']=$this->GetOrderDetailsOnId($order_id);
		
		$data['category_details']=$this->GetProductCategory();
		//$data['cart_content']=$this->cart->contents();
		//$data['order_status']=$this->GetOrderStatus();
		$data['additonal_charges']=$this->GetChargesData();
		
		if(!empty($data))
		{
			$order_details=$this->FormattedOrderDetails($data);
		}
	 }
	 
	
	return $order_details;
 }




 public function GetProductOrderDetailsOnId($order_id)
 {
	$order_details=array();
	$inv_id=$this->Common_model->get_single_field_value('invoice','id','order_id',$order_id); 
	$data['charges_details']=$this->GetChargesDetailsOnId($inv_id);
	$data['inv_details']=$this->GetInvoiceDetailsOnId($inv_id);
	$data['orders']=$this->GetOrderOnId($order_id);
	$data['order_details']=$this->GetOrderDetailsOnId($order_id);
	$data['order_status']=$this->GetOrderStatus();
	
	$data['category_details']=$this->GetProductCategory();
	//$data['cart_content']=$this->cart->contents();
	//$data['order_status']=$this->GetOrderStatus();
	$data['additonal_charges']=$this->GetChargesData();
	
	if(!empty($data))
	{
		$order_details=$this->FormattedOrderDetails($data);
	}
	
	return $order_details;
 }

 public function FormattedOrderDetails($data)
 {
	 
	 $formatted_order_details=array();
	
	 $order_details=$data['order_details'];
	 $inv_details=$data['inv_details'];
	 $charges_details=$data['charges_details'];
	 $orders=$data['orders'];
	 
	 $order_type=$orders['order_type'];
	 $order_start_date=$orders['order_start_date'];
	 $order_end_date=$orders['order_end_date'];
	 
	 $product_details=array();
	 $product_charges=array();
	 
	 $invoice_date=date_format(date_create($inv_details['date_time']),"d/m/Y");
	 $invoice_id=$inv_details['id'];
	 $order_id=$inv_details['order_id'];
	 $customer_name=$this->Common_model->get_single_field_value('account','name','id',$inv_details['customer_id']);
	 
	 $sub_total=$inv_details['sub_total'];
	 $charges_total=$inv_details['charges_total'];
	 $grand_total=$inv_details['grand_total'];
	 $note=$orders['note'];
	 $db_order_status_id=$orders['order_status'];
	 
	 $order_status_id=$this->Common_model->get_single_field_value('order_status_master','status_text','id',$db_order_status_id);
	 
	 $order_status_text=$this->Common_model->get_single_field_value('status_master','order_status_text','id',$order_status_id);
	 
	 if(!empty($order_details))
	 {  
			foreach($order_details as $item)
			{
				$item_image="";
				$item_name="";
				$sku="";
				$show_item="";
				$qty="";
				$price="";
				$amount="";
				$row_id="";
				$cust_id="";
				$avl_qty="";

				$product_id=$item['product_id'];
				$row_id=$item['id'];
				$sku=$this->Common_model->get_single_field_value('products','sku','id',$product_id);
				
				$base64="";
			    $path = base_url('product_image')."/".$this->GetFirstImage($product_id);
			    if (@fopen($path, "r"))
				{
					  $type = pathinfo($path, PATHINFO_EXTENSION);
					  $data = file_get_contents($path);
					  $base64 = 'data:image/' . $type . ';base64,' . base64_encode($data);
				}
				$item_image=$base64;
				$item_name=$this->Common_model->get_single_field_value('products','product_name','id',$product_id);
				$show_item=$sku;
				
				$qty=$item['qty'];
				$price=$item['rate'];
				$amount=$item['total_rate'];
				
				$product_details[]=array(
				 'order_row_id'=>$row_id,
				 'product_id'=>$product_id,
				 'product_name'=>$item_name,
				 'product_sku'=>$show_item,
				 'qty'=>$qty,
				 'price'=>$price,
				 'amount'=>$amount,
				);
				
			}
			
			
		}
	
	

	if(!empty($charges_details))
	{
	   foreach($charges_details as $row)
	   {
		   $charge_label_id="";
		   $charge_label="";
		   $charge_label_id=$row['charges_id'];
		   $charge_label=$this->Common_model->get_single_field_value('charges','charges','id',$charge_label_id);
		
		   $product_charges[$charge_label]=$row['amount'];
		   
	   }
	}
	
	if($order_type==1)
	{
		$start_date=date("Y-m-d", strtotime(str_replace('-', '/', $order_start_date)));
        $end_date=date("Y-m-d", strtotime(str_replace('-', '/', $order_end_date)));
	}
	else
	{
		$start_date="";
		$end_date="";
	}
	
	
	$formatted_order_details=array
	(
	  'invoice_date'=>$invoice_date,
	  'invoice_id'=>$invoice_id,
	  'order_id'=>$order_id,
	  'order_type'=>$order_type,
	  'start_date'=>$start_date,
	  'end_date'=>$end_date,
	  'customer_name'=>$customer_name,
	  'product_list'=>$product_details,
	  'sub_total'=>$sub_total, 
	  'charges'=>$product_charges,
	  'charges_total'=>$charges_total, 
	  'grand_total'=>$grand_total,
	  'note'=>$note,
	  'status'=>$order_status_text,
	);
	
	
	return $formatted_order_details;
		
 }
 
 public function GetOrderSelfStatusId()
  {
	  $self_id='';
	  $role_id=$this->Basic_model->sub_unique_id;
	  $client_id=$this->Basic_model->unique_id;
		  //$role_id=1;
	  $sql="Select *,order_status_master.id as 'order_status_id' from sub_role_details INNER JOIN role_master ON sub_role_details.role_master_id=role_master.id 
	  INNER JOIN order_status_master ON sub_role_details.id=order_status_master.role INNER JOIN status_master ON order_status_master.status_text=status_master.id 
	  Where role_master.object_id=$client_id AND status_master.is_active=1 And
	  sub_role_details.is_active=1 and role_master.is_active=1 And status_master.client_id=$client_id and sub_role_details.id=$role_id";
	
	  $rs=$this->db->query($sql);
	  if($rs->num_rows()>0)
	  {
		  $self_array=$rs->row_array();
		  $self_id=$self_array['order_status_id'];
	  }
	  
	  return $self_id;
  }
 
 public function GetRecentProductOrderList($offset,$per_page)
 {
	$order_list=array(); 
	
	$get_order_status=$this->GetOrderStatus();
	$self_status_id=$this->GetOrderSelfStatusId();
	 if(!empty($get_order_status))
	  {
		 $order_status_id=0;
		 $order_status_id_raw='';
		 foreach($get_order_status as $item)
		 {
			 if($item['is_changeable']==1 && $item['order_status_id']!=$self_status_id)
			 {
			   $order_status_id_raw.=$item['order_status_id'].',';
			 }
		 }
		 if($order_status_id_raw!="")
		 {
			$order_status_id=rtrim($order_status_id_raw,',');
		 }
		 $client_id=$this->Basic_model->unique_id;
		 $sql="SELECT * FROM invoice INNER JOIN product_order ON invoice.order_id=product_order.id WHERE client_id=$client_id 
		       AND product_order.order_status IN($order_status_id) LIMIT $per_page OFFSET $offset"; 
		 $rs=$this->db->query($sql); 
		 $order_array=$rs->result_array();
		 $order_list=$this->GetFormatProductOrderDetails($order_array);	
	  }
	  
	  return $order_list;
 }
 
 public function GetoffrentSelfStatusId()
  {
	  $self_id='';
	  $role_id=$this->Basic_model->sub_unique_id;
	  $client_id=$this->Basic_model->unique_id;
	
	  $sql="Select *,off_rent_status.id as 'off_rent_status_id' from sub_role_details INNER JOIN role_master ON 
		  sub_role_details.role_master_id=role_master.id INNER JOIN off_rent_status ON sub_role_details.id=off_rent_status.employee_id 
		  INNER JOIN off_rent_status_master ON off_rent_status.master_status_id=off_rent_status_master.id 
		  Where role_master.object_id=$client_id And off_rent_status_master.is_active=1 And sub_role_details.is_active=1 
		  and role_master.is_active=1 And off_rent_status_master.client_id=$client_id and sub_role_details.id=$role_id";

	  $rs=$this->db->query($sql);
	  if($rs->num_rows()>0)
	  {
		  $self_array=$rs->row_array();
		  $self_id=$self_array['off_rent_status_id'];
	  }
	  
	  return $self_id;
  }
  
  
 
  public function GetRecentOffrentList($offset,$per_page)
  {
	  $error='';
	  $errortext='';
	  $result='';  
	  $order_array=array();
	  $offrent_array=array();
	  $get_offrent_status=$this->GetOffrentStatusList();
	  $self_status_id=$this->GetoffrentSelfStatusId();
	  
	  if(!empty($get_offrent_status))
	  {
		 $offrent_status_id=0;
		 $offrent_status_id_raw='';
		 foreach($get_offrent_status as $item)
		 {
			 if($item['is_changeable']==1 && $item['off_rent_status_id']!=$self_status_id)
			 {
			   $offrent_status_id_raw.=$item['off_rent_status_id'].',';
			 }
		 }
		 if($offrent_status_id_raw!="")
		 {
		   $offrent_status_id=rtrim($offrent_status_id_raw,',');
		 }
		 $client_id=$this->Basic_model->unique_id;
		 
		 $sql="SELECT * FROM off_rent WHERE status_id IN($offrent_status_id) LIMIT $per_page OFFSET $offset"; 
		 $rs=$this->db->query($sql); 
		 $order_array=$rs->result_array();	
		 foreach($order_array as $item)
		  {
			  $status_id=$this->Common_model->get_single_field_value('off_rent_status','master_status_id','id',$item['status_id']);
			  $status_text=$this->Common_model->get_single_field_value('off_rent_status_master','order_status_text','id',$status_id);
			  

			  $details=array(
			    'id'=>$item['id'],
			    'date'=>$item['date'],
				'order_id'=>$item['order_id'],
				'customer_name'=>$this->Common_model->get_single_field_value('account','name','id',$item['customer_id']),
				'status'=>$status_text
			   );
			   
			 $offrent_array[]=$details;  
		  }		 
	  }
	  else
	  {
		  $error=true;
		  $errortext='No list found';
	  }
	  
	  return $offrent_array;
  }
  
  public function GetServiceRequestSelfStatusId()
  {
	  $self_id='';
	  $role_id=$this->Basic_model->sub_unique_id;
	  $client_id=$this->Basic_model->unique_id;
		  
		  $sql="Select *,service_request_status.id as 'service_request_status_id' from sub_role_details INNER JOIN role_master ON 
		  sub_role_details.role_master_id=role_master.id INNER JOIN service_request_status ON sub_role_details.id=service_request_status.employee_id 
		  INNER JOIN service_request_status_master ON service_request_status.master_status_id=service_request_status_master.id 
		  Where role_master.object_id=$client_id And service_request_status_master.is_active=1 And sub_role_details.is_active=1 
		  and role_master.is_active=1 And service_request_status_master.client_id=$client_id and sub_role_details.id=$role_id";
		  
		  

	  $rs=$this->db->query($sql);
	  if($rs->num_rows()>0)
	  {
		  $self_array=$rs->row_array();
		  $self_id=$self_array['service_request_status_id'];
	  }
	  
	  return $self_id;
  }
  
  
  public function GetRecentServiceEquipmentList($offset,$per_page)
  {
	  $error='';
	  $errortext='';
	  $result='';  
	  $order_array=array();
	  $service_request_array=array();
	  
	  $get_service_request_status=$this->GetServiceRequestStatusList();
	  $self_status_id=$this->GetServiceRequestSelfStatusId();
	  
	  if(!empty($get_service_request_status))
	  {
		 $service_request_status_id=0;
		 $service_request_status_id_raw='';
		 foreach($get_service_request_status as $item)
		 {
			 if($item['is_changeable']==1 && $item['service_request_status_id']!=$self_status_id)
			 {
			   $service_request_status_id_raw.=$item['service_request_status_id'].',';
			 }
		 }
		 
		 if($service_request_status_id_raw!="")
		 {
		    $service_request_status_id=rtrim($service_request_status_id_raw,',');
		 }
		 $client_id=$this->Basic_model->unique_id;
		 
		 $sql="SELECT * FROM service_request WHERE status_id IN($service_request_status_id) LIMIT $per_page OFFSET $offset"; 
		 $rs=$this->db->query($sql); 
		 $service_request_details=$rs->result_array();	

         foreach($service_request_details as $item)
		  {
			  $status_id=$this->Common_model->get_single_field_value('service_request_status','master_status_id','id',$item['status_id']);
			  $status_text=$this->Common_model->get_single_field_value('service_request_status_master','order_status_text','id',$status_id);
			  
			  $details=array(
			    'id'=>$item['id'],
			    'date'=>$item['date'],
				'order_id'=>$item['order_id'],
				'customer_name'=>$this->Common_model->get_single_field_value('account','name','id',$item['customer_id']),
				'status'=>$status_text
			   );
			   
			 $service_request_array[]=$details;  
		  }
		  
	  }
	  else
	  {
		  $error=true;
		  $errortext='No list found';
	  }
	  
	  return $service_request_array;
  }
  

 public function GetProductOrderDetails($offset,$per_page)
 {
	 $order_details=array();
	 $client_id=$this->Basic_model->unique_id;
	 $search_condition="";
	 $search_cat="";
	 $search_text="";
	 $customer_id="";
	 $condition1="";
	 $condition2="";

	 $order_status_id='';
	 $order_status_id_raw='';
	 $get_order_status=$this->GetOrderStatus();
     if(!empty($get_order_status))
	  {
		 foreach($get_order_status as $item)
		 {
			 $order_status_id_raw.=$item['order_status_id'].',';
			 
		 }
		 $order_status_id=rtrim($order_status_id_raw,',');
	  }
	  
	 if($this->Basic_model->role==4)
	 {
		$customer_id=$this->Basic_model->sub_unique_id;
		$condition1=" product_order.customer_id=$customer_id AND";
	 }
	 else
	 {
		 $condition2=" product_order.order_status IN($order_status_id) AND";
	 }
	 
	 
	 if($this->input->get('search_cat'))
	 {
		 $search_cat="product_order.".$this->input->get('search_cat');
		 $search_text=$this->input->get('search_text');
		 $search_condition=" And $search_cat LIKE '%$search_text%'"; 
	 }
	 
	 if($this->input->get('start_date'))
	 {
		 $start_date=date("Y-m-d", strtotime($this->input->get('start_date')));
		 $end_date=date("Y-m-d", strtotime($this->input->get('end_date')));
		 $start_date_time=$start_date." 00:00:00.000";
		 $end_date_time=$end_date." 23:59:59.997";
		 $search_condition=" AND product_order.date_time between '$start_date_time' and '$end_date_time'";
		 
	 }
	 else
	 {
		 $current_year=date("Y");
	     $start_of_current_financial_year=$current_year."-04-01";
		 $end_of_current_financial_year=($current_year+1)."-03-31";
		 
		 $start_date_time=$start_of_current_financial_year." 00:00:00.000";
		 $end_date_time=$end_of_current_financial_year." 23:59:59.997";
			
		 $search_condition.=" AND product_order.date_time between '$start_date_time' and '$end_date_time'";
	 }
	 
	 if($search_cat=='product_order.customer_id')
	 {
		 $sql="select * from product_order INNER JOIN invoice ON product_order.id=invoice.order_id INNER JOIN account on 
		 invoice.customer_id=account.id where invoice.client_id=$client_id and account.name LIKE '%$search_text%' 
		 AND product_order.offrent_status=0 $condition1 $condition2 order by 
		 product_order.date_time desc LIMIT $per_page OFFSET $offset";
	 }
	 else
	 {
	     $sql="select * from product_order INNER JOIN invoice ON product_order.id=invoice.order_id Where 
		 invoice.client_id=$client_id AND $condition1 $condition2 product_order.offrent_status=0 
		 $search_condition order by product_order.date_time desc LIMIT $per_page OFFSET $offset";
	 }
	 
	 
	 if($this->input->get('status_id'))
	 {
		 $status_id=$this->input->get('status_id');
		 
		 $sql="Select * from invoice INNER JOIN product_order ON invoice.order_id=product_order.id INNER JOIN order_status_master
		  ON product_order.order_status=order_status_master.id INNER JOIN status_master ON order_status_master.status_text=status_master.id
		  Where invoice.client_id=$client_id And status_master.id=$status_id AND product_order.offrent_status=0 
		  order by product_order.date_time desc LIMIT $per_page OFFSET $offset";
	 }
	 
	
	 $rs=$this->db->query($sql);
	 
	// echo $this->db->last_query();
	// die();

	//$rs=$this->db->select('*')->where('client_id',$this->Basic_model->unique_id)->order_by("date_time", "desc")->get('invoice');
	 if($rs->num_rows()>0)
	 {
		  $order_details_raw=$rs->result_array();
		  $order_details=$this->GetFormatProductOrderDetails($order_details_raw);
	 }
	 
	 return $order_details; 
 }
 
 
 
 public function GetInvoiceList($offset,$per_page)
 {
	 $order_details=array();
	 $client_id=$this->Basic_model->unique_id;
	 $search_condition="";
	 $search_cat="";
	 $search_text="";
	 $customer_id="";
	 $condition1="";
	 $condition2="";

	 $order_status_id='';
	 $order_status_id_raw='';
	 $get_order_status=$this->GetOrderStatus();
     if(!empty($get_order_status))
	  {
		 foreach($get_order_status as $item)
		 {
			 $order_status_id_raw.=$item['order_status_id'].',';
			 
		 }
		 $order_status_id=rtrim($order_status_id_raw,',');
	  }
	  
	 if($this->Basic_model->role==4)
	 {
		$customer_id=$this->Basic_model->sub_unique_id;
		$condition1=" product_order.customer_id=$customer_id AND";
	 }
	 else
	 {
		 $condition2=" product_order.order_status IN($order_status_id) AND";
	 }
	 
	 
	 if($this->input->get('search_cat'))
	 {
		 $search_cat="product_order.".$this->input->get('search_cat');
		 $search_text=$this->input->get('search_text');
		 $search_condition=" And $search_cat LIKE '%$search_text%'"; 
	 }
	 
	 if($this->input->get('start_date'))
	 {
		 $start_date=date("Y-m-d", strtotime($this->input->get('start_date')));
		 $end_date=date("Y-m-d", strtotime($this->input->get('end_date')));
		 $start_date_time=$start_date." 00:00:00.000";
		 $end_date_time=$end_date." 23:59:59.997";
		 $search_condition=" AND product_order.date_time between '$start_date_time' and '$end_date_time'";
		 
	 }
	 else
	 {
		 $current_year=date("Y");
	     $start_of_current_financial_year=$current_year."-04-01";
		 $end_of_current_financial_year=($current_year+1)."-03-31";
		 
		 $start_date_time=$start_of_current_financial_year." 00:00:00.000";
		 $end_date_time=$end_of_current_financial_year." 23:59:59.997";
			
		 $search_condition.=" AND product_order.date_time between '$start_date_time' and '$end_date_time'";
	 }
	 
	 if($search_cat=='product_order.customer_id')
	 {
		 $sql="select * from product_order INNER JOIN invoice ON product_order.id=invoice.order_id INNER JOIN account on 
		 invoice.customer_id=account.id where invoice.client_id=$client_id and account.name LIKE '%$search_text%' 
		 AND product_order.offrent_status=1 $condition1 $condition2 order by 
		 product_order.date_time desc LIMIT $per_page OFFSET $offset";
	 }
	 else
	 {
	     $sql="select * from product_order INNER JOIN invoice ON product_order.id=invoice.order_id Where 
		 invoice.client_id=$client_id AND $condition1 $condition2 product_order.offrent_status=1 
		 $search_condition order by product_order.date_time desc LIMIT $per_page OFFSET $offset";
	 }
	 
	 
	 if($this->input->get('status_id'))
	 {
		 $status_id=$this->input->get('status_id');
		 
		 $sql="Select * from invoice INNER JOIN product_order ON invoice.order_id=product_order.id INNER JOIN order_status_master
		  ON product_order.order_status=order_status_master.id INNER JOIN status_master ON order_status_master.status_text=status_master.id
		  Where invoice.client_id=$client_id And status_master.id=$status_id AND product_order.offrent_status=1 
		  order by product_order.date_time desc LIMIT $per_page OFFSET $offset";
	 }
	 
	
	 $rs=$this->db->query($sql);
	 
	// echo $this->db->last_query();
	// die();

	//$rs=$this->db->select('*')->where('client_id',$this->Basic_model->unique_id)->order_by("date_time", "desc")->get('invoice');
	 if($rs->num_rows()>0)
	 {
		  $order_details_raw=$rs->result_array();
		  $order_details=$this->GetFormatProductOrderDetails($order_details_raw);
	 }
	 
	 return $order_details; 
 }
 
 public function GetFormatProductOrderDetails($order_details)
 {
	 $formatted_details=array();
	 if(!empty($order_details))
		{
			foreach($order_details as $item)
			{
				$customer_name='';
				$customer_name=$this->Common_model->get_single_field_value('account','name','id',$item['customer_id']);
				$status_text="";
				$order_status=$this->Common_model->get_single_field_value('product_order','order_status','id',$item['order_id']);;
				$status_id=$this->Common_model->get_single_field_value('order_status_master','status_text','id',$order_status);
				$status_text=$this->Common_model->get_single_field_value('status_master','order_status_text','id',$status_id);
				
				$formatted_details[]=array(
				  'date'=>date_format(date_create($item['date_time']),"d/m/Y"),
				  'invoice_id'=>$item['id'],
				  'order_id'=>$item['order_id'],
				  'customer_name'=>$customer_name,
				  'order_status'=>$status_text,
				);
			}
		}
		
		return $formatted_details;
 }
 
 
  public function GetInvoiceDetailsOnId($inv_id)
  {
	 $invoice_details=array();
	 $rs=$this->db->select('*')->where('client_id',$this->Basic_model->unique_id)->where('id',$inv_id)->get('invoice');
	 
	 if($rs->num_rows()>0)
	 {
		  $invoice_details=$rs->row_array();
	 }
	 
	 return $invoice_details;
  }
  
  
  public function GetChargesDetailsOnId($inv_id)
  {
	 $charges_details=array();
	 $rs=$this->db->select('*')->where('invoice_id',$inv_id)->get('invoice_charges');
	 
	 if($rs->num_rows()>0)
	 {
		  $charges_details=$rs->result_array();
	 }
	 
	 return $charges_details;
  }
  
  
  public function GetOrderDetailsOnId($order_id)
  {
	 $order_details=array();
	 $rs=$this->db->select('*')->where('order_id',$order_id)->get('order_details');
	 
	 if($rs->num_rows()>0)
	 {
		  $order_details=$rs->result_array();
	 }
	 
	 return $order_details;
  }
  
  
  public function  GetOrderOnId($order_id)
  {
	 $order_details=array();
	 $rs=$this->db->select('*')->where('id',$order_id)->get('product_order');
	 
	 if($rs->num_rows()>0)
	 {
		  $order_details=$rs->row_array();
	 }
	 
	 return $order_details;
  }
  
  
  function roleParentChildTree2($parent,$tree = '',$category_tree_array = '')
  {
	  $branch=array();
	  $client_id=$this->Basic_model->unique_id;
	  if (!is_array($category_tree_array))
	  {
		$category_tree_array = array();
	  }
	   $sql="Select *,order_status_master.id as 'order_status_id' from sub_role_details INNER JOIN role_master ON sub_role_details.role_master_id=role_master.id 
	   INNER JOIN order_status_master ON sub_role_details.id=order_status_master.role INNER JOIN status_master ON order_status_master.status_text=status_master.id 
	   Where role_master.object_id=$client_id and sub_role_details.is_active=1 and status_master.is_active=1
	   and role_master.is_active=1 and sub_role_details.report_to=$parent order by sub_role_details.id asc";
			
		//$sql="Select * from sub_role_details Where report_to=$parent order by id asc";	
			
	  $rs=$this->db->query($sql);
	 
	  if($rs->num_rows()>0)
	  { 
	  //$tree .= '<li>';
		 
		  $tree .= '<ul>';
		  $role_array=$rs->result_array();
		  
		  foreach($role_array as $item)
		  {

				$category_tree_array[]= array(
				   "id" => $item['role'] 
				   
				);
			 	$tree .= '<li><span class="folder">'.$item['name'].'</span>';		   
			  $tree = $this->roleParentChildTree2($item['role'],$tree,$category_tree_array);
		  }
		 $tree .= '</ul>';
		$tree .= '</li>';
	  }
	  
	  
	  return $tree;
  }
  
  
  
  function roleParentChildTree($parent, $category_tree_array = '')
  {
	  $branch=array();
	  $client_id=$this->Basic_model->unique_id;
	  if (!is_array($category_tree_array))
	  {
		$category_tree_array = array();
	  }
	   $sql="Select *,order_status_master.id as 'order_status_id' from sub_role_details INNER JOIN role_master ON sub_role_details.role_master_id=role_master.id 
	   INNER JOIN order_status_master ON sub_role_details.id=order_status_master.role INNER JOIN status_master ON order_status_master.status_text=status_master.id 
	   Where role_master.object_id=$client_id and sub_role_details.is_active=1 and status_master.is_active=1
	   and role_master.is_active=1 and sub_role_details.report_to=$parent order by sub_role_details.id asc";
			
		//$sql="Select * from sub_role_details Where report_to=$parent order by id asc";	
			
	  $rs=$this->db->query($sql);
	  if($rs->num_rows()>0)
	  {
		  $role_array=$rs->result_array();
		  foreach($role_array as $item)
		  {
			  $category_tree_array[]= array(
			                   "id" => $item['role'], 
							   "name" => $item['name'],
							   "role_name" => $item['role_name'],
							   "order_status_id" => $item['order_status_id'],
							   "status_text" => $item['order_status_text'],
							   );
			 			   
			  $category_tree_array = $this->roleParentChildTree($item['role'],$category_tree_array);
		  }
	  }
	  
	  return $category_tree_array;
  }
  
 
  
  public function GetOrderStatus()
  {
	  $status_arr=array();
	  $client_id=$this->Basic_model->unique_id;
	  $role_access="";
	  
	  //echo $this->Basic_model->sub_unique_id;
	  //die();
	 
	  if($this->Basic_model->sub_unique_id==0)
	  {
		  //admin
		  $sql="Select *,order_status_master.id as 'order_status_id' from sub_role_details INNER JOIN role_master ON sub_role_details.role_master_id=role_master.id 
	      INNER JOIN order_status_master ON sub_role_details.id=order_status_master.role INNER JOIN status_master ON order_status_master.status_text=status_master.id 
		  Where role_master.object_id=$client_id And status_master.is_active=1 And
	      sub_role_details.is_active=1 and role_master.is_active=1 And status_master.client_id=$client_id order by sub_role_details.id asc";
		
		  $rs=$this->db->query($sql);
				  
				    
		 //echo $this->db->last_query();
		 // die();
		  
				  if($rs->num_rows()>0)
				  {
					  $role_array=$rs->result_array();
					 
					  foreach($role_array as $item)
					  {
						  $status_arr[]= array(
							   "id" => $item['role'], 
							   "name" => $item['name'],
							   "role_name" => $item['role_name'],
							   "order_status_id" => $item['order_status_id'],
							   "is_changeable" => $item['is_changeable'],
							   "status_text" => $item['order_status_text'],
							   );
									   
						 
					  }
				  }
		    
	  }
	  else
	  {
		  $role_id=$this->Basic_model->sub_unique_id;
		  //$role_id=1;
		  $sql="Select *,order_status_master.id as 'order_status_id' from sub_role_details INNER JOIN role_master ON sub_role_details.role_master_id=role_master.id 
		  INNER JOIN order_status_master ON sub_role_details.id=order_status_master.role INNER JOIN status_master ON order_status_master.status_text=status_master.id 
		  Where role_master.object_id=$client_id AND status_master.is_active=1 And
		  sub_role_details.is_active=1 and role_master.is_active=1 And status_master.client_id=$client_id and sub_role_details.id=$role_id";
		   
		   //$sql="Select * from sub_role_details order by id asc";
		  
		  $rs=$this->db->query($sql);
		  $self_array=$rs->row_array();
	
		  $status_arr2=array(
						   "id" => $self_array['role'], 
						   "name" => $self_array['name'],
						   "role_name" => "Self",
						   "order_status_id" => $self_array['order_status_id'],
						   "status_text" => $self_array['order_status_text'],
						   );
		  
		  $status_arr=$this->roleParentChildTree($role_id);
		  
		  array_unshift($status_arr,$status_arr2);
	  }
	
	  return $status_arr;
  }
 public function GetMasterOrderStatus()
 {
	 $order_status_details=array();
	 $rs=$this->db->select('*')->where('client_id',$this->Basic_model->unique_id)->where('is_active',1)->get('status_master');
	 if($rs->num_rows()>0)
	 {
		  $order_status_details=$rs->result_array();
	 }
	 
	 return $order_status_details;
 }
 
 public function GetMasterStatusDetails()
 {
	 $order_status_details=array();
	 $rs=$this->db->select('*')->where('client_id',$this->Basic_model->unique_id)->get('status_master');
	 if($rs->num_rows()>0)
	 {
		  $order_status_details=$rs->result_array();
	 }
	 
	 return $order_status_details;
 }
 
 
 public function GetOffrentMasterStatusList()
 {
	 $offrent_master_status=array();
	 $rs=$this->db->select('*')->where('client_id',$this->Basic_model->unique_id)->get('off_rent_status_master');
	 if($rs->num_rows()>0)
	 {
		  $offrent_master_status=$rs->result_array();
	 }
	 
	 return $offrent_master_status;
 }
 
 public function GetServiceRequesttMasterStatusList()
 {
	 $service_request_master_status=array();
	 $rs=$this->db->select('*')->where('client_id',$this->Basic_model->unique_id)->get('service_request_status_master');
	 if($rs->num_rows()>0)
	 {
		  $service_request_master_status=$rs->result_array();
	 }
	 
	 return $service_request_master_status;
 }
  
 public function GetOrderStatusDetails()
 {
	 $order_status_details=array();
	 $client_id=$this->Basic_model->unique_id;
	 $status_details=array();
	 
	 $sql="Select * from status_master INNER JOIN  order_status_master ON status_master.id=order_status_master.status_text  
	       Where status_master.client_id=$client_id";
	 
	 //$rs=$this->db->select('*')->where('client_id',$this->Basic_model->unique_id)->get('order_status_master');
	 $rs=$this->db->query($sql);
	 if($rs->num_rows()>0)
	 {
		  
		  $order_status_details=$rs->result_array();
		  if(!empty($order_status_details))
		  {
			   foreach($order_status_details as $item)
			   {
				   $role_name="";
				   $role_name=$this->Common_model->get_single_field_value('sub_role_details','name','id',$item['role']);
				   
				   $status_details[]=array(
				     'id'=>$item['id'],
				     'role_name'=>$role_name,
				     'status'=>$item['order_status_text'],
					 'is_changeable'=>$item['is_changeable'],
					 'is_active'=>$item['is_active'],
				   );
			   }
		  }
		  
	 }
	 
	 return $status_details;
 }
 
 public function GetOffrentStatusList()
 {
	 $order_status_details=array();
	 $client_id=$this->Basic_model->unique_id;
	 $status_details=array();
	 
	 $sql="Select *,off_rent_status.id as 'off_rent_status_id' from off_rent_status_master INNER JOIN  off_rent_status ON off_rent_status_master.id=off_rent_status.master_status_id  
	       Where off_rent_status_master.client_id=$client_id";
	 
	 //$rs=$this->db->select('*')->where('client_id',$this->Basic_model->unique_id)->get('order_status_master');
	 $rs=$this->db->query($sql);
	 if($rs->num_rows()>0)
	 {
		  
		  $offrent_status_details=$rs->result_array();
		  if(!empty($offrent_status_details))
		  {
			   foreach($offrent_status_details as $item)
			   {
				   $role_name="";
				   $role_name=$this->Common_model->get_single_field_value('sub_role_details','name','id',$item['employee_id']);
				   
				   $status_details[]=array(
				     'id'=>$item['id'],
				     'role_name'=>$role_name,
				     'status'=>$item['order_status_text'],
					 'off_rent_status_id'=>$item['off_rent_status_id'],
					 'is_changeable'=>$item['is_changeable'],
					 'is_active'=>$item['is_active'],
				   );
			   }
		  }
		  
	 }
	 
	 return $status_details;
 }
 
 
 public function GetServiceRequestStatusList()
 {
	 $order_status_details=array();
	 $client_id=$this->Basic_model->unique_id;
	 $status_details=array();
	 
	 $sql="Select *,service_request_status.id as 'service_request_status_id' from service_request_status_master INNER JOIN service_request_status ON service_request_status_master.id=service_request_status.master_status_id  
	       Where service_request_status_master.client_id=$client_id";
	 
	 //$rs=$this->db->select('*')->where('client_id',$this->Basic_model->unique_id)->get('order_status_master');
	 $rs=$this->db->query($sql);
	
	 if($rs->num_rows()>0)
	 {
		  
		  $offrent_status_details=$rs->result_array();
		  if(!empty($offrent_status_details))
		  {
			   foreach($offrent_status_details as $item)
			   {
				   $role_name="";
				   $role_name=$this->Common_model->get_single_field_value('sub_role_details','name','id',$item['employee_id']);
				   
				   $status_details[]=array(
				     'id'=>$item['id'],
				     'role_name'=>$role_name,
				     'status'=>$item['order_status_text'],
					 'service_request_status_id'=>$item['service_request_status_id'],
					 'is_changeable'=>$item['is_changeable'],
					 'is_active'=>$item['is_active'],
				   );
			   }
		  }
		  
	 }
	 
	 return $status_details;
 }
 
 
 
 public function GetOrderStatusDetailsOnId($id)
 {
	 $order_status_details=array();
	 $rs=$this->db->select('*')->where('id',$id)->get('order_status_master');
	 
	 if($rs->num_rows()>0)
	 {
		  $order_status_details=$rs->row_array();
	 }
	 
	 return $order_status_details;
 }
 
 public function GetMasterOrderStatusDetailsOnId($status_id)
 {
	 $master_status_details=array();
	 $rs=$this->db->select('*')->where('id',$status_id)->get('status_master');
	 if($rs->num_rows()>0)
	 {
		  $master_status_details=$rs->row_array();
	 }
	 
	 return $master_status_details;
 }
  
 public function InsertMasterOrderStatus($post_data)
 {
	$error='';
	$errortext='';
	$result='';

	$status=$post_data['status'];
	$client_id=$this->Basic_model->unique_id;
	$rs=$this->db->select('*')->where('client_id',$client_id)->where('order_status_text',$status)->get('status_master');
	if($rs->num_rows()>0)
	{
		$error=true;
		$errortext='Status already exist';
	}
	
	if(!$error)
	{
		 if($post_data['is_changeable']=='true')
		 {
			 $is_changeable=1;
		 }
		 else
		 {
			 $is_changeable=0;
		 }
		 
		 
		 if($post_data['is_active']=='true')
		 {
			 $is_active=1;
		 }
		 else
		 {
			 $is_active=0;
		 }
		
		
		  $insert_arr=array
		   (
			 'client_id'=>$client_id,
			 'order_status_text'=>$status,
			 'is_changeable'=>$is_changeable,
			 'is_active'=>$is_active,
		   );
		   
		   $success=$this->db->insert('status_master',$insert_arr);
		   if($success)
		   {
		    $result['successMessage']="Data successfully inserted";
		   }
		   else
		   {
			   $error=true;
	           $errortext='Insert error';
		   }
	}
	
	return array('error' => $error, 'errortext' => $errortext, 'result' => $result);
	
 }
 
 public function InsertMasterOffrentStatus($post_data)
 {
	$error='';
	$errortext='';
	$result='';

	$status=$post_data['status'];
	$client_id=$this->Basic_model->unique_id;
	$rs=$this->db->select('*')->where('client_id',$client_id)->where('order_status_text',$status)->get('off_rent_status_master');
	if($rs->num_rows()>0)
	{
		$error=true;
		$errortext='Status already exist';
	}
	
	if(!$error)
	{
		
		 if($post_data['is_changeable']=='true')
		 {
			 $is_changeable=1;
		 }
		 else
		 {
			 $is_changeable=0;
		 }
		 
		 
		 if($post_data['is_active']=='true')
		 {
			 $is_active=1;
		 }
		 else
		 {
			 $is_active=0;
		 }
		
		
		
		  $insert_arr=array
		   (
			 'client_id'=>$client_id,
			 'order_status_text'=>$status,
			 'is_changeable'=>$is_changeable,
			 'is_active'=>$is_active,
		   );
		   
		   $success=$this->db->insert('off_rent_status_master',$insert_arr);
		   if($success)
		   {
		    $result['successMessage']="Data successfully inserted";
		   }
		   else
		   {
			   $error=true;
	           $errortext='Insert error';
		   }
	}
	
	return array('error' => $error, 'errortext' => $errortext, 'result' => $result);
	
 }
 
 
 public function InsertMasterServiceRequestStatus($post_data)
 {
	$error='';
	$errortext='';
	$result='';

	$status=$post_data['status'];
	$client_id=$this->Basic_model->unique_id;
	$rs=$this->db->select('*')->where('client_id',$client_id)->where('order_status_text',$status)->get('service_request_status_master');
	if($rs->num_rows()>0)
	{
		$error=true;
		$errortext='Status already exist';
	}
	
	if(!$error)
	{
		
		 if($post_data['is_changeable']=='true')
		 {
			 $is_changeable=1;
		 }
		 else
		 {
			 $is_changeable=0;
		 }
		 
		 
		 if($post_data['is_active']=='true')
		 {
			 $is_active=1;
		 }
		 else
		 {
			 $is_active=0;
		 }
		
		
		
		  $insert_arr=array
		   (
			 'client_id'=>$client_id,
			 'order_status_text'=>$status,
			 'is_changeable'=>$is_changeable,
			 'is_active'=>$is_active,
		   );
		   
		   $success=$this->db->insert('service_request_status_master',$insert_arr);
		   if($success)
		   {
		    $result['successMessage']="Data successfully inserted";
		   }
		   else
		   {
			   $error=true;
	           $errortext='Insert error';
		   }
	}
	
	return array('error' => $error, 'errortext' => $errortext, 'result' => $result);
	
 }
 
 
 
 public function InsertOrderStatus($post_data)
 {
	$error='';
	$errortext='';
	$result='';
	
	$role=$post_data['employee_id'];
	$status=$post_data['status_id'];
	$client_id=$this->Basic_model->unique_id;
	
	$rs=$this->db->select('*')->where('id',$status)->get('status_master');
	if(!$rs->num_rows()>0)
	{
		$error=true;
		$errortext='Status not found';
	}
	
	$rs=$this->db->select('*')->where('id',$role)->get('sub_role_details');
	if(!$rs->num_rows()>0)
	{
		$error=true;
		$errortext='Role not found';
	}
	
	
	if(!$error)
	{ 
		$sql="Select * from status_master INNER JOIN order_status_master ON status_master.id=order_status_master.status_text  
		Where status_master.client_id=$client_id And order_status_master.role=$role";
		
		$rs=$this->db->query($sql);
		if($rs->num_rows()>0)
		 {
			$error=true;
			$errortext='Status already exist';
		 }
	}
	 
	 
	 if(!$error)
	 {
	   $insert_arr=array
	   (
		 'role'=>$role,
		 'status_text'=>$status,
	   );
	   
	   $success=$this->db->insert('order_status_master',$insert_arr);
	   if($success)
	   {
		$result['successMessage']="Data successfully inserted";
	   }
	   else
	   {
		   $error=true;
		   $errortext='Insert error';
	   }
	 }
	
	return array('error' => $error, 'errortext' => $errortext, 'result' => $result);   
 }
 
 
 public function InsertOffrentStatus($post_data)
 {
	$error='';
	$errortext='';
	$result='';
	
	$role=$post_data['employee_id'];
	$status=$post_data['status_id'];
	$client_id=$this->Basic_model->unique_id;
	 
	$sql="Select * from off_rent_status_master INNER JOIN off_rent_status ON off_rent_status_master.id=off_rent_status.master_status_id  
	Where off_rent_status_master.client_id=$client_id And off_rent_status.employee_id=$role";
	
	$rs=$this->db->query($sql);
	
	if($rs->num_rows()>0)
	 {
		$error=true;
	    $errortext='Status already exist';
	 }
	 else
	 {
		   $insert_arr=array
		   (
			 'employee_id'=>$role,
			 'master_status_id'=>$status,
		   );
		   
		   $success=$this->db->insert('off_rent_status',$insert_arr);
		   if($success)
		   {
		    $result['successMessage']="Data successfully inserted";
		   }
		   else
		   {
			   $error=true;
	           $errortext='Insert error';
		   }
		   
	 }
	  
	return array('error' => $error, 'errortext' => $errortext, 'result' => $result);   
 }
  
  
  public function InsertServiceStatus($post_data)
 {
	$error='';
	$errortext='';
	$result='';
	
	$role=$post_data['role'];
	$status=$post_data['status_id'];
	$client_id=$this->Basic_model->unique_id;
	 
	$sql="Select * from service_request_status_master INNER JOIN service_request_status ON service_request_status_master.id=service_request_status.master_status_id  
	Where service_request_status_master.client_id=$client_id And service_request_status.employee_id=$role";
	$rs=$this->db->query($sql);
	if($rs->num_rows()>0)
	 {
		$error=true;
	    $errortext='Status already exist';
	 }
	 else
	 {
		   $insert_arr=array
		   (
			 'employee_id'=>$role,
			 'master_status_id'=>$status,
		   );
		   
		   $success=$this->db->insert('service_request_status',$insert_arr);
		   if($success)
		   {
		    $result['successMessage']="Data successfully inserted";
		   }
		   else
		   {
			   $error=true;
	           $errortext='Insert error';
		   }
		   
	 }
	  
	return array('error' => $error, 'errortext' => $errortext, 'result' => $result);   
 }
  
  
 public function UpdateMasterOrderStatus($post_data)
 {
	$error='';
	$errortext='';
	$result='';

	$status=$post_data['status'];
	$status_id=$post_data['status_id'];
	$client_id=$this->Basic_model->unique_id;
	
	$rs=$this->db->select('*')->where('client_id',$client_id)->where('id',$status_id)->get('status_master');
	if(!$rs->num_rows()>0)
	{
		$error=true;
		$errortext='Invalid status id';
	}
	
	if(!$error)
	{
		$rs=$this->db->select('*')->where('id!=',$status_id)->where('client_id',$client_id)->where('order_status_text',$status)->get('status_master');
		if($rs->num_rows()>0)
		{
			$error=true;
			$errortext='Status already exist';
		}
	}
	
	if(!$error)
	{
		
		if($post_data['is_changeable']=='true')
		 {
			 $is_changeable=1;
		 }
		 else
		 {
			 $is_changeable=0;
		 }
		 
		 
		 if($post_data['is_active']=='true')
		 {
			 $is_active=1;
		 }
		 else
		 {
			 $is_active=0;
		 }
		
		
		  $insert_arr=array
		   (
			 'order_status_text'=>$status,
			 'is_changeable'=>$is_changeable,
			 'is_active'=>$is_active,
		   );
		   
		   $success=$this->db->where('id',$status_id)->update('status_master',$insert_arr);
		   if($success)
		   {
		    $result['successMessage']="Data successfully updated";
		   }
		   else
		   {
			   $error=true;
	           $errortext='Insert error';
		   }
	}
	
	return array('error' => $error, 'errortext' => $errortext, 'result' => $result);
	
 }
 
 
 public function UpdateMasterOffrentStatus($post_data)
 {
	$error='';
	$errortext='';
	$result='';

	$status=$post_data['status'];
	$status_id=$post_data['status_id'];
	
	$client_id=$this->Basic_model->unique_id;
	$rs=$this->db->select('*')->where('id!=',$status_id)->where('client_id',$client_id)->where('order_status_text',$status)->get('off_rent_status_master');
	if($rs->num_rows()>0)
	{
		$error=true;
		$errortext='Status already exist';
	}
	
	if(!$error)
	{
		
		  if($post_data['is_changeable']=='true')
		 {
			 $is_changeable=1;
		 }
		 else
		 {
			 $is_changeable=0;
		 }
		 
		 
		 if($post_data['is_active']=='true')
		 {
			 $is_active=1;
		 }
		 else
		 {
			 $is_active=0;
		 }
		
		
		  $insert_arr=array
		   (
			 'order_status_text'=>$status,
			 'is_changeable'=>$is_changeable,
			 'is_active'=>$is_active,
		   );
		   
		   $success=$this->db->where('id',$status_id)->update('off_rent_status_master',$insert_arr);
		   if($success)
		   {
		    $result['successMessage']="Data successfully updated";
		   }
		   else
		   {
			   $error=true;
	           $errortext='Insert error';
		   }
	}
	
	return array('error' => $error, 'errortext' => $errortext, 'result' => $result);
	
 }
 
 
 public function UpdateMasterServiceRequestStatus($post_data)
 {
	$error='';
	$errortext='';
	$result='';

	$status=$post_data['status'];
	$status_id=$post_data['status_id'];
	
	$client_id=$this->Basic_model->unique_id;
	$rs=$this->db->select('*')->where('id!=',$status_id)->where('client_id',$client_id)->where('order_status_text',$status)->get('service_request_status_master');
	if($rs->num_rows()>0)
	{
		$error=true;
		$errortext='Status already exist';
	}
	
	if(!$error)
	{
		
		  if($post_data['is_changeable']=='true')
		 {
			 $is_changeable=1;
		 }
		 else
		 {
			 $is_changeable=0;
		 }
		 
		 
		 if($post_data['is_active']=='true')
		 {
			 $is_active=1;
		 }
		 else
		 {
			 $is_active=0;
		 }
		
		
		  $insert_arr=array
		   (
			 'order_status_text'=>$status,
			 'is_changeable'=>$is_changeable,
			 'is_active'=>$is_active,
		   );
		   
		   $success=$this->db->where('id',$status_id)->update('service_request_status_master',$insert_arr);
		   if($success)
		   {
		    $result['successMessage']="Data successfully updated";
		   }
		   else
		   {
			   $error=true;
	           $errortext='Insert error';
		   }
	}
	
	return array('error' => $error, 'errortext' => $errortext, 'result' => $result);
	
 }
 
 
  
  public function UpdateOrderStatus($post_data)
  {
	
	$error='';
	$errortext='';
	$result='';
	
	$role=$post_data['employee_id'];
	$status=$post_data['status_id'];
	$status_id=$post_data['order_status_id']; 
	$client_id=$this->Basic_model->unique_id;
	
	$rs=$this->db->select('*')->where('id',$status_id)->get('order_status_master');
	if(!$rs->num_rows()>0)
	{
		$error=true;
		$errortext='Order status not found';
	}
	
	
	if(!$error)
	{
		$rs=$this->db->select('*')->where('id',$status)->get('status_master');
		if(!$rs->num_rows()>0)
		{
			$error=true;
			$errortext='Status not found';
		}
		
		$rs=$this->db->select('*')->where('id',$role)->get('sub_role_details');
		if(!$rs->num_rows()>0)
		{
			$error=true;
			$errortext='Role not found';
		}
	}
	
	if(!$error)
	{
		$sql="Select * from status_master INNER JOIN order_status_master ON status_master.id=order_status_master.status_text  
		Where status_master.client_id=$client_id And order_status_master.role=$role And order_status_master.id!=$status_id";
				
		$rs=$this->db->query($sql);
		if($rs->num_rows()>0)
		 {
			$error=true;
			$errortext='Status already exist';
		 }
	}
	 
	 
	 if(!$error)
	 {
	   $insert_arr=array
	   (
		 'role'=>$role,
		 'status_text'=>$status,
	   );
	   
	   $success=$this->db->where('id',$status_id)->update('order_status_master',$insert_arr);
	   if($success)
	   {
		$result['successMessage']="Data successfully updated";
	   }
	   else
	   {
		   $error=true;
		   $errortext='Insert error';
	   }
		   
	 }
	  
	return array('error' => $error, 'errortext' => $errortext, 'result' => $result);   
   
  }
  
  
  public function UpdateOffrentStatus($post_data)
  {
	$error='';
	$errortext='';
	$result='';
	
	
	$role=$post_data['employee_id'];
	$status=$post_data['status_id'];
	$status_id=$post_data['offrent_status_id'];
	 
	$client_id=$this->Basic_model->unique_id;
	$sql="Select * from off_rent_status_master INNER JOIN off_rent_status ON off_rent_status_master.id=off_rent_status.master_status_id  
	Where off_rent_status_master.client_id=$client_id And off_rent_status.employee_id=$role And off_rent_status.id!=$status_id";
			
	  $rs=$this->db->query($sql);
	
	if($rs->num_rows()>0)
	 {
		$error=true;
	    $errortext='Status already exist';
	 }
	 else
	 {
		   $insert_arr=array
		   (
			 'employee_id'=>$role,
			 'master_status_id'=>$status,
		   );
		   
		   $success=$this->db->where('id',$status_id)->update('off_rent_status',$insert_arr);
		  
		   if($success)
		   {
		    $result['successMessage']="Data successfully updated";
		   }
		   else
		   {
			   $error=true;
	           $errortext='Insert error';
		   }
		   
	 }
	  
	return array('error' => $error, 'errortext' => $errortext, 'result' => $result);   
   
  }
  
  
  public function UpdateServiceRequestStatus($post_data)
  {
	$error='';
	$errortext='';
	$result='';
	
	$role=$post_data['role'];
	$status=$post_data['status_id'];
	$status_id=$post_data['service_status_id'];
	 
	$client_id=$this->Basic_model->unique_id;
	$sql="Select * from service_request_status_master INNER JOIN service_request_status ON service_request_status_master.id=service_request_status.master_status_id  
	Where service_request_status_master.client_id=$client_id And service_request_status.employee_id=$role And service_request_status.id!=$status_id";
			
	  $rs=$this->db->query($sql);
	
	if($rs->num_rows()>0)
	 {
		$error=true;
	    $errortext='Status already exist';
	 }
	 else
	 {
		   $insert_arr=array
		   (
			 'employee_id'=>$role,
			 'master_status_id'=>$status,
		   );
		   
		   $success=$this->db->where('id',$status_id)->update('service_request_status',$insert_arr);
		  
		   if($success)
		   {
		    $result['successMessage']="Data successfully updated";
		   }
		   else
		   {
			   $error=true;
	           $errortext='Insert error';
		   }
		   
	 }
	  
	return array('error' => $error, 'errortext' => $errortext, 'result' => $result);   
   
  }
  
  public function GetSubmitOrderStatus($order_id)
  {
	  $order_status=array();
	  $client_id=$this->Basic_model->unique_id;
	  $sql="Select * from product_order INNER JOIN order_status_master ON product_order.order_status=order_status_master.id
	  		INNER JOIN status_master ON order_status_master.status_text=status_master.id Where product_order.id=$order_id And status_master.client_id=$client_id";
			
	  $rs=$this->db->query($sql);
	  if($rs->num_rows()>0)
	  {
		  $order_status=$rs->row_array();
	  }
	  
	  return $order_status;  		
  }
  
  
  public function UpdateProductOrderStatus($post_data,$order_id)
  {
	  
	$customer_id=$post_data['customer_id'];
	$subtotal=$post_data['subtotal'];
	$product_id=$post_data['product_id'];
	$product_rate=$post_data['product_rate'];
	$product_qty=$post_data['qty'];
	$product_amount=$post_data['product_amount'];
	$charges_total=$post_data['total_additional_charges'];
	$grand_total=$post_data['grand_total'];
	
	$charges_id=array();
	if(!empty($post_data['charges_id']))
	{
	 $charges_id=$post_data['charges_id'];
	}
	
	$charges_amount=array();
	if(!empty($post_data['charges_id']))
	{
	 $charges_amount=$post_data['charges_amount'];
	}
	
	    $note=$post_data['note'];
		$order_status=$post_data['status_id'];
		$sku_arr=$post_data['sku'];
		$avl_qty=$post_data['avl_qty'];

	   $success=0;
	   $order_status=$post_data['status_id'];
		$order_array=array(
		  'order_total'=>$subtotal,
		  'order_status'=>$order_status,
		  'note'=>$note
		);
	
	   $this->db->where('id',$order_id)->update('product_order',$order_array);
	   
	   $order_status_log_array=array(
		  'client_id'=>$this->Basic_model->unique_id,
		  'order_id'=>$order_id,
		  'role_id'=>$this->Basic_model->sub_unique_id,
		  'order_status_id'=>$order_status,
		);
		
		//echo '<pre>',print_r($order_array);
		$this->db->insert('order_status_log',$order_status_log_array);
		
		
		$rs=$this->db->select('*')->where('order_id',$order_id)->get('order_details');
	    if($rs->num_rows()>0)
		{
			$order_details=$rs->result_array();
			foreach($order_details as $item)
			{
				$avl_qty="";
				$sku_no=$this->Common_model->get_single_field_value('products','sku','id',$item['product_id']);
				
				$rs=$this->db->select('*')->where('client_id',$this->Basic_model->unique_id)->where('sku',$sku_no)->get('master_stock');
				if($rs->num_rows()>0)
				{
					$stock_arr=$rs->row_array();
					$avl_qty=$stock_arr['avl_qty'];
				}
				
				$new_qty=$avl_qty+$item['qty'];
				
		
				$update_arr=array(
				 'avl_qty'=>$new_qty
				);
				
				$success=$this->db->where('client_id',$this->Basic_model->unique_id)->where('sku',$sku_no)
				->update('master_stock',$update_arr);
			}
			
		}
		
		$this->db->select('*')->where('order_id',$order_id)->delete('order_details');
		
		$product_count=count($product_id);
		for($i=0;$i<=$product_count-1;$i++)
		{
			 $new_qty=0;
			 $sku_no="";
			 $avl_qty="";
			 $order_details_array=array(
			  'order_id'=>$order_id,
			  'product_id'=>$product_id[$i],
			  'qty'=>$product_qty[$i],
			  'rate'=>$product_rate[$i],
			  'total_rate'=>$product_amount[$i],
			 );
			 
			 //echo '<pre>',print_r($order_details_array);
			$this->db->insert('order_details',$order_details_array);
			
		    $sku_no=$sku_arr[$i];
			$client_id=$this->Basic_model->unique_id;
			$sql="SELECT * FROM master_stock WHERE client_id = $client_id AND sku = '$sku_no'";
			$rs=$this->db->query($sql);
			
			//echo $this->db->last_query();
			//die();
			if($rs->num_rows()>0)
			{
				$stock_arr=$rs->row_array();
				$avl_qty=$stock_arr['avl_qty'];
			}
			
			$new_qty=$avl_qty-$product_qty[$i];
			
			$update_arr=array(
			 'avl_qty'=>$new_qty
			);
			
			$success=$this->db->where('client_id',$this->Basic_model->unique_id)->where('sku',$sku_no)
					->update('master_stock',$update_arr);
			
		}
		
		$invoice_id=$this->Common_model->get_single_field_value('invoice','id','order_id',$order_id);
		
		$invoice_array=array(
		  'sub_total'=>$subtotal,
		  'charges_total'=>$charges_total,
		  'grand_total'=>$grand_total,
		 );
		 
		 //echo '<pre>',print_r($invoice_array);
	    $this->db->where('id',$invoice_id)->update('invoice',$invoice_array);
		
		$this->db->select('*')->where('invoice_id',$invoice_id)->delete('invoice_charges');
		
		if(!empty($charges_id))
		 {
		   $charges_count=count($charges_id);
			for($i=0;$i<=$charges_count-1;$i++)
			{
				 $charges_array=array(
				  'invoice_id'=>$invoice_id,
				  'charges_id'=>$charges_id[$i],
				  'amount'=>$charges_amount[$i],
				 );
				 
				 //echo '<pre>',print_r($charges_array);
				$this->db->insert('invoice_charges',$charges_array);
			}
		 }
		
		$success=$this->cart->destroy();
		
		if($success)
		{
			$success=1;
		}
		
		return $success;
  }
  
  
  public function GetMonthlyReport($input_array)
  {
	  $client_id=$this->Basic_model->unique_id;
	  $report_details=array();
	  $account_id=$input_array['account_id'];
	  $start_date=date("Y-m-d",strtotime($input_array['start_date']));
	  $end_date=date("Y-m-d", strtotime($input_array['end_date']));
	 
	  $start_date_time=$start_date." 00:00:00.000";
	  $end_date_time=$end_date." 23:59:59.997";
	  
	  $sql="Select MONTH(invoice.date_time) As 'current_month',YEAR(invoice.date_time) As 'current_year' FROM invoice INNER JOIN
	  		account ON invoice.customer_id=account.id WHERE (invoice.date_time BETWEEN '$start_date_time' AND '$end_date_time')
			AND invoice.customer_id=$account_id AND invoice.client_id=$client_id GROUP BY MONTH(invoice.date_time)
			ORDER BY MONTH(invoice.date_time) desc ";
			
	  $rs=$this->db->query($sql);	
	  $result_month=$rs->result_array();
	 
	  $total_value=0;
	  foreach($result_month as $item)
	  {
		  $result_start_date='';
		  $result_end_date='';
		  $result_start_date=$item['current_year'].'-'.$item['current_month'].'-01';
		  $result_end_date=date('Y-m-t', strtotime($result_start_date));

		  $invoice_start_date=date("Y-m-d",strtotime($result_start_date));
	 	  $invoice_end_date=$result_end_date;
		 
		  $invoice_start_time=$invoice_start_date." 00:00:00.000";
		  $invoice_end_date_time=$invoice_end_date." 23:59:59.997";
		  
		 $sql="Select products.product_name,products.sku,products.product_price,SUM(order_details.qty) as 'total_qty',
		      SUM(order_details.total_rate) as 'total_price' 
		  from invoice INNER JOIN order_details ON invoice.order_id=order_details.order_id INNER JOIN products ON 
		  order_details.product_id=products.id WHERE (invoice.date_time BETWEEN '$invoice_start_time' AND 
		  '$invoice_end_date_time') AND invoice.client_id=$client_id AND invoice.customer_id=$account_id GROUP BY products.product_name ORDER BY 
		  products.product_name asc";
		  
		 /* $sql="Select *
		  from invoice INNER JOIN order_details ON invoice.order_id=order_details.order_id INNER JOIN products ON 
		  order_details.product_id=products.id WHERE (invoice.date_time BETWEEN '$invoice_start_time' AND 
		  '$invoice_end_date_time') AND invoice.client_id=$client_id AND invoice.customer_id=$account_id";*/

		  $rs2=$this->db->query($sql);	
	      $order_details=$rs2->result_array();
		  
		  // echo $this->db->last_query();
		  
		  
		  //echo '<pre>',print_r($order_details);
	      //die();
		  
		  $total_product=0;
		  foreach($order_details as $row)
		  {
			   $total_product=$total_product+$row['total_price'];
		  }
		  $total_value=$total_value+$total_product;
		  
		  $report_details[]=array(
		   'month'=>date("F", mktime(0, 0, 0, $item['current_month'], 10)),
		   'product_details'=>$order_details
		  );
		
	  }
	  
	 $report_details=array('total_value'=>$total_value,'report_details'=>$report_details);
	 
	 return $report_details;
	  
  }
  
   public function GetLastFinancialYearReportData($account_id)
  {
	  $start_date='';
	  $end_date='';
	  $current_date=date("Y-m-d");
	  $current_year=date("Y");
	  
	  $start_of_last_financial_year=($current_year-1)."-04-01";
	  $end_of_last_financial_year=($current_year)."-03-31";
	  
	  $input_array['account_id']=$account_id;
	  $input_array['start_date']=$start_of_last_financial_year;
	  $input_array['end_date']=$end_of_last_financial_year;
	  
	  $current_year_report=$this->GetMonthlyReport($input_array);
	  
	  
	  //echo '<pre>',print_r($current_year_report);
	  //die();
	  
	  return $current_year_report;
	 
	  
  }
  
  public function GetCurrentFinancialYearReportData($account_id)
  {
	  $start_date='';
	  $end_date='';
	  $current_date=date("Y-m-d");
	  $current_year=date("Y");
	  $start_of_current_financial_year=$current_year."-04-01";
	  
	  if($this->input->get('start_date'))
	  {
		  $start_date=$this->input->get('start_date'); 
	  }
	  else
	  {
		  $start_date=$start_of_current_financial_year;
	  }
	  
	  
	  if($this->input->get('end_date'))
	  {
		  $end_date=$this->input->get('end_date'); 
	  }
	  else
	  {
		  $end_date=$current_date;
	  }
	  
	  $start_of_last_financial_year=($current_year-1)."-04-01";
	  $end_of_last_financial_year=($current_year)."-03-31";
	  
	  $input_array['account_id']=$account_id;
	  $input_array['start_date']=$start_date;
	  $input_array['end_date']=$end_date;
	  
	  $current_year_report=$this->GetMonthlyReport($input_array);
	  
	  $current_year_report['start_date']=$start_date;
	  $current_year_report['end_date']=$end_date;
	  //echo '<pre>',print_r($current_year_report);
	  //die();
	  
	  return $current_year_report;
	   
  }
  
  
  public function GetInvoiceChargesList()
  {
	  $charges_arry=array();
	  $client_id=$this->Basic_model->unique_id;
	  $sql="SELECT charges.charges,charges.id FROM invoice INNER JOIN invoice_charges ON invoice.id=invoice_charges.invoice_id 
	  INNER JOIN charges ON invoice_charges.charges_id=charges.id WHERE invoice.client_id=$client_id 
	  GROUP BY charges.charges ORDER BY charges.charges";
	  
	  $rs=$this->db->query($sql);
	  if($rs->num_rows()>0)
	  {
		  $charges_arry=$rs->result_array();
	  }
	  
	  return $charges_arry;
		  
  }
  
  public function GetChargesReport($post_data)
  {
	  $charge_amount=0;
	  $start_date=date("Y-m-d",strtotime($post_data['start_date']));
	  $end_date=date("Y-m-d", strtotime($post_data['end_date']));
	  $start_date_time=$start_date." 00:00:00.000";
	  $end_date_time=$end_date." 23:59:59.997";
	  $charges=$post_data['label_charge'];
	  
	  $charges_arry=array();
	  $client_id=$this->Basic_model->unique_id;
	  $sql="SELECT SUM(invoice_charges.amount) as 'total_charges_amount' FROM invoice INNER JOIN invoice_charges ON 
	  invoice.id=invoice_charges.invoice_id INNER JOIN charges ON invoice_charges.charges_id=charges.id WHERE 
	  invoice.client_id=$client_id AND invoice.date_time BETWEEN '$start_date_time' and '$end_date_time'AND 
	  charges.charges='$charges'";
	  
	  $rs=$this->db->query($sql);
	  //echo $this->db->last_query();
	  
	  if($rs->num_rows()>0)
	  {
		  $charges_arry=$rs->row_array();
		  $charge_amount=$charges_arry['total_charges_amount'];
	  }
	  
	  return $charge_amount;	  
  }
  
  
 public function GetOffRentList($offset,$perpage)
 {
	 $offrent_details=array();
	 $offrent_array=array();
	 $client_id=$this->Basic_model->unique_id;
	 $search_condition="";
	 $search_category="";
	 $search_text="";
	 
	 $customer_search="";
	 $customer_search2="";
	 if($this->Basic_model->role==4)
	 {
		$customer_id=$this->Basic_model->sub_unique_id;
		$customer_search=" AND customer_id=$customer_id";
		$customer_search2=" AND off_rent.customer_id=$customer_id";
	 }
	 
	 if($this->input->get('start_date'))
	 {
		 $start_date=$this->Basic_model->mysql_input_format($this->input->get('start_date'));
	     $end_date=$this->Basic_model->mysql_input_format($this->input->get('end_date'));
		 $start_date_time=$start_date." 00:00:00.000";
		 $end_date_time=$end_date." 23:59:59.997";
		 $search_condition=" AND date between '$start_date_time' and '$end_date_time'"; 
	 }
	 
	 if($this->input->get('search_cat'))
	 {
		 $search_category=$this->input->get('search_cat');
		 $search_text=$this->input->get('search_text');
		 if($search_category!='customer_id')
		 {
			 $search_condition.=" AND $search_category LIKE '%$search_text%'";
		 }
	 }
	 
	 $sql="SELECT * FROM off_rent WHERE client_id=$client_id $search_condition $customer_search";
	 
	 if($search_category=='customer_id')
	 {
	   $sql="SELECT * FROM off_rent INNER JOIN account ON off_rent.customer_id=account.id WHERE 
	   off_rent.client_id=$client_id $customer_search2 AND account.name LIKE '%$search_text%'";
	 }
	 
	 
	 $limit_query=" LIMIT $offset, $perpage";
	 $sql2=$sql.$limit_query;
	 
	 $rs=$this->db->query($sql2);
	 //echo $this->db->last_query();
	 //die();
	 
	 if($rs->num_rows()>0)
	 {
		  
		  $offrent_details=$rs->result_array();
		  foreach($offrent_details as $item)
		  {
			  $status_id=$this->Common_model->get_single_field_value('off_rent_status','master_status_id','id',$item['status_id']);
			  $status_text=$this->Common_model->get_single_field_value('off_rent_status_master','order_status_text','id',$status_id);
			  

			  $details=array(
			    'id'=>$item['id'],
			    'date'=>$item['date'],
				'order_id'=>$item['order_id'],
				'customer_name'=>$this->Common_model->get_single_field_value('account','name','id',$item['customer_id']),
				'status'=>$status_text
			   );
			   
			 $offrent_array[]=$details;  
		  }
	 }
	 
	 return $offrent_array;
	 
 }
 
 
 public function GetServiceRequestList($offset,$perpage)
 {
	 $service_request_details=array();
	 $service_request_array=array();
	 $client_id=$this->Basic_model->unique_id;
	 $search_condition="";
	 $search_category="";
	 $search_text="";
	 
	 $customer_search="";
	 $customer_search2="";
	 if($this->Basic_model->role==4)
	 {
		$customer_id=$this->Basic_model->sub_unique_id;
		$customer_search=" AND customer_id=$customer_id";
		$customer_search2=" AND service_request.customer_id=$customer_id";
	 }
	 
	 if($this->input->get('start_date'))
	 {
		 $start_date=$this->Basic_model->mysql_input_format($this->input->get('start_date'));
	     $end_date=$this->Basic_model->mysql_input_format($this->input->get('end_date'));
		 $start_date_time=$start_date." 00:00:00.000";
		 $end_date_time=$end_date." 23:59:59.997";
		 $search_condition=" AND date between '$start_date_time' and '$end_date_time'"; 
	 }
	 
	 if($this->input->get('search_cat'))
	 {
		 $search_category=$this->input->get('search_cat');
		 $search_text=$this->input->get('search_text');
		 if($search_category!='customer_id')
		 {
			 $search_condition.=" AND $search_category LIKE '%$search_text%'";
		 }
	 }
	 
	 $sql="SELECT * FROM service_request WHERE client_id=$client_id $search_condition $customer_search";
	 
	 if($search_category=='customer_id')
	 {
	   $sql="SELECT * FROM service_request INNER JOIN account ON off_rent.customer_id=account.id WHERE 
	   off_rent.client_id=$client_id $customer_search2 AND account.name LIKE '%$search_text%'";
	 }
	 
	 
	 $limit_query=" LIMIT $offset, $perpage";
	 $sql2=$sql.$limit_query;
	 
	 $rs=$this->db->query($sql2);
	 //echo $this->db->last_query();
	 //die();
	 
	 if($rs->num_rows()>0)
	 {
		  
		  $service_request_details=$rs->result_array();
		  foreach($service_request_details as $item)
		  {
			  $status_id=$this->Common_model->get_single_field_value('service_request_status','master_status_id','id',$item['status_id']);
			  $status_text=$this->Common_model->get_single_field_value('service_request_status_master','order_status_text','id',$status_id);
			  
			  $details=array(
			    'id'=>$item['id'],
			    'date'=>$item['date'],
				'order_id'=>$item['order_id'],
				'customer_name'=>$this->Common_model->get_single_field_value('account','name','id',$item['customer_id']),
				'status'=>$status_text
			   );
			   
			 $service_request_array[]=$details;  
		  }
	 }
	 
	 return $service_request_array;
	 
 }
 
 
 public function GetServiceRequestDetails($id)
 {
	$service_request_details=array(); 
	$rs=$this->db->select('*')->where('service_request_id',$id)->get('service_request_item');
	 if($rs->num_rows()>0)
	 {
		 $service_request_details=$rs->result_array();
	 }
	 
	 return $service_request_details;
 }
 
 public function CompleteOrderOperation($order_id,$offrent_id)
 {
	 $permission=0;
	 $customer_condition='';
	 	 
	 $status_id=$this->Common_model->get_single_field_value('off_rent','status_id','id',$offrent_id);
	 $db_status_id=$this->Common_model->get_single_field_value('off_rent_status','master_status_id','id',$status_id);
	 $is_changeable=$this->Common_model->get_single_field_value('off_rent_status_master','is_changeable','id',$db_status_id);
	 if($is_changeable==0)
	 {
	   $permission=1;
	 }	
	 
	 return $permission;
 }
 
 
 
 public function CompleteServiceRequestOperation($order_id,$service_request_id)
 {
	 $permission=0;
	 $customer_condition='';
	 
		$status_id=$this->Common_model->get_single_field_value('service_request','status_id','id',$service_request_id);
		$db_status_id=$this->Common_model->get_single_field_value('service_request_status','master_status_id','id',$status_id);
		$is_changeable=$this->Common_model->get_single_field_value('service_request_status_master','is_changeable','id',$db_status_id);
		if($is_changeable==0)
		{
		   $permission=1;
		}	
	
	 return $permission;
 }
 
 
 public function GetAvailableOffrentQuantity($post_data)
 {
	 $response=0;
	 $client_id=$this->Basic_model->unique_id;
	 $order_id=$post_data['order_id'];
	 $product_id=$post_data['product_id'];
	 $order_qty='';
	 $offrent_qty='';
	 
	 $rs=$this->db->select('*')->where('product_id',$product_id)->where('order_id',$order_id)->get('order_details');
	 if($rs->num_rows()>0)
	 {
		 $order_arr=$rs->row_array();
		 $order_qty=$order_arr['qty'];
	 }
	 
	 $sql="SELECT * FROM off_rent INNER JOIN offrent_details ON off_rent.id=offrent_details.off_rent_id WHERE 
	 off_rent.order_id=$order_id AND offrent_details.product_id=$product_id AND off_rent.client_id=$client_id";
	 $rs=$this->db->query($sql);
	 if($rs->num_rows()>0)
	 {
		$offrent_qty=0;
		$offrent_array=$rs->result_array();
		foreach($offrent_array as $item)
		{
			$offrent_qty=$offrent_qty+$item['qty'];
		}

	 }
	 
	 $response=($order_qty-$offrent_qty);
	 
	 return $response;
	  
  }
 
 public function OffrentProductList($post_data)
 {
	$error='';
	$errortext='';
	$result='';
	
	$products=array();
	
	$client_id=$this->Basic_model->unique_id;
	$order_id=$post_data['order_id'];
	
	if(!$error)
	 {
		 $rs=$this->db->select('*')->where('order_id',$order_id)->get('order_details');
		 if(!$rs->num_rows()>0)
		 {
			$error=true;
			$errortext='Invalid order';
		 }
	 }
	 
	 if($this->Basic_model->role==4)
	 {
	   $customer_id=$this->Basic_model->sub_unique_id;
	   $rs=$this->db->select('*')->where('customer_id',$customer_id)->where('id',$order_id)->get('product_order');
	   if(!$rs->num_rows()>0)
	   {
		  $error=true;
		  $errortext='Invalid order';
	   }
		
	 }
	
	if(!$error)
	{
		$sql="SELECT *,products.id as 'product_id' FROM order_details INNER JOIN products ON order_details.product_id=products.id WHERE 
		order_details.order_id=$order_id AND products.is_active=1 AND products.client_id=$client_id";
		$rs=$this->db->query($sql);
		if($rs->num_rows()>0)
		{
			   $offrent_product_details=$rs->result_array();
			   foreach($offrent_product_details as $item)
			   {
				   $post_data['order_id']=$order_id;
	 			   $post_data['product_id']=$item['product_id'];
	 
				   $avl_qty=$this->GetAvailableOffrentQuantity($post_data);
				   
				   $products[]=array(
					 'product_id'=>$item['product_id'],
					 'sku'=>$item['sku'],
					 'product_name'=>$item['product_name'],
					 'order_qty'=>$item['qty'],
					 'avl_qty'=>$avl_qty,
					 'product_number'=>$item['product_number'],
					 'product_description'=>$item['product_description'],
				   );
			   }
			   
			   $result['products']=$products;
		}
		
	}
	
	return array('error' => $error, 'errortext' => $errortext, 'result' => $result); 
 }
 
 
 public function ServiceRequestProductList($post_data)
 {
	$error='';
	$errortext='';
	$result='';
	
	$products=array();
	
	$client_id=$this->Basic_model->unique_id;
	$order_id=$post_data['order_id'];
	
		$sql="SELECT *,products.id as 'product_id' FROM order_details INNER JOIN products ON order_details.product_id=products.id WHERE 
		order_details.order_id=$order_id AND products.is_active=1";
		$rs=$this->db->query($sql);
		if($rs->num_rows()>0)
		{
			   $offrent_product_details=$rs->result_array();
			   foreach($offrent_product_details as $item)
			   {
				   $post_data['order_id']=$order_id;
	 			   $post_data['product_id']=$item['product_id'];
	 
				   $avl_qty=$this->GetAvailableOffrentQuantity($post_data);
				   
				   $products[]=array(
					 'product_id'=>$item['product_id'],
					 'sku'=>$item['sku'],
					 'product_name'=>$item['product_name'],
					 'order_qty'=>$item['qty'],
					 'avl_qty'=>$avl_qty,
					 'product_number'=>$item['product_number'],
					 'product_description'=>$item['product_description'],

				   );
			   }
			   
			   $result['products']=$products;
		}
		
	
	
	return array('error' => $error, 'errortext' => $errortext, 'result' => $result); 
 }
 
 
 public function ServiceProductList($post_data)
 {
	$error=false;
	$errortext='';
	$result='';
	
	$products=array();
	
	$client_id=$this->Basic_model->unique_id;
	$order_id=$post_data['order_id'];
	
	if(!$error)
	 {
		 $rs=$this->db->select('*')->where('order_id',$order_id)->get('order_details');
		 if(!$rs->num_rows()>0)
		 {
			$error=true;
			$errortext='Invalid order';
		 }
	 }
	 
	 if($this->Basic_model->role==4)
	 {
	   $customer_id=$this->Basic_model->sub_unique_id;
	   $rs=$this->db->select('*')->where('customer_id',$customer_id)->where('id',$order_id)->get('product_order');
	   if(!$rs->num_rows()>0)
	   {
		  $error=true;
		  $errortext='Invalid order';
	   }
		
	 }
	if(!$error)
	{
		$sql="SELECT *,products.id as 'product_id' FROM order_details INNER JOIN products ON order_details.product_id=products.id WHERE 
		order_details.order_id=$order_id AND products.is_active=1 AND products.client_id=$client_id";
		$rs=$this->db->query($sql);
		if($rs->num_rows()>0)
		{
			   $offrent_product_details=$rs->result_array();
			   foreach($offrent_product_details as $item)
			   {
				   $post_data['order_id']=$order_id;
	 			   $post_data['product_id']=$item['product_id'];
	 
				   $avl_qty=$this->GetAvailableOffrentQuantity($post_data);
				   
				   if($avl_qty > 0)
				   {
					   $products[]=array(
						 'product_id'=>$item['product_id'],
						 'sku'=>$item['sku'],
						 'product_name'=>$item['product_name'],
						 'product_number'=>$item['product_number'],
						 'product_description'=>$item['product_description'],
					   );
				   }
			   }
			   
			   $result['products']=$products;
		}
		
	}
	
	return array('error' => $error, 'errortext' => $errortext, 'result' => $result); 
 }
 
 
 public function InsertDataToTempOffrent($post_data)
 {
	 $error=false;
	 $errortext='';
	 $result='';
	 
	 $client_id=$this->Basic_model->unique_id;
	 $product_id=$post_data['product_id'];
	 $order_id=$post_data['order_id'];
	 $qty=$post_data['qty'];
	 $offrent_qty='';
	 $order_qty='';
	 
	 $post_end_date=date($this->Basic_model->mysql_dateformat, strtotime($post_data['end_date']));
	 
	 if(!$error)
	 {
		 $rs=$this->db->select('*')->where('order_id',$order_id)->get('order_details');
		 if(!$rs->num_rows()>0)
		 {
			$error=true;
			$errortext='Invalid order';
		 }
	 }
	 
	 if($this->Basic_model->role==4)
	 {
	   $customer_id=$this->Basic_model->sub_unique_id;
	   $rs=$this->db->select('*')->where('customer_id',$customer_id)->where('id',$order_id)->get('product_order');
	   if(!$rs->num_rows()>0)
	   {
		  $error=true;
		  $errortext='Invalid order';
	   }
		
	 }
	 
	 if(!$error)
	 {
		 $avl_qty=$this->GetAvailableOffrentQuantity($post_data);
		 if($avl_qty<$qty)
		 {
			 $error=true;
			 $errortext='Invalid quantity';
		 }
	 }
	 if(!$error)
	 {
		 $rs=$this->db->select('*')->where('order_id',$order_id)->where('product_id',$product_id)->get('order_details');
		 if(!$rs->num_rows()>0)
		 {
			$error=true;
			$errortext='Invalid product id';
		 }
	 }

	 
	 if(!$error)
	 {
		 $rs=$this->db->select('*')->where('client_id',$client_id)->where('order_id',$order_id)->where('product_id',$product_id)->get('offrent_temp');
		 if($rs->num_rows()>0)
		 {
			$error=true;
			$errortext='Product is already selected';
		 }
	 }
	 
	 
	 if(!$error)
	 {
		$rs=$this->db->select('*')->where('order_id',$order_id)->where('product_id',$product_id)->get('order_details');
		if($rs->num_rows()>0)
		{
			$order_array=$rs->row_array();
			$order_start_date=date($this->Basic_model->mysql_dateformat, strtotime($order_array['order_start_date']));
			
		}
		
		$start_date=date_create($order_start_date);
		$end_date=date_create($post_end_date);
		$diff=date_diff($start_date,$end_date);
		$day_difference=$diff->format("%R%a");
		if($day_difference[0]=="+")
		 {
			$day=$day_difference[1];
			if($day==0)
			{
				$error=true;
				$errortext='Order end date must be greater than order start date';
			}
		 }
		 else
		 {
			$error=true;
			$errortext='Order end date must be greater than order start date';
			
		 }
		
	 }
	 
	 if(!$error)
	 {
		 $temp_offrent_array=array(
		   'client_id'=>$client_id,
		   'order_id'=>$order_id,
		   'order_start_date'=>$this->Basic_model->mysql_db_format($order_array['order_start_date']),
		   'order_end_date'=>$this->Basic_model->mysql_db_format($post_data['end_date']),
		   'product_id'=>$product_id,
		   'avl_qty'=>$avl_qty,
		   'qty'=>$qty,
		 );
		 
		
		 $success=$this->db->insert('offrent_temp',$temp_offrent_array);
		 $result['successMessage']='Successfully submitted';
	 }
	 
	 return array('error' => $error, 'errortext' => $errortext, 'result' => $result); 
	  
  }
 
 
 public function randomString($length = 5) 
 {
	$str = "";
	$characters = array_merge(range('A','Z'), range('a','z'), range('0','9'));
	$max = count($characters) - 1;
	for ($i = 0; $i < $length; $i++) {
		$rand = mt_rand(0, $max);
		$str .= $characters[$rand];
	}
	return $str;
 } 
 
 
 public function upload_image($base64Image,$temp_file_path)
 {
	 $image_name=$this->randomString().".jpg";
	 $temp_file_path=$temp_file_path.$image_name;
	 file_put_contents($temp_file_path, base64_decode($base64Image));
	 $image_info = getimagesize($temp_file_path); 
	 $_FILES['userfile'] = array(
		 'name' => uniqid().'.'.preg_replace('!\w+/!', '', $image_info['mime']),
		 'tmp_name' => $temp_file_path,
		 'size'  => filesize($temp_file_path),
		 'error' => UPLOAD_ERR_OK,
		 'type'  => $image_info['mime'],
	 );
	 
	 return $image_name;
 }
 
 public function UploadProductImage($post_data)
 {
	 $error=false;
	 $errortext='';
	 $result='';
	 $image_name=array();
	 $image_arr=array();
	
	 if(isset($post_data['image']))
	 {
	   $image_arr=$post_data['image'];
	 }
	 
	 if(!empty($image_arr))
	 {
		 foreach($image_arr as $item)
		 {
			 
			 if (preg_match('`^[a-zA-Z0-9+/]+={0,2}$`', $item['encode_image']))
			 {
				 $error=true;
				 $errortext='Invalid base64 format';
				 break;
			 }
			
		 }
	 }
	 
	 
	 if(!$error)
	 {
	   if(!empty($image_arr))
	   {
		 foreach($image_arr as $item)
		 {
			 $image_encodeing = explode('base64,', $item['encode_image']);
			 $base64Image=$image_encodeing[1];
			 $temp_file_path="./product_image/";
			 $get_image_name=$this->upload_image($base64Image,$temp_file_path);
			 $image_name[]=$get_image_name;
		 }
		 
		 $result['upload_image']=$image_name;
		 $result['successMessage']='Image successfully uploaded';
		 
	   }
	   else
	   {
		   $error=true;
		   $errortext='Image array required';
	   }
	 }
	 
return array('error' => $error, 'errortext' => $errortext, 'result' => $result); 
 }
 
 
 public function UploadServiceImage($post_data)
 {
	 $error=false;
	 $errortext='';
	 $result='';
	 $image_name=array();
	 $image_arr=array();
	
	 if(isset($post_data['image']))
	 {
	   $image_arr=$post_data['image'];
	 }
	
	 if(!empty($image_arr))
	 {
		 foreach($image_arr as $item)
		 {
			 
			 if (preg_match('`^[a-zA-Z0-9+/]+={0,2}$`', $item['encode_image']))
			 {
				 $error=true;
				 $errortext='Invalid base64 format';
				 break;
			 }
			
		 }
	 }
	 
	 
	 if(!$error)
	 {
	   if(!empty($image_arr))
	   {
		 foreach($image_arr as $item)
		 {
			 $image_encodeing = explode('base64,', $item['encode_image']);
			 $base64Image=$image_encodeing[1];
			 $temp_file_path="./service_image/";
			 $get_image_name=$this->upload_image($base64Image,$temp_file_path);
			 $image_name[]=$get_image_name;
		 }
		 
		 $result['upload_image']=$image_name;
		 $result['successMessage']='Image successfully uploaded';
		 
	   }
	   else
	   {
		   $error=true;
		   $errortext='Image array required';
	   }
	 }
	 
return array('error' => $error, 'errortext' => $errortext, 'result' => $result); 
 }
 
 
 public function UploadProductImageName($post_data)
 {
	 $error=false;
	 $errortext='';
	 $result='';
	 $image_name=array();
	 $image_arr=array();
	 
	
	 $product_id=$post_data['product_id'];
	 if(isset($post_data['image_name']))
	 {
	   $image_arr=$post_data['image_name'];
	 }
	 
	 $rs=$this->db->select('*')->where('id',$product_id)->get('products');
	 if(!$rs->num_rows()>0)
	 {
		$error=true;
		$errortext='Invalid product id';
	 }
	 
	 if(!$error)
	 {
	   if(!empty($image_arr))
	   {
		 foreach($image_arr as $item)
		 {
			 $image_array=array(
			   'product_id'=>$product_id,
			   'image_name'=>$item['image_name'],
		     );
			 
			$success=$this->db->insert('product_images',$image_array); 
			 
		 }
	   }
	   else
	   {
		   $service_image_array=array(
			   'product_id'=>$product_id,
			   'image_name'=>"no_product_01.png",
		     );
			 
			$success=$this->db->insert('product_images',$image_array);
	   }
	   
	   $result['successMessage']='Image successfully submitted';
	 }
	 
return array('error' => $error, 'errortext' => $errortext, 'result' => $result); 
 }
 
 public function GetProductImageName($post_data)
 {
	 $error=false;
	 $errortext='';
	 $result='';
	 $image_name=array();
	 $image_arr=array();
	 
	 $product_id=$post_data['product_id'];
	 
	 $rs=$this->db->select('*')->where('id',$product_id)->get('products');
	 if(!$rs->num_rows()>0)
	 {
		$error=true;
		$errortext='Invalid product id';
	 }
	 
	 if(!$error)
	 {
	   $rs=$this->db->select('id,image_name')->where('product_id',$product_id)->get('product_images');
	   if($rs->num_rows()>0)
	   {
			$image_list=$rs->result_array();
			foreach($image_list as $item)
			{
				$base64 ="";
				$image_name=$item['image_name'];
				$path = base_url("product_image/$image_name");
				if (@fopen($path, "r"))
				{
					$type = pathinfo($path, PATHINFO_EXTENSION);
					$data = file_get_contents($path);
					$base64 = 'data:image/' . $type . ';base64,' . base64_encode($data);
				}
			

				$image_list_array[]=array('id'=>$item['id'],'image'=>$base64);
			}

			$result['image_list']=$image_list_array;
	   }
	   
	   
	 }
	 
return array('error' => $error, 'errortext' => $errortext, 'result' => $result); 
 }
 
 
 public function DeleteProductImageName($post_data)
 {
	 $error=false;
	 $errortext='';
	 $result='';
	 $image_name=array();
	 $image_arr=array();
	 
	 $product_id=$post_data['product_id'];
	 
	 $rs=$this->db->select('*')->where('id',$product_id)->get('products');
	 if(!$rs->num_rows()>0)
	 {
		$error=true;
		$errortext='Invalid product id';
	 }
	 
	 if(!$error)
	 {
	   $rs=$this->db->where('product_id',$product_id)->delete('product_images');
	   $result['successMessage']='Successfully deleted';
	   
	 }
	 
return array('error' => $error, 'errortext' => $errortext, 'result' => $result); 
 }
 
 
 public function InsertDataToTempServiceRequest($post_data)
 {
	 $error=false;
	 $errortext='';
	 $result='';
	
	 
	 $client_id=$this->Basic_model->unique_id;
	 $product_id=$post_data['product_id'];
	 $order_id=$post_data['order_id'];
	 
	 $image_arr=array();
	 if(isset($post_data['image_name']))
	 {
	   $image_arr=$post_data['image_name'];
	 }
	 
	 $offrent_qty='';
	 $order_qty='';
	 
	
	 if(!$error)
	 {
		 $rs=$this->db->select('*')->where('order_id',$order_id)->get('order_details');
		 if(!$rs->num_rows()>0)
		 {
			$error=true;
			$errortext='Invalid order';
		 }
	 }
	 
	 if($this->Basic_model->role==4)
	 {
	   $customer_id=$this->Basic_model->sub_unique_id;
	   $rs=$this->db->select('*')->where('customer_id',$customer_id)->where('id',$order_id)->get('product_order');
	   if(!$rs->num_rows()>0)
	   {
		  $error=true;
		  $errortext='Invalid order';
	   }
		
	 }
	 
	 
	 if(!$error)
	 {
		 $rs=$this->db->select('*')->where('order_id',$order_id)->where('product_id',$product_id)->get('order_details');
		 if(!$rs->num_rows()>0)
		 {
			$error=true;
			$errortext='Invalid product id';
		 }
	 }
 
	 if(!$error)
	 {
		 $rs=$this->db->select('*')->where('client_id',$client_id)->where('order_id',$order_id)->where('product_id',$product_id)->get('service_request_temp');
		 if($rs->num_rows()>0)
		 {
			$error=true;
			$errortext='Product is already selected';
		 }
	 }
	 
	 if(!$error)
	 {
		 $sql="SELECT * FROM service_request INNER JOIN service_request_item ON service_request.id=service_request_item.service_request_id 
		 WHERE service_request.client_id=$client_id AND service_request.order_id=$order_id AND service_request_item.product_id=$product_id";
		 $rs=$this->db->query($sql);
		 if($rs->num_rows()>0)
		 {
			 $service_arr=$rs->row_array();
			 $status_id=$this->Common_model->get_single_field_value('service_request_status_master','is_changeable','id',$service_arr['status_id']);
			 if($status_id!=0)
			 {
				$error=true;
				$errortext='Product is already assign for service';
			 }
		 }
	 }
	
	 if(!$error)
	 {
	   if(!empty($image_arr))
	   {
		 foreach($image_arr as $item)
		 {
			 $service_image_array=array(
			   'product_id'=>$product_id,
			   'order_id'=>$order_id,
			   'image_name'=>$item->image_name,
		     );
			 
			$success=$this->db->insert('service_equipment_image',$service_image_array); 
		 }
	   }
		
		  $temp_offrent_array=array(
		   'client_id'=>$client_id,
		   'order_id'=>$order_id,
		   'product_id'=>$product_id,
		 );
		 
		 $success=$this->db->insert('service_request_temp',$temp_offrent_array);
		 $result['successMessage']='Successfully submitted';
	 }
	 
	 return array('error' => $error, 'errortext' => $errortext, 'result' => $result); 
	  
  } 
  
  
  
  public function GetOffrentTempList($post_data)
  {
	  $offrent_temp=array();
	  $order_id=$post_data['order_id'];
	  $client_id=$this->Basic_model->unique_id;
	  
	  if($this->Basic_model->role==4)
	  {
		   $customer_id=$this->Basic_model->sub_unique_id;
		   $rs=$this->db->select('*')->where('customer_id',$customer_id)->where('id',$order_id)->get('product_order');
		   if($rs->num_rows()>0)
		   {
			  $rs=$this->db->select('*')->where('client_id',$client_id)->where('order_id',$order_id)->get('offrent_temp');
			  if($rs->num_rows()>0)
			  {
				$offrent_temp=$rs->result_array();
			  }
		   }
		
	  }
	  else
	  {
		  $rs=$this->db->select('*')->where('client_id',$client_id)->where('order_id',$order_id)->get('offrent_temp');
		  if($rs->num_rows()>0)
		  {
			$offrent_temp=$rs->result_array();
		  }
	  }
	  
	  
	  
	  return $offrent_temp;
	  
  }
  
  public function GetServiceTempList($post_data)
  {
	  $offrent_temp=array();
	  $order_id=$post_data['order_id'];
	  $client_id=$this->Basic_model->unique_id;
	  
	 if($this->Basic_model->role==4)
	 {
	   $customer_id=$this->Basic_model->sub_unique_id;
	   $rs=$this->db->select('*')->where('customer_id',$customer_id)->where('id',$order_id)->get('product_order');
	   if($rs->num_rows()>0)
	   {
		  $rs=$this->db->select('*')->where('client_id',$client_id)->where('order_id',$order_id)->get('service_request_temp');
		  if($rs->num_rows()>0)
		  {
			$offrent_temp=$rs->result_array();
		  }
	   }
		
	 }
	 else
	 {
		 $rs=$this->db->select('*')->where('client_id',$client_id)->where('order_id',$order_id)->get('service_request_temp');
		  if($rs->num_rows()>0)
		  {
			$offrent_temp=$rs->result_array();
		  }
	 } 
	  
	  
	  return $offrent_temp;
	  
  }
  
  
  public function UpdateDataToTempOffrent($post_data)
  {
	 $error=false;
	 $errortext='';
	 $result='';
	 
	 $client_id=$this->Basic_model->unique_id;
	 $product_id=$post_data['product_id'];
	 $order_id=$post_data['order_id'];
	 $qty=$post_data['qty'];
	 $id=$post_data['temp_offrent_id'];
	 $post_end_date=date($this->Basic_model->mysql_dateformat, strtotime($post_data['end_date']));
	 
	 $offrent_qty='';
	 $order_qty='';
	 
	 
	 $rs=$this->db->select('*')->where('id',$id)->get('offrent_temp');
	 if(!$rs->num_rows()>0)
	 {
		 $error=true;
		 $errortext='Invalid offrent temp id';
	 }
	 
	 $rs=$this->db->select('*')->where('id',$id)->where('product_id',$product_id)->get('offrent_temp');
	 if(!$rs->num_rows()>0)
	 {
		 $error=true;
		 $errortext='Product id is not matching with off rent temp id';
	 }
	 
	 if(!$error)
	 {
		 $rs=$this->db->select('*')->where('order_id',$order_id)->get('order_details');
		 if(!$rs->num_rows()>0)
		 {
			$error=true;
			$errortext='Invalid order';
		 }
	 }
	 
	 if($this->Basic_model->role==4)
	 {
	   $customer_id=$this->Basic_model->sub_unique_id;
	   $rs=$this->db->select('*')->where('customer_id',$customer_id)->where('id',$order_id)->get('product_order');
	   if(!$rs->num_rows()>0)
	   {
		  $error=true;
		  $errortext='Invalid order';
	   }
		
	 }
	 
	 if(!$error)
	 {
		 $avl_qty=$this->GetAvailableOffrentQuantity($post_data);
		 if($avl_qty<$qty)
		 {
			 $error=true;
			 $errortext='Invalid quantity';
		 }
	 }
	 
	 if(!$error)
	 {
		 $rs=$this->db->select('*')->where('client_id',$client_id)->where('order_id',$order_id)->get('offrent_temp');
		 if(!$rs->num_rows()>0)
		 {
			 $error=true;
			 $errortext='Product not found';
		 }
	 }
	 
	 if(!$error)
	 {
		$rs=$this->db->select('*')->where('order_id',$order_id)->where('product_id',$product_id)->get('order_details');
		if($rs->num_rows()>0)
		{
			$order_array=$rs->row_array();
			$order_start_date=date($this->Basic_model->mysql_dateformat, strtotime($order_array['order_start_date']));
			
		}
		
		$start_date=date_create($order_start_date);
		$end_date=date_create($post_end_date);
		$diff=date_diff($start_date,$end_date);
		$day_difference=$diff->format("%R%a");
		if($day_difference[0]=="+")
		 {
			$day=$day_difference[1];
			if($day==0)
			{
				$error=true;
				$errortext='Order end date must be greater than order start date';
			}
		 }
		 else
		 {
			$error=true;
			$errortext='Order end date must be greater than order start date';
			
		 }
		
	 }
	 
	 
	 if(!$error)
	 {
		 $temp_offrent_array=array(
		   'qty'=>$qty,
		   'order_end_date'=>$this->Basic_model->mysql_db_format($post_data['end_date']),
		 );
		 
		 $success=$this->db->where('id',$id)->update('offrent_temp',$temp_offrent_array);
		 $result['successMessage']="Data successfully updated";
	 }
	 
	 return array('error' => $error, 'errortext' => $errortext, 'result' => $result); 
	  
  }
 
  public function DeleteDataToTempOffrent($post_data)
  {
	 $error=false;
	 $errortext='';
	 $result='';
	 
	 $id=$post_data['temp_offrent_id'];
	 $order_id=$post_data['order_id'];
	 $client_id=$this->Basic_model->unique_id;
	 
	 if(!$error)
	 {
		 $rs=$this->db->select('*')->where('order_id',$order_id)->get('order_details');
		 if(!$rs->num_rows()>0)
		 {
			$error=true;
			$errortext='Invalid order';
		 }
	 }
	 
	 if($this->Basic_model->role==4)
	 {
	   $customer_id=$this->Basic_model->sub_unique_id;
	   $rs=$this->db->select('*')->where('customer_id',$customer_id)->where('id',$order_id)->get('product_order');
	   if(!$rs->num_rows()>0)
	   {
		  $error=true;
		  $errortext='Invalid order';
	   }
		
	 }
	 
	 if(!$error)
	 {
		 $rs=$this->db->select('*')->where('client_id',$client_id)->where('order_id',$order_id)->where('id',$id)->get('offrent_temp');
		 if($rs->num_rows()>0)
		 {
		   $success=$rs=$this->db->where('id',$id)->delete('offrent_temp');;
		   $result['successMessage']="Data successfully deleted";
		 }
		 else
		 {
			 $error=true;
			 $errortext='Id not found';
		 }
	 }
	 return array('error' => $error, 'errortext' => $errortext, 'result' => $result); 
	  
  }
  
  
 public function DeleteDataToServiceRequest($post_data)
  {
	 $error=false;
	 $errortext='';
	 $result='';
	 
	 $id=$post_data['service_request_id'];
	 $order_id=$post_data['order_id'];
	 $client_id=$this->Basic_model->unique_id;
	 
	 if(!$error)
	 {
		 $rs=$this->db->select('*')->where('order_id',$order_id)->get('order_details');
		 if(!$rs->num_rows()>0)
		 {
			$error=true;
			$errortext='Invalid order';
		 }
	 }
	 
	 if($this->Basic_model->role==4)
	 {
	   $customer_id=$this->Basic_model->sub_unique_id;
	   $rs=$this->db->select('*')->where('customer_id',$customer_id)->where('id',$order_id)->get('product_order');
	   if(!$rs->num_rows()>0)
	   {
		  $error=true;
		  $errortext='Invalid order';
	   }
		
	 }
	 
	 if(!$error)
	 {
		 $rs=$this->db->select('*')->where('client_id',$client_id)->where('order_id',$order_id)->where('id',$id)->get('service_request_temp');
		 if($rs->num_rows()>0)
		 {
		   $success=$rs=$this->db->where('id',$id)->delete('service_request_temp');;
		   $result['successMessage']="Data successfully deleted";
		 }
		 else
		 {
		   $error=true;
		   $errortext='Id not found';
		 }
	 }
	 return array('error' => $error, 'errortext' => $errortext, 'result' => $result); 
	  
  }   
 
 //UpdateProductOrderDetails
 public function InsertInvoiceDetails($start_date,$end_date,$product_id,$qty,$order_id)
 {
	 $invoice_id=$this->Common_model->get_single_field_value('invoice','id','order_id',$order_id);
	 $rs=$this->db->select('*')->where('order_id',$order_id)->where('product_id',$product_id)->get('order_details');
	 if($rs->num_rows()>0)
	 {
		$order_array=$rs->row_array();
		$order_qty=$order_array['qty'];
		$order_price=$order_array['rate'];
	 }
	 
	 
	 $start_date=$this->Basic_model->mysql_db_format($start_date);
	 $end_date=$this->Basic_model->mysql_db_format($end_date);
	 $day_span=1+floor((abs(strtotime($start_date) - strtotime($end_date))/(60*60*24)));
	 
	 $product_price=$this->Sop_model->get_rent_product_price($day_span,$product_id);
	 $total_rate=($qty * $product_price);
	 $order_rate=(($order_qty-$qty)*$order_price);		
		
	  //echo '<pre>',print_r($update_data);
	  //die();
	  
	  $invoice_details_data = array(
		'invoice_id'=> $invoice_id,
		'product_id'=> $product_id,
		'order_id'=> $order_id,
		'start_date'=>$start_date,
		'end_date'=>$end_date,
		'qty'=> $qty,
		'unit_price'=> $product_price,
		'total_price'=> $total_rate,
	   );
 
      $success=$this->db->insert('invoice_details',$invoice_details_data);
	  
	  return $success;
 }  
  
 public function SubmitOffrent($post_data)
 {
	$error=false;
	$errortext='';
	$result='';
	
	
	$client_id=$this->Basic_model->unique_id;
	$order_id=$post_data['order_id'];
	$offrent_item=$post_data['offrent_item'];
	$customer_id=$this->Common_model->get_single_field_value('product_order','customer_id','id',$order_id);
	$offrent_note=$post_data['status_note'];
	$status_id=$post_data['status_id'];
	$order_start_date="";
		
	if(!$error)
	 {
		 $rs=$this->db->select('*')->where('order_id',$order_id)->get('order_details');
		 if(!$rs->num_rows()>0)
		 {
			$error=true;
			$errortext='Invalid order';
		 }
		 else
		 {
			 $od_array=$rs->row_array();
			 
		 }
	 }
	 
	 
	 
	 if(!$error)
	 {
		 if($this->Basic_model->role==4)
		 {
		   $customer_id=$this->Basic_model->sub_unique_id;
		   $rs=$this->db->select('*')->where('customer_id',$customer_id)->where('id',$order_id)->get('product_order');
		   if(!$rs->num_rows()>0)
		   {
			  $error=true;
			  $errortext='Invalid order';
		   }
			
		 }
	 }
	 
	if(!$error)
	{
		$sql="Select * from off_rent_status_master INNER JOIN  off_rent_status ON off_rent_status_master.id=off_rent_status.master_status_id  
		Where off_rent_status_master.client_id=$client_id AND off_rent_status.id=$status_id";
		$rs=$this->db->query($sql);
		if(!$rs->num_rows()>0)
		{
			$error=true;
			$errortext='Invalid status';
		}
	}
	
	$temp_offrent_array=array();
	$equipment_note=array();
	$check_flag=0;
	
	if(!$error)
	{
		$rs=$this->db->select('*')->where('client_id',$client_id)->where('order_id',$order_id)->get('offrent_temp');
		if($rs->num_rows()>0)
		{
			$temp_offrent_aray=$rs->result_array();
			
			foreach($temp_offrent_aray as $item)
			{
				$product_id=$item['product_id'];
				foreach($offrent_item as $row)
				{
					if($row['product_id']==$product_id)
					{
						$check_flag=0;
						$equipment_note[]=$row['note'];
						break;
					}
					else
					{
						$check_flag=1;
					}
					
				}
				
				if($check_flag==1)
				{
					$error=true;
					$errortext='Invalid product id';
				}
				
			}
			
		}
		else
		{
			$error=true;
			$errortext='No equipment selected for offrent';
		}
	}
	
	if(!$error)
	{
		
		//update order
		
		foreach($temp_offrent_aray as $item)
	    {
			$start_date=$item['order_start_date'];
			$end_date=$item['order_end_date'];
			$product_id=$item['product_id'];
			$qty=$item['qty'];
			
			$rs=$this->db->select('*')->where('order_id',$order_id)->where('product_id',$product_id)->get('order_details');
			if($rs->num_rows()>0)
			{
				$order_array=$rs->row_array();
				$order_end_date=$order_array['order_end_date'];
			}
			
			$this->InsertInvoiceDetails($start_date,$end_date,$product_id,$qty,$order_id);
			
			//$this->Sop_model->UpdateProductOrder($order_id);
			
	    }
			
		
		$offrent_array=array(
		  'client_id'=>$client_id,
		  'customer_id'=>$customer_id,
		  'order_id'=>$order_id,
		  'status_id'=>$status_id,
		  'status_note'=>$offrent_note,
		 );
        
		$success=$this->db->insert('off_rent',$offrent_array);
		$insert_id=$this->db->insert_id();	
		
		$i=0;
		foreach($temp_offrent_aray as $row)
		{
			
			$offrent_details_array=array(
			  'off_rent_id'=>$insert_id,
			  'product_id'=>$row['product_id'],
			  'qty'=>$row['qty'],
			  'note'=>$equipment_note[$i],
			 );
			
			$success=$this->db->insert('offrent_details',$offrent_details_array);
			$i++;
			
		}
		
		$response=$this->check_final_order_status($status_id,$insert_id,$order_id);
		if($response==1)
		{
			$order_arr=array(
			 'offrent_status'=>1
			);
			
			$rs=$this->db->where('id',$order_id)->update('product_order',$order_arr);
			
		}
		
		$rs=$this->db->where('client_id',$client_id)->where('order_id',$order_id)->delete('offrent_temp');
		$result['successMessage']='successfully submitted';
			 
	}
	return array('error' => $error, 'errortext' => $errortext, 'result' => $result);
	 
 }
 
 public function SubmitServiceRequest($post_data)
 {
	$error='';
	$errortext='';
	$result='';
	
	
	$client_id=$this->Basic_model->unique_id;
	$order_id=$post_data['order_id'];
	$service_request_item=$post_data['service_request_item'];
	$customer_id=$this->Common_model->get_single_field_value('product_order','customer_id','id',$order_id);
	$offrent_note=$post_data['status_note'];
	$status_id=$post_data['status_id'];
    
	if(!$error)
	 {
		 $rs=$this->db->select('*')->where('order_id',$order_id)->get('order_details');
		 if(!$rs->num_rows()>0)
		 {
			$error=true;
			$errortext='Invalid order';
		 }
	 }
	 
	 if($this->Basic_model->role==4)
	 {
	   $customer_id=$this->Basic_model->sub_unique_id;
	   $rs=$this->db->select('*')->where('customer_id',$customer_id)->where('id',$order_id)->get('product_order');
	   if(!$rs->num_rows()>0)
	   {
		  $error=true;
		  $errortext='Invalid order';
	   }
		
	 }
	
	if(!$error)
	{
		$sql="Select * from service_request_status_master INNER JOIN service_request_status ON service_request_status_master.id=service_request_status.master_status_id  
		Where service_request_status_master.client_id=$client_id AND service_request_status.id=$status_id";
		$rs=$this->db->query($sql);
		if(!$rs->num_rows()>0)
		{
			$error=true;
			$errortext='Invalid status';
		}
	}
	
	$temp_service_request_array=array();
	$equipment_note=array();
	$check_flag=0;
	$rs=$this->db->select('*')->where('client_id',$client_id)->where('order_id',$order_id)->get('service_request_temp');
	if($rs->num_rows()>0)
	{
		$temp_service_request_array=$rs->result_array();
		foreach($temp_service_request_array as $item)
		{
		    $product_id=$item['product_id'];
			foreach($service_request_item as $row)
			{
				if($row['product_id']==$product_id)
				{
					$check_flag=0;
					$equipment_note[]=$row['note'];
					break;
				}
				else
				{
					$check_flag=1;
				}
				
			}
			
			if($check_flag==1)
			{
				$error=true;
				$errortext='Invalid product id';
			}
			
		}
	
	}
	else
	{
		$error=true;
		$errortext='No equipment selected for service request';
	}
	
	if(!$error)
	{
		$service_request_array=array(
		  'client_id'=>$client_id,
		  'customer_id'=>$customer_id,
		  'order_id'=>$order_id,
		  'status_id'=>$status_id,
		  'status_note'=>$offrent_note,
		 );
        
		$success=$this->db->insert('service_request',$service_request_array);
		$insert_id=$this->db->insert_id();	
		
		$i=0;
		foreach($temp_service_request_array as $row)
		{
			
			$service_request_item_array=array(
			  'service_request_id'=>$insert_id,
			  'product_id'=>$row['product_id'],
			  'note'=>$equipment_note[$i],
			 );
			
			$success=$this->db->insert('service_request_item',$service_request_item_array);
			$i++;
			
		}
		$sql="SELECT * FROM service_equipment_image WHERE product_id=$product_id AND order_id=$order_id";
		$rs=$this->db->query($sql);
		if($rs->num_rows()>0)
		{
			$update_array=array('service_request_id'=>$insert_id);
			$rs=$this->db->where('product_id',$product_id)->where('order_id',$order_id)->update('service_equipment_image',$update_array);
		}
		
		
				
		$rs=$this->db->where('client_id',$client_id)->where('order_id',$order_id)->delete('service_request_temp');
		$result['successMessage']='successfully submitted';
			 
	}
	return array('error' => $error, 'errortext' => $errortext, 'result' => $result);
	 
 }
 
 
 public function check_final_order_status($status_id,$offrent_id,$order_id)
 {
	 $response=0;
	 $master_status_id=$this->Common_model->get_single_field_value('off_rent_status','master_status_id','id',$status_id);
	 $is_changeable=$this->Common_model->get_single_field_value('off_rent_status_master','is_changeable','id',$master_status_id);
	 //echo $this->db->last_query();
	 $client_id=$this->Basic_model->unique_id;
	 if($is_changeable==0)
	 {
		 $offrent_qty_count=0;
		 $sql="SELECT * FROM off_rent INNER JOIN offrent_details ON off_rent.id=offrent_details.off_rent_id WHERE 
		 off_rent.order_id=$order_id AND off_rent.client_id=$client_id";
		 $rs=$this->db->query($sql);
		 
		 if($rs->num_rows()>0)
		 {
			 $offrent_array=$rs->result_array();
			 foreach($offrent_array as $item)
			 {
				 $offrent_qty_count=$offrent_qty_count+$item['qty'];
			 }
		 }
		
		 $order_qty_count=0;
		 $rs=$this->db->select('*')->where('order_id',$order_id)->get('order_details');
		 if($rs->num_rows()>0)
		 {
			 $order_details_array=$rs->result_array();
			 foreach($order_details_array as $item)
			 {
				 $order_qty_count=$order_qty_count+$item['qty'];
			 }
		 }
		
		 if($offrent_qty_count==$order_qty_count)
		 {
			$response=1;
			
		 }

	 }
	 
	 return $response;
 }
  
  
  public function InsertDataOffrentDetails($post_data)
  {
	 $error=false;
	 $errortext='';
	 $result='';
	 
	 $client_id=$this->Basic_model->unique_id;
	 $product_id=$post_data['product_id'];
	 $order_id=$post_data['order_id'];
	 $qty=$post_data['qty'];
	 $offrent_id=$post_data['offrent_id'];
	 $offrent_qty='';
	 $order_qty='';
		
		
	$order_permisstion=$this->CompleteOrderOperation($order_id,$offrent_id);
	if($order_permisstion==1)
	{
		$error=true;
		$errortext='This is complete offrent request';
	}
	 
	 if(!$error)
	 {
		 $rs=$this->db->select('*')->where('order_id',$order_id)->get('order_details');
		 if(!$rs->num_rows()>0)
		 {
			$error=true;
			$errortext='Invalid order';
		 }
	 }
	 
	 if($this->Basic_model->role==4)
	 {
	   $customer_id=$this->Basic_model->sub_unique_id;
	   $rs=$this->db->select('*')->where('customer_id',$customer_id)->where('id',$order_id)->get('product_order');
	   if(!$rs->num_rows()>0)
	   {
		  $error=true;
		  $errortext='Invalid order';
	   }
		
	 }
	 
	 
	 
	 if(!$error)
	 {
		 $rs=$this->db->select('*')->where('off_rent_id',$offrent_id)->get('offrent_details');
		 if(!$rs->num_rows()>0)
		 {
			$error=true;
			$errortext='Invalid offrent id';
		 }
	 }
	 
	 if(!$error)
	 {
		 $avl_qty=$this->GetAvailableOffrentQuantity($post_data);
		 if($avl_qty<$qty)
		 {
			 $error=true;
			 $errortext='Invalid quantity';
		 }
	 }
	 
	
	
	 if(!$error)
	 {
		 $rs=$this->db->select('*')->where('off_rent_id',$offrent_id)->where('product_id',$product_id)->get('offrent_details');
		 if($rs->num_rows()>0)
		 {
			$error=true;
			$errortext='Product is already selected';
		 }
	 }
	 
	 if(!$error)
	 {
		 $offrent_array=array(
		   'off_rent_id'=>$offrent_id,
		   'product_id'=>$product_id,
		   'qty'=>$qty,
		 );
		 
		 $success=$this->db->insert('offrent_details',$offrent_array);
	 }
	 
	 return array('error' => $error, 'errortext' => $errortext, 'result' => $result); 
	  
  } 
  
  
   public function InsertDataServiceRequestDetails($post_data)
  {
	 $error=false;
	 $errortext='';
	 $result='';
	 
	 $client_id=$this->Basic_model->unique_id;
	 $product_id=$post_data['product_id'];
	 $order_id=$post_data['order_id'];
	 $service_request_id=$post_data['service_request_id'];
	 	 
	 if(!$error)
	 {
		 $rs=$this->db->select('*')->where('service_request_id',$service_request_id)->get('service_request_item');
		 if(!$rs->num_rows()>0)
		 {
			$error=true;
			$errortext='Invalid Service request id';
		 }
	 }
	 
	 
	 if(!$error)
	 {
		 $rs=$this->db->select('*')->where('service_request_id',$service_request_id)->where('product_id',$product_id)->get('service_request_item');
		 if($rs->num_rows()>0)
		 {
			$error=true;
			$errortext='Product is already selected';
		 }
	 }
	 
	 if(!$error)
	 {
		 $service_array=array(
		   'service_request_id'=>$offrent_id,
		   'product_id'=>$product_id,
		   'qty'=>$qty,
		 );
		 
		 $success=$this->db->insert('service_request_item',$service_array);
	 }
	 
	 return array('error' => $error, 'errortext' => $errortext, 'result' => $result); 
	  
  } 
  
  
  public function UpdateDataToOffrent($post_data)
  {
	 $error=false;
	 $errortext='';
	 $result='';
	 
	 $client_id=$this->Basic_model->unique_id;
	 $product_id=$post_data['product_id'];
	 $order_id=$post_data['order_id'];
	 $qty=$post_data['qty'];
	 $offrent_id=$post_data['offrent_id'];
	 
	 $offrent_qty='';
	 $order_qty='';
	 
	$order_permisstion=$this->CompleteOrderOperation($order_id,$offrent_id);
	if($order_permisstion==1)
	{
		$error=true;
		$errortext='This is complete offrent request';
	}
	
	if(!$error)
	 {
		 $rs=$this->db->select('*')->where('order_id',$order_id)->get('order_details');
		 if(!$rs->num_rows()>0)
		 {
			$error=true;
			$errortext='Invalid order';
		 }
	 }
	 
	 if($this->Basic_model->role==4)
	 {
	   $customer_id=$this->Basic_model->sub_unique_id;
	   $rs=$this->db->select('*')->where('customer_id',$customer_id)->where('id',$order_id)->get('product_order');
	   if(!$rs->num_rows()>0)
	   {
		  $error=true;
		  $errortext='Invalid order';
	   }
		
	 }
	 
	 if(!$error)
	 {
		 $avl_qty=$this->GetAvailableOffrentQuantity($post_data);
		 if($avl_qty<$qty)
		 {
			 $error=true;
			 $errortext='Invalid quantity';
		 }
	 }
	 if(!$error)
	 {
		 $rs=$this->db->select('*')->where('off_rent_id',$offrent_id)->get('offrent_details');
		 if(!$rs->num_rows()>0)
		 {
			$error=true;
			$errortext='Invalid offrent id';
		 }
	 }
	 
	
	 
	 if(!$error)
	 {
		 $temp_offrent_array=array(
		   'qty'=>$qty,
		 );
		 
		 $success=$this->db->where('off_rent_id',$offrent_id)->where('product_id',$product_id)->update('offrent_details',$temp_offrent_array);
	     $result['successMessage']='Data successsfully updated';
	 }
	 
	 return array('error' => $error, 'errortext' => $errortext, 'result' => $result); 
	  
  }
  
  public function DeleteFromOffrent($post_data)
  {
	 $error=false;
	 $errortext='';
	 $result='';
	 
	 $client_id=$this->Basic_model->unique_id;
	 $product_id=$post_data['product_id'];
	 $offrent_id=$post_data['offrent_id'];
	 $order_id=$this->Common_model->get_single_field_value('off_rent','order_id','id',$offrent_id);
	 
	 $offrent_qty='';
	 $order_qty='';
	 
	 if(!$error)
	 {
		 $rs=$this->db->select('*')->where('order_id',$order_id)->get('order_details');
		 if(!$rs->num_rows()>0)
		 {
			$error=true;
			$errortext='Invalid order';
		 }
	 }
	 
	 if($this->Basic_model->role==4)
	 {
	   $customer_id=$this->Basic_model->sub_unique_id;
	   $rs=$this->db->select('*')->where('customer_id',$customer_id)->where('id',$order_id)->get('product_order');
	   if(!$rs->num_rows()>0)
	   {
		  $error=true;
		  $errortext='Invalid order';
	   }
		
	 }
	 
	$order_permisstion=$this->CompleteOrderOperation($order_id,$offrent_id);
	if($order_permisstion==1)
	{
		$error=true;
		$errortext='This is complete offrent request';
	}
	 
	 $rs=$this->db->select('*')->where('off_rent_id',$offrent_id)->get('offrent_details');
	 if(!$rs->num_rows()>0)
	 {
		$error=true;
		$errortext='Invalid offrent id';
	 }
	 
	 if(!$error)
	 {
		 $success=$this->db->where('off_rent_id',$offrent_id)->where('product_id',$product_id)->delete('offrent_details');
	     $result['successMessage']='Data successsfully deleted';
	 }
	 
	 return array('error' => $error, 'errortext' => $errortext, 'result' => $result); 
	  
  }
  
  
  public function GetOffRentDetails($offrent_id)
  {
	 $GetOffRentDetails=array(); 
	 $rs=$this->db->select('*')->where('off_rent_id',$offrent_id)->get('offrent_details');
	 if($rs->num_rows()>0)
	 {
		$GetOffRentDetails=$rs->result_array();
	 }
	 
	 return $GetOffRentDetails;
	  
  }
  
   public function UpdateOffrent($post_data)
   {
	$error='';
	$errortext='';
	$result='';
	
	//print_r($post_data);
	//die();
	
	
	$client_id=$this->Basic_model->unique_id;
	$offrent_id=$post_data['offrent_id'];
	$offrent_item=$post_data['offrent_item'];
	$order_id=$post_data['order_id'];
	$customer_id=$this->Common_model->get_single_field_value('product_order','customer_id','id',$order_id);
	$offrent_note=$post_data['status_note'];
	$status_id=$post_data['status_id'];
    
	$rs=$this->db->select('*')->where('id',$offrent_id)->get('off_rent');
	if(!$rs->num_rows()>0)
	{
		$error=true;
		$errortext='Invalid offrent id';
	}
    
	if(!$error)
	 {
		 $rs=$this->db->select('*')->where('order_id',$order_id)->get('order_details');
		 if(!$rs->num_rows()>0)
		 {
			$error=true;
			$errortext='Invalid order';
		 }
	 }
	 
	 if($this->Basic_model->role==4)
	 {
	   $customer_id=$this->Basic_model->sub_unique_id;
	   $rs=$this->db->select('*')->where('customer_id',$customer_id)->where('id',$order_id)->get('product_order');
	   if(!$rs->num_rows()>0)
	   {
		  $error=true;
		  $errortext='Invalid order';
	   }
		
	 }

	if(!$error)
	{
		$order_permisstion=$this->CompleteOrderOperation($order_id,$offrent_id);
		if($order_permisstion==1)
		{
			$error=true;
			$errortext='This is complete offrent request';
		}
	}
	
	if(!$error)
	{
		$sql="Select * from off_rent_status_master INNER JOIN  off_rent_status ON off_rent_status_master.id=off_rent_status.master_status_id  
		Where off_rent_status_master.client_id=$client_id AND off_rent_status.id=$status_id";
		$rs=$this->db->query($sql);
		if(!$rs->num_rows()>0)
		{
			$error=true;
			$errortext='Invalid status';
		}
	}
	
	$temp_offrent_array=array();
	$equipment_note=array();
	$product_id=array();
	
	if(!$error)
	{
		$rs=$this->db->select('*')->where('off_rent_id',$offrent_id)->get('offrent_details');
		if($rs->num_rows()>0)
		{
			$temp_offrent_aray=$rs->result_array();
			foreach($temp_offrent_aray as $item)
			{
				$product_id=$item['product_id'];
				foreach($offrent_item as $row)
				{
					if($row['product_id']==$product_id)
					{
						$offrent_details_array=array(
						  'note'=>$row['note'],
						);
				
						$success=$this->db->where('off_rent_id',$offrent_id)->where('product_id',$row['product_id'])
						->update('offrent_details',$offrent_details_array);
						 break;
					}
					
				}
			}
		
		}
		else
		{
			$error=true;
			$errortext='Invalid offrent id';
		}
	}

	if(!$error)
	{
		$offrent_array=array(
		  'status_id'=>$status_id,
		  'status_note'=>$offrent_note,
		 );
        
		$success=$this->db->where('id',$offrent_id)->update('off_rent',$offrent_array);
		
		$response=$this->check_final_order_status($status_id,$offrent_id,$order_id);
		if($response==1)
		{
			$order_arr=array(
			 'offrent_status'=>1
			);
			
			$rs=$this->db->where('id',$order_id)->update('product_order',$order_arr);
			
		}
		$result['successMessage']='successfully submitted';
		
			 
	}
	return array('error' => $error, 'errortext' => $errortext, 'result' => $result);
	 
 }
 
   public function GetEquipmentImageList($post_data)
   {
		 $error=false;
		 $errortext='';
		 $result='';
		 
		 $image_list=array();
		 $client_id=$this->Basic_model->unique_id;
		 $product_id=$post_data['product_id'];
		 $order_id=$post_data['order_id'];
		 $service_request_id=$post_data['service_request_id'];
		 
		 $rs=$this->db->select('*')->where('id',$service_request_id)->get('service_request');
	     if(!$rs->num_rows()>0)
	     {
		   $error=true;
		   $errortext='Invalid Service request id';
	     }
		 
		 $rs=$this->db->select('*')->where('id',$product_id)->get('products');
	     if(!$rs->num_rows()>0)
	     {
		   $error=true;
		   $errortext='Invalid product id';
	     }
		 
		 if(!$error)
		 {
			 $rs=$this->db->select('*')->where('order_id',$order_id)->get('order_details');
			 if(!$rs->num_rows()>0)
			 {
				$error=true;
				$errortext='Invalid order';
			 }
		 }
	 
		 if($this->Basic_model->role==4)
		 {
		   $customer_id=$this->Basic_model->sub_unique_id;
		   $rs=$this->db->select('*')->where('customer_id',$customer_id)->where('id',$order_id)->get('product_order');
		   if(!$rs->num_rows()>0)
		   {
			  $error=true;
			  $errortext='Invalid order';
		   }
			
		 }
		 
		 
		 if(!$error)
		 {
		   $sql="SELECT * FROM service_equipment_image WHERE product_id=$product_id AND order_id=$order_id AND service_request_id=$service_request_id";
		   $rs=$this->db->query($sql);
		   if($rs->num_rows()>0)
		   {
			    $image_list_array=$rs->result_array();
				foreach($image_list_array as $item)
				{
					$image_name=$item['image_name'];
					$path = base_url("service_image/$image_name");
					if (@fopen($path, "r"))
					{
						$type = pathinfo($path, PATHINFO_EXTENSION);
						$data = file_get_contents($path);
						$base64 = 'data:image/' . $type . ';base64,' . base64_encode($data);
					}
				
					$image_list[]=array('id'=>$item['id'],'image'=>$base64);
				}
				
				$result['image_list']=$image_list;
		   }
		 }
		 
		 return array('error' => $error, 'errortext' => $errortext, 'result' => $result); 
	}
   
   
   public function DeleteEquipmentImage($post_data)
   {
		 $error=false;
		 $errortext='';
		 $result='';
		 
		 $image_list=array();
		 $client_id=$this->Basic_model->unique_id;
		 $equipment_image_id=$post_data['equipment_image_id'];
		 
		 
		 if(!$error)
		 {
		   $sql="SELECT * FROM service_equipment_image WHERE id=$equipment_image_id";
		   $rs=$this->db->query($sql);
		   if($rs->num_rows()>0)
		   {
			    $image_list=$rs->row_array();
				$post_data['order_id']=$image_list['order_id'];
				$post_data['product_id']=$image_list['product_id'];
				$post_data['service_request_id']=$image_list['service_request_id'];
				
				if(!$error)
				 {
					 $rs=$this->db->select('*')->where('order_id',$post_data['order_id'])->get('order_details');
					 if(!$rs->num_rows()>0)
					 {
						$error=true;
						$errortext='Invalid order';
					 }
				 }
				 
				 if($this->Basic_model->role==4)
				 {
				   $customer_id=$this->Basic_model->sub_unique_id;
				   $rs=$this->db->select('*')->where('customer_id',$customer_id)->where('id',$post_data['order_id'])->get('product_order');
				   if(!$rs->num_rows()>0)
				   {
					  $error=true;
					  $errortext='Invalid order';
				   }
					
				 }
				
				$order_permisstion=$this->CompleteServiceRequestOperation($post_data['order_id'],$post_data['service_request_id']);
				if($order_permisstion==1)
				 {
					$error=true;
					$errortext='This is complete service request';
				 }
				
				if(!$error)
				{
					$sql="DELETE FROM service_equipment_image WHERE id=$equipment_image_id";
					$rs=$this->db->query($sql);
					
					$result['successMessage']='Data successfully deleted';
					$result['image_list_data']=$post_data;
				}
		   }
		   else
		   {
			   $error=true;
		       $errortext='Id not found';
		   }
		 }
		 
		 return array('error' => $error, 'errortext' => $errortext, 'result' => $result); 
	}
	
	
   public function InsertEquipmentImage($post_data)
   {
		 $error=false;
		 $errortext='';
		 $result='';
		
		 $image_list=array();
		 $client_id=$this->Basic_model->unique_id;
		 $product_id=$post_data['product_id'];
		 $order_id=$post_data['order_id'];
		 $service_request_id=$post_data['service_request_id'];
		 $service_product_list=$this->ServiceProductList($post_data);
		 
		 $image_arr=array();
		 if(isset($post_data['image_name']))
		 {
		   $image_arr=$post_data['image_name'];
		 }
		 
		 
		 if(!$error)
		 {
			 $rs=$this->db->select('*')->where('order_id',$order_id)->get('order_details');
			 if(!$rs->num_rows()>0)
			 {
				$error=true;
				$errortext='Invalid order';
			 }
		 }
	 
		 if($this->Basic_model->role==4)
		 {
		   $customer_id=$this->Basic_model->sub_unique_id;
		   $rs=$this->db->select('*')->where('customer_id',$customer_id)->where('id',$order_id)->get('product_order');
		   if(!$rs->num_rows()>0)
		   {
			  $error=true;
			  $errortext='Invalid order';
		   }
			
		 }
		 
		 
		 if(!$error)
		 {
			 $rs=$this->db->select('*')->where('id',$service_request_id)->get('service_request');
			 if(!$rs->num_rows()>0)
			 {
			   $error=true;
			   $errortext='Invalid Service request id';
			 }
			 
			 $rs=$this->db->select('*')->where('id',$product_id)->get('products');
			 if(!$rs->num_rows()>0)
			 {
			   $error=true;
			   $errortext='Product id not found';
			 }
			 
			 $rs=$this->db->select('*')->where('id',$order_id)->get('product_order');
			 if(!$rs->num_rows()>0)
			 {
			   $error=true;
			   $errortext='Invalid order id';
			 }
		 }
		 
		$order_permisstion=$this->CompleteServiceRequestOperation($order_id,$service_request_id);
		if($order_permisstion==1)
		{
			$error=true;
			$errortext='This is complete service request';
		}
		
		 if(!$error)
		 {
			 $product_flag=false;
			 
			 foreach($service_product_list['result']['products'] as $item)
			 {
				 if($item['product_id']==$product_id)
				 { 
				     $product_flag=true;
					 break;
				 }
			 }
			 
			 if(!$product_flag)
			 {
				 $error=true;
			     $errortext='Invalid product id';
			 }
		 }
	
		 if(!$error)
		 {
		      if(!empty($image_arr))
			   {
				 foreach($image_arr as $item)
				 {
					 $service_image_array=array(
					   'product_id'=>$product_id,
					   'order_id'=>$order_id,
					   'service_request_id'=>$service_request_id,
					   'image_name'=>$item->image_name,
					 );
					 

					$success=$this->db->insert('service_equipment_image',$service_image_array); 
				 }
			   } 
			   
			   
			   if($success)
				 {
					 $result['successMessage']='Image successfully submitted';
				 }
				 else
				 {
					 $error=true;
					 $errortext='Error in insert';
				 }
		 }
		 
		 
		 return array('error' => $error, 'errortext' => $errortext, 'result' => $result); 
	}	
	
	
   public function InsertEquipmentToServiceRequest($post_data)
   {
		 $error=false;
		 $errortext='';
		 $result='';
		 
		 //print_r($post_data);
		 //die();
		
		 $image_list=array();
		 $client_id=$this->Basic_model->unique_id;
		 $product_id=$post_data['product_id'];
		 $order_id=$post_data['order_id'];
		 $service_request_id=$post_data['service_request_id'];
		 $service_product_list=$this->ServiceProductList($post_data);
		 
		 $image_arr=array();
		 if(isset($post_data['image']))
		 {
			$image_arr=$post_data['image'];
		 }
		 
		 
		$order_permisstion=$this->CompleteServiceRequestOperation($order_id,$service_request_id);
		if($order_permisstion==1)
		{
			$error=true;
			$errortext='This is complete service request';
		}
		
        if(!$error)
		 {
			 $rs=$this->db->select('*')->where('order_id',$order_id)->get('order_details');
			 if(!$rs->num_rows()>0)
			 {
				$error=true;
				$errortext='Invalid order';
			 }
		 }
		 
		 if($this->Basic_model->role==4)
		 {
		   $customer_id=$this->Basic_model->sub_unique_id;
		   $rs=$this->db->select('*')->where('customer_id',$customer_id)->where('id',$order_id)->get('product_order');
		   if(!$rs->num_rows()>0)
		   {
			  $error=true;
			  $errortext='Invalid order';
		   }
			
		 } 		
		 
		 if(!$error)
		 {
			 if(!empty($image_arr))
			 {
				 foreach($image_arr as $item)
				 {
					 if (preg_match('`^[a-zA-Z0-9+/]+={0,2}$`', $item->encode_image))
					 {
						 $error=true;
						 $errortext='Invalid base64 format';
						 break;
					 }
					
				 }
			 }
		 }
		 if(!$error)
		 {
			 $rs=$this->db->select('*')->where('id',$service_request_id)->where('order_id',$order_id)->get('service_request');
			 if(!$rs->num_rows()>0)
			 {
			   $error=true;
			   $errortext='Invalid Service request id';
			 }
			 
			
			 $rs=$this->db->select('*')->where('id',$order_id)->get('product_order');
			 if(!$rs->num_rows()>0)
			 {
			   $error=true;
			   $errortext='Invalid order id';
			 }
		 }
		 
		 if(!$error)
		 {
			 $product_flag=false;
			
			 //print_r($service_product_list['result']['products']);
			 foreach($service_product_list['result']['products'] as $item)
			 {
				 if($item['product_id']==$product_id)
				 { 
				     $product_flag=true;
					 break;
				 }
			 }
			 
			
			 if(!$product_flag)
			 {
				 $error=true;
			     $errortext='Invalid product id';
			 }
		 }
		 
		
		 if(!$error)
		 {
			 $rs=$this->db->select('*')->where('product_id',$product_id)->where('service_request_id',$service_request_id)->get('service_request_item');
			 if($rs->num_rows()>0)
			 {
			   $error=true;
			   $errortext='This product is already exist';
			 }
		 }

		 if(!$error)
		 {
			 
			 $service_item_array=array(
			  'service_request_id'=>$service_request_id,
			  'product_id'=>$product_id
			 );
			 $success=$this->db->insert('service_request_item',$service_item_array);
			 
			 
		      if(!empty($image_arr))
			   {
				 foreach($image_arr as $item)
				 {
					 $image_encodeing = explode('base64,', $item->encode_image);
					 $base64Image=$image_encodeing[1];
					 $temp_file_path="./service_image/";
					 $get_image_name=$this->upload_image($base64Image,$temp_file_path);
					 $service_image_array=array(
					   'product_id'=>$product_id,
					   'order_id'=>$order_id,
					   'service_request_id'=>$service_request_id,
					   'image_name'=>$get_image_name,
					 );
					 
					$success=$this->db->insert('service_equipment_image',$service_image_array); 
				 }
			   } 
			   
			   if($success)
				 {
					 $result['successMessage']='Equipment successfully submitted';
				 }
				 else
				 {
					 $error=true;
					 $errortext='Error in insert';
				 }
		 }
		 
		 
		 return array('error' => $error, 'errortext' => $errortext, 'result' => $result); 
	}
	
	
  public function DeleteFromServiceRequest($post_data)
  {
	 $error=false;
	 $errortext='';
	 $result='';
	 
	 $client_id=$this->Basic_model->unique_id;
	 $product_id=$post_data['product_id'];
	 $service_request_id=$post_data['service_request_id'];
	 $order_id=$this->Common_model->get_single_field_value('service_request','id','order_id',$service_request_id);
	 $offrent_qty='';
	 $order_qty='';
	 
	 $rs=$this->db->select('*')->where('service_request_id',$service_request_id)->get('service_request_item');
	 if(!$rs->num_rows()>0)
	 {
		$error=true;
		$errortext='Invalid Service request id';
	 }
	 
	$order_permisstion=$this->CompleteServiceRequestOperation($order_id,$service_request_id);
	if($order_permisstion==1)
	{
		$error=true;
		$errortext='This is complete service request';
	}
	
	if(!$error)
	 {
		 $rs=$this->db->select('*')->where('order_id',$order_id)->get('order_details');
		 if(!$rs->num_rows()>0)
		 {
			$error=true;
			$errortext='Invalid order';
		 }
	 }
	 
	 if($this->Basic_model->role==4)
	 {
	   $customer_id=$this->Basic_model->sub_unique_id;
	   $rs=$this->db->select('*')->where('customer_id',$customer_id)->where('id',$order_id)->get('product_order');
	   if(!$rs->num_rows()>0)
	   {
		  $error=true;
		  $errortext='Invalid order';
	   }
		
	 }
	 
	 if(!$error)
	 {
		 $success=$this->db->where('service_request_id',$service_request_id)->where('product_id',$product_id)->delete('service_request_item');
		 $success=$this->db->where('service_request_id',$service_request_id)->where('product_id',$product_id)->delete('service_equipment_image');
	     $result['successMessage']='Data successsfully deleted';
	 }
	 
	 return array('error' => $error, 'errortext' => $errortext, 'result' => $result); 
	  
  }
  
   public function UpdateServiceRequest($post_data)
   {
	$error='';
	$errortext='';
	$result='';
	
	//print_r($post_data);
	//die();
	
	
	$client_id=$this->Basic_model->unique_id;
	$service_request_id=$post_data['service_request_id'];
	$service_request_item=$post_data['service_request_item'];
	$order_id=$post_data['order_id'];
	$customer_id=$this->Common_model->get_single_field_value('product_order','customer_id','id',$order_id);;
	$status_note=$post_data['status_note'];
	$status_id=$post_data['status_id'];
    
	
	$order_permisstion=$this->CompleteServiceRequestOperation($order_id,$service_request_id);
	if($order_permisstion==1)
	{
		$error=true;
		$errortext='This is complete service request';
	}
	
	if(!$error)
	 {
		 $rs=$this->db->select('*')->where('order_id',$order_id)->get('order_details');
		 if(!$rs->num_rows()>0)
		 {
			$error=true;
			$errortext='Invalid order';
		 }
	 }
	 
	 if($this->Basic_model->role==4)
	 {
	   $customer_id=$this->Basic_model->sub_unique_id;
	   $rs=$this->db->select('*')->where('customer_id',$customer_id)->where('id',$order_id)->get('product_order');
	   if(!$rs->num_rows()>0)
	   {
		  $error=true;
		  $errortext='Invalid order';
	   }
		
	 }
	
	if(!$error)
	{
	   $rs=$this->db->select('*')->where('id',$service_request_id)->where('order_id',$order_id)->get('service_request');
	   if(!$rs->num_rows()>0)
	   {
          $error=true;
		  $errortext='Invalid service request id';
	   }
	}
	
	if(!$error)
	{
		$sql="Select * from service_request_status_master INNER JOIN  service_request_status ON service_request_status_master.id=service_request_status.master_status_id  
		Where service_request_status_master.client_id=$client_id AND service_request_status.id=$status_id";
		$rs=$this->db->query($sql);
		if(!$rs->num_rows()>0)
		{
			$error=true;
			$errortext='Invalid status';
		}
	}
	
	$temp_offrent_array=array();
	$equipment_note=array();
	$product_id=array();
	$rs=$this->db->select('*')->where('service_request_id',$service_request_id)->get('service_request_item');
	if($rs->num_rows()>0)
	{
		$temp_offrent_aray=$rs->result_array();
		foreach($temp_offrent_aray as $item)
		{
			$product_id=$item['product_id'];
			foreach($service_request_item as $row)
			{
				if($row['product_id']==$product_id)
				{
					$offrent_details_array=array(
					  'note'=>$row['note'],
				    );
			
					$success=$this->db->where('service_request_id',$service_request_id)->where('product_id',$row['product_id'])
					->update('service_request_item',$offrent_details_array);
					 break;
				}
				
			}
		}
	
	}
	else
	{
		$error=true;
		$errortext='Invalid service request id';
	}

	if(!$error)
	{
		$offrent_array=array(
		  'status_id'=>$status_id,
		  'status_note'=>$status_note,
		 );
        
		$success=$this->db->where('id',$service_request_id)->update('service_request',$offrent_array);
		
		$result['successMessage']='successfully submitted';
		
			 
	}
	return array('error' => $error, 'errortext' => $errortext, 'result' => $result);
	 
 }	 	
   
}
?>